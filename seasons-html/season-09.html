<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<title>Season Nine</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Django e-booklet">
<meta name="keywords" content="django, django learning">
<meta name="author" content="Mahdi Rezaie, Ali Ebrahimian">
<link rel="icon" href="../Images/favicon.ico" type="image/ico">

<link rel="stylesheet" type="text/css" href="../seasons-css-&-js/seasons-style.css">
<link rel="stylesheet" type="text/css" href="../seasons-css-&-js/Footer-style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<main>
    <div class="container">
        <div class="content">
            <h2>فصل نهم: اپلیکیشن شبکه اجتماعی (بخش دوم)</h2><div class="toc"><h3>فهرست مطالب</h3><ul>
<li><a href="#lykh-pst-h-b-ajax-w-rbth-m2m">لایک پست ها با AJAX و رابطه M2M</a></li>
<li><a href="#br-gdhry-byshtr-pst-h-b-ajax-sfhh-bndy">بار‌گذاری بیشتر پست ها با AJAX (صفحه بندی)</a></li>
<li><a href="#dhkhyrh-pst-h-b-ajax">ذخیره پست ها با AJAX</a></li>
<li><a href="#yjd-mdl-wst-bry-fyld-m2m">ایجاد مدل واسط برای فیلد M2M</a></li>
<li><a href="#khr-b-thumbnail-nmysh-tswyr-prwfyl">کار با thumbnail (نمایش تصویر پروفایل)</a></li>
<li><a href="#nmysh-lyst-khrbr-h">نمایش لیست کاربر ها</a></li>
<li><a href="#nmysh-jzyyt-khrbr">نمایش جزئیات کاربر</a></li>
<li><a href="#pydh-szy-flw-w-nflw-b-ajax">پیاده سازی فالو و آنفالو با AJAX</a></li>
<li><a href="#bhynh-szy-khwyry-select-related-w-prefetch-related">بهینه سازی کوئری (select_related و prefetch_related)</a></li>
<li><a href="#khr-b-sygnl-h-mhsbh-mjmw-lykh">کار با سیگنال ها (محاسبه مجموع لایک)</a></li>
<li><a href="#khr-b-sygnl-h-rsl-ymyl-hdhf-pst">کار با سیگنال ها (ارسال ایمیل حذف پست)</a></li>
<li><a href="#khr-b-message-jngw">کار با message جنگو</a></li>
<li><a href="#khr-b-debug-toolbar-jngw">کار با debug toolbar جنگو</a></li>
<li><a href="#yjd-khshn-action-dr-pnl-dmyn">ایجاد اکشن (action) در پنل ادمین</a></li>
<li><a href="#tmrynt-fsl-nhm-mhm">تمرینات فصل نهم (مهم)</a></li>
<li><a href="#nkht-dfy">نکات اضافی</a></li>
<li><a href="#wyjgy-hy-jdyd-bry-prwjh">ویژگی های جدید برای پروژه</a></li>
</ul></div>
<h3 id="lykh-pst-h-b-ajax-w-rbth-m2m">لایک پست ها با AJAX و رابطه M2M</h3>
<p>رابطه Many To Many یا چند به چند حالتی است که دو مدل متصل به هم به صورت چندتایی باهم ارتباط دارند.</p>
<p>برای مثال یک کاربر میتواند چندین پست را لایک کند؛ از طرفی هر پست میتواند توسط تعداد زیادی کاربر لایک شود بنابراین رابطه بین post و user برای فیلد لایک ها از نوع m2m میباشد.</p>
<blockquote>
<p>در رابطه m2m  فرقی نمیکند که فیلد را در کدام مدل ایجاد کنیم؛ چون هردو مدل چندتایی هستند، با توجه به کاربرد میتوان در هر یک از مدل ها فیلد را ایجاد کرد.</p>
</blockquote>
<p>در مدل Post یک فیلد برای لایک ها ایجاد میکنیم.</p>
<blockquote>
<p>در این فیلد؛ کاربرانی که پست را لایک میکنند قرار میگیرند.</p>
</blockquote>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.managers</span> <span class="kn">import</span> <span class="n">TaggableManager</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_posts&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="c1"># date</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># tags field</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">TaggableManager</span><span class="p">()</span>

    <span class="c1"># likes field</span>
    <span class="n">likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;liked_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># ordering &amp; indexing</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-total_likes&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
</pre></div>

<blockquote>
<p>دستورات makemigrations و migrate فراموش نشه!</p>
</blockquote>
<p>وقتی برای یک فیلد از رابطه m2m استفاده میکنیم، جنگو در پشت صحنه یک جدول میانجی ایجاد میکند، و primary key یا id هر کدام از آن مدل ها را در آن جدول قرار میدهد.</p>
<blockquote>
<p>فرض کنیم متغیر post یک پست انتخابی و متغیر user یکی از کاربران وبسایت میباشد.</p>
<blockquote>
<p><span class="en-text">post.likes.all()</span></p>
</blockquote>
<p>کد بالا؛ <strong>کاربرانی</strong> که این پست را لایک کرده اند برمیگرداند.</p>
<blockquote>
<p><span class="en-text">user.liked_posts.all()</span></p>
</blockquote>
<p>این کد؛ <strong>پست هایی</strong> که این کاربر لایک کرده است را برمیگرداند.</p>
</blockquote>
<p>فیلدهای m2m برای ما یک manager فراهم میکنند که میتوانیم از متدهایی مثله <span class="en-text">all()</span> استفاده کرده تا تمام آبجکت ها را بدست بیاوریم. / البته متدهای دیگری مثله <span class="en-text">add()</span> , <span class="en-text">remove()</span> نیز دارد.</p>
<blockquote>
<p><strong>ajax</strong> مخفف: Asynchronous JavaScript and XML میباشد.</p>
<p>کاربرد ajax jquery: در برخی جاها لازم داریم که فقط بخشی از صفحه را reload کنیم؛ مثلا در تغییر تعداد لایک ها، تغییر تعداد محصولات در سبد خرید(با کلیک روی دکمه افزودن به سبد خرید).</p>
<p>در این موارد ajax کمک میکند تا فقط همان بخش از صفحه reload شود نه کل صفحه!</p>
</blockquote>
<p><strong>ایجاد URL برای لایک کردن:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;like-post/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">like_post</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;like_post&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<blockquote>
<p><strong>نکته اضافه:</strong> با استفاده از url، فرم ها در تمپلیت و ajax میتوانیم، اطلاعاتی را به view ارسال کنیم.</p>
</blockquote>
<p><strong>ایجاد view برای لایک کردن:</strong></p>
<p>برای view لایک پست ها، از چند دکوراتور استفاده میکنیم:</p>
<blockquote>
<p>login_required: برای لایک کردن پست ها کاربر را الزام به لاگین میکند.</p>
<p>login_required: این دکوراتور مشخص میکند که این view فقط با متد post کار میکند و نمیتواند متد get داشته باشد.</p>
</blockquote>
<p>این دکوراتورها باید ایمپورت شوند.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>


<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="k">def</span> <span class="nf">like_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">post_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_id&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">post_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">liked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">liked</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">post_likes_count</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;liked&#39;</span><span class="p">:</span> <span class="n">liked</span><span class="p">,</span>
            <span class="s1">&#39;likes_count&#39;</span><span class="p">:</span> <span class="n">post_likes_count</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid post_id&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p><strong>نکته مهم:</strong> این view زمانی اجرا میشود که کاربر روی <strong>دکمه لایک❤️</strong>، کلیک کند.</p>
<p>همان طور که در نکته اضافه گفته شد، از طریق ajax میتوان داده هایی را به view ارسال کرد؛ و چون view را ملزم به متد POST کرده ایم با استفاده از <strong>request.POST</strong> داده ها را دریافت میکنیم.</p>
<p>1- با استفاده از دستور request.POST آیدی پست(post_id) را که از تمپلیت ارسال شده، دریافت کرده و در متغیر post_id ذخیره میکنیم.</p>
<p>2- حالا یک شرط مشخص میکنیم که اگر post_id وجود داشت؛ با استفاده از آن id، پست مربوطه را از دیتابیس دریافت کن و آنرا در یک متغیر ذخیره کن. / کاربر فعلی را هم در یک متغیر ذخیره میکنیم.</p>
<blockquote>
<blockquote>
<p><span class="en-text">post.likes.all()</span></p>
</blockquote>
<p>کد بالا؛ <strong>کاربرانی</strong> که این پست را لایک کرده اند برمیگرداند. / لیستی از کاربرانی که این پست را لایک کرده اند.</p>
</blockquote>
<p>3- حالا اگر کاربر فعلی جزء این لیست باشد؛ یعنی قبلا پست را لایک کرده و الآن قصد دارد آنرا unlike کند، بنابراین کاربر را با استفاده از متد <span class="en-text">remove()</span> از آن لیست حذف میکنیم.</p>
<ul>
<li>یک متغیر بنام liked ایجاد کرده و مقدار آنرا False مشخص میکنیم. / به این معنی که که کاربر ، پست را unlike کرده است؛ بنابراین از آن در تمپلیت استفاده میکنیم تا وضعیت دکمه لایک را تغییر دهیم.</li>
</ul>
<p>4- حالا اگر کاربر جزء آن لیست نبود یعنی قصد دارد پست را لایک کند؛ بنابراین با متد <span class="en-text">add()</span> وی را به لیست کاربران لایک کرده، اضافه میکنیم.</p>
<ul>
<li>حالا این بار مقدار متغیر liked را True مشخص میکنیم.</li>
</ul>
<p>5- یک متغیر بنام post_likes_count ایجاد کرده و تعداد کاربرانی که پست را لایک کرده در آن ذخیره میکنیم. / تعداد لایک ها را نشان میدهد.</p>
<p>6- متغیر liked و post_likes_count را به صورت دیکشنری(json) در متغیر response_data ذخیره میکنیم تا آنها را به عنوان json به تمپلیت ارسال کنیم.</p>
<p>7- چنانچه post_id وجود نداشته باشد یک ارور نمایش میدهیم.</p>
<p>در view های قبلی برای تمپلیت؛ یا یک صفحه ای را رندر میکردیم و داده هایی را به آن ارسال میکردیم یا عبارتی را با HttpResponse در تمپلیت نمایش میدادیم ولی حالا میخواهیم json ارسال کنیم، بنابراین از JsonResponse استفاده میکنیم.</p>
<p>8- برای ارسال json به تمپلیت، از JsonResponse استفاده کرده و عبارت json را به عنوان آرگومان برایش مشخص میکنیم. / لازم است آنرا ایمپورت کنیم.</p>
<p><strong>بریم سراغ تمپلیت:</strong></p>
<p>لایک ها در تمپلیت post_detail نمایش داده میشوند بنابراین لازم است تغییراتی در آن ایجاد کنیم.</p>
<blockquote>
<p><strong>نکته:</strong> با استفاده از اتریبیوت data-name برای هر تگ در html، میتوان داده هایی را ارسال کنیم.</p>
<blockquote>
<p><span class="en-text">&lt;div class="post" data-post-id="{{ post.id }}"&gt;&lt;/div&gt;</span></p>
</blockquote>
</blockquote>
<p><code>templates/social/post_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;div class=&quot;post&quot; data-post-id=&quot;</span><span class="cp">{{</span> <span class="nv">post.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>

<span class="x">    &lt;button class=&quot;like-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.likes.all</span> <span class="cp">%}</span>
<span class="x">            UnLike</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Like</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">    &lt;br&gt;</span>

<span class="x">    &lt;span class=&quot;likes-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.likes.count</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; Likes</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;br&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Similar Posts&lt;/h2&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">similar_posts</span> <span class="cp">%}</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">10</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">    There are no similar posts!</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- یک تگ div با کلاس post ایجاد کرده و برایش اتریبیوت <strong>data-post-id</strong> با مقدار <strong>post.id</strong> را مشخص میکنیم. / تا بتوانیم آیدی پست را به کمک ajax به view ارسال کنیم.</p>
<ul>
<li>
<p>محتوای پست (description و create-date) را در این div قرار میدهیم.</p>
</li>
<li>
<p>داخل این div یک دکمه برای لایک کردن ایجاد میکنیم.</p>
</li>
</ul>
<p>2- اولین بار که صفحه لود میشود، هنوز view فراخوانی نشده است(چون روی دکمه لایک کلیک نشده) باید وضعیت فعلی دکمه را متوجه شویم بنابراین باید بفهمیم که user قبلا پست را لایک کرده یا نه!</p>
<blockquote>
<p>اگر لایک کرده پس دکمه لایک باید UnLike را نشان دهد.</p>
<p>و اگر هنوز لایک نکرده باید Like نشان داده شود.</p>
</blockquote>
<p><strong>حالا چطور بفهمیم؟!</strong></p>
<p>داخل بدنه تگ button، یک شرط مشابه با شرطی که در view ها نوشتیم  اینجا هم استفاده میکنیم. / شرطی که بررسی میکند کاربر قبلا، پست را لایک کرده یا نه!!!</p>
<p>3- از یک تگ span هم برای نمایش تعداد لایک ها استفاده میکنیم.</p>
<p><strong>خب بریم سراغ ساختار ajax:</strong></p>
<p><strong>نکته مهم:</strong> برای اینکه کد ajax که مینویسیم کار کند؛ لازم است اسکریپت ajax jquery را به تمپلیت خود اضافه کنیم. / در غیر این صورت کد ajax کار نخواهد کرد.</p>
<blockquote>
<p>در مرورگر خود عبارت cdnjquery را سرچ کرده و از سایت cdnjs اسکریپت اول را کپی کرده و به انتهای تمپلیت اضافه کنید. / <a href="https://cdnjs.com/libraries/jquery">ajax-jquery</a></p>
</blockquote>
<p><strong>حالا یک تگ script ایجاد کرده و کد ajax را داخل آن مینویسیم:</strong></p>
<p><code>templates/social/post_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;div class=&quot;post&quot; data-post-id=&quot;</span><span class="cp">{{</span> <span class="nv">post.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>

<span class="x">    &lt;button class=&quot;like-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.likes.all</span> <span class="cp">%}</span>
<span class="x">            UnLike</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Like</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">    &lt;br&gt;</span>

<span class="x">    &lt;span class=&quot;likes-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.likes.count</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; Likes</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;br&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Similar Posts&lt;/h2&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">similar_posts</span> <span class="cp">%}</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">10</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">    There are no similar posts!</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;!-- ---------------- ajax structure ---------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function (){</span>
<span class="x">        $(&#39;.like-button&#39;).click(function (){</span>
<span class="x">            let post_id = $(this).closest(&#39;.post&#39;).data(&#39;post-id&#39;);</span>
<span class="x">            let button = $(this);</span>
<span class="x">            </span>
<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:like_post&#39;</span> <span class="cp">%}</span><span class="x">&quot;,</span>
<span class="x">                data: {&#39;post_id&#39;: post_id, &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.liked){</span>
<span class="x">                        button.text(&#39;UnLike&#39;);</span>
<span class="x">                    }else{</span>
<span class="x">                        button.text(&#39; Like&#39;);</span>
<span class="x">                    }</span>
<span class="x">                    $(&#39;.likes-count&#39;).text(response.likes_count);</span>
<span class="x">                },</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    })</span>
<span class="x">    </span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>علامت $ مربوط به ساختار jquery میباشد.</p>
<p>1- با استفاده از <span class="en-text">$(document)</span> می‌توانید به عناصر HTML دسترسی پیدا کنید و عملیات مختلفی روی آن‌ها انجام دهید.</p>
<p>2- تابع ready در jquery یک event هست که برای اعلام آماده بودن صفحه و  اینکه مشخص کند صفحه به طور کامل بارگذاری شده استفاده میشود.</p>
<blockquote>
<blockquote>
<p><span class="en-text">$('.class_name')</span> =&gt; <span class="en-text">$('.post')</span></p>
<p><span class="en-text">$('#id_name')</span> =&gt; <span class="en-text">$("#test-text")</span></p>
<p><span class="en-text">$('element_name')</span> =&gt; <span class="en-text">$("p")</span></p>
</blockquote>
<p>در jquery با استفاده از ساختاری مثله  نمونه کدهای بالا یک عنصر(تگ) را با استفاده از کلاس ، آیدی و یا اسم آن تگ انتخاب کرده تا عملیاتی روی آن انجام دهیم.</p>
</blockquote>
<p>3- تگ button را با استفاده از کلاس آن انتخاب کرده؛ و مشخص میکنیم وقتی روی آن کلیک شد یکسری اتفاقات صورت بگیرد.</p>
<ul>
<li>
<p>چون داخل function مربوط به button هستیم، <span class="en-text">$(this)</span> به button اشاره میکند.</p>
</li>
<li>
<p>با متد closest نزدیک ترین عنصر به تگ button را که کلاس post دارد انتخاب میکنیم؛ حالا مقداری که در اتریبیوت <strong>data</strong> با اسم <strong>post-id</strong> ذخیره شده را دریافت میکنیم، و آنرا در متغیری بنام post_id ذخیره میکنیم.</p>
</li>
</ul>
<p><strong>4- بریم سراغ ajax:</strong></p>
<p>4-1 <strong><em>type:</em></strong> نوع متد برای ارسال داده ها را مشخص میکنیم.</p>
<p>4-2 <strong><em>url:</em></strong> آدرسی که قرار است اطلاعات به view آن ارسال شوند را مشخص میکنیم.</p>
<p>4-3 <strong><em>data:</em></strong> اطلاعاتی که قرار است به view ارسال شوند در data مشخص میشوند. / در اینجا post_id ارسال میشود.</p>
<ul>
<li>چون مشخص کردیم که متد post هست باید csrf_token را هم ارسال کنیم.</li>
</ul>
<p>4-4 <strong><em>success:</em></strong> تابع success یک callback است که زمانی که درخواست ajax با موفقیت انجام می‌شود، فراخوانی می‌شود. این تابع داده‌های دریافتی از سمت سرور(view) را به عنوان ورودی دریافت می‌کند و شما می‌توانید این داده‌ها را در بدنه تابع پردازش کنید.</p>
<ul>
<li>داخل بدنه تابع success، کارهایی که پس از کلیک روی دکمه لایک باید صورت بگیرند را مشخص میکینیم. / تغییر وضعیت نوشته روی دکمه لایک و یا رنگ آیکون قلب.</li>
</ul>
<blockquote>
<p>در اینجا post_id را با استفاده از اتریبیوت data دریافت کردیم ولی نیازی به آن نبود و میتوانستیم مستقیما آنرا در ajax مشخص کنیم.    </p>
<p><strong>خلاصه ای از توضیحات بالا و تابع error:</strong></p>
<p>url آدرس URL‌ای است که درخواست به آن ارسال می‌شود.</p>
<p>type نوع درخواست (GET, POST و غیره) را مشخص می‌کند.</p>
<p>data داده‌هایی است که به سرور ارسال می‌شود.</p>
<p>success تابعی است که در صورت موفقیت‌آمیز بودن درخواست فراخوانی می‌شود. داده‌های پاسخ از سرور به عنوان آرگومان response به این تابع ارسال می‌شوند و شما می‌توانید این داده‌ها را در داخل تابع پردازش کنید.</p>
<p>error تابعی است که در صورت بروز خطا در درخواست فراخوانی می‌شود.</p>
</blockquote>
<p>5- تگ span که تعداد لایک ها را نشان میدهد، را با مقدار (likes_count) که از view دریافت کرده ایم آپدیت میکنیم.</p>
<h3 id="br-gdhry-byshtr-pst-h-b-ajax-sfhh-bndy">بار‌گذاری بیشتر پست ها با AJAX (صفحه بندی)</h3>
<p>میخواهیم به کمک ajax با استفاده از دکمه نمایش بیشتر پست ها را نمایش دهیم.</p>
<p><strong>ساختار صفحه بندی را برای لیست پست ها پیاده سازی میکنیم:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.models</span> <span class="kn">import</span> <span class="n">Tag</span>
<span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span><span class="p">,</span> <span class="n">EmptyPage</span><span class="p">,</span> <span class="n">PageNotAnInteger</span>


<span class="k">def</span> <span class="nf">post_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tag_slug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tag_slug</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">tag_slug</span><span class="p">)</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

    <span class="c1"># صفحه بندی برای پست ها</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PageNotAnInteger</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EmptyPage</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-requested-with&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/list_ajax.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="n">posts</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/post_list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;posts&#39;</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="p">})</span>
</pre></div>

<blockquote>
<p>برای EmptyPage این بار یک لیست خالی قرار میدهیم، تا به کاربر اعلام کنیم دیگر پستی جهت نمایش وجود ندارد.</p>
</blockquote>
<p>وقتی روی دکمه <strong>نمایش بیشتر</strong> کلیک کنیم کد ajax فراخوانی میشه؛ حالا برای اینکه در view متوجه شویم request ما ajax هست یا نه! از یک شرط استفاده میکنیم.</p>
<p><strong>توضیحات:</strong></p>
<blockquote>
<p><span class="en-text">request.headers.get('x-requested-with'):</span></p>
</blockquote>
<p>این خط بررسی می‌کند که آیا درخواست ارسال شده یک درخواست Ajax است یا نه. در درخواست‌های Ajax، مرورگر به صورت خودکار هدر x-requested-with را با مقدار XMLHttpRequest تنظیم می‌کند. بنابراین، با بررسی این هدر، می‌توان متوجه شد که آیا درخواست از طریق Ajax ارسال شده است یا خیر.</p>
<blockquote>
<p><span class="en-text">if request.headers.get('x-requested-with') == 'XMLHttpRequest':</span></p>
</blockquote>
<p>این شرط بررسی می‌کند که اگر مقدار هدر x-requested-with برابر با XMLHttpRequest باشد، یعنی درخواست از طریق Ajax ارسال شده است. اگر این شرط درست باشد، کد داخل بلوک if اجرا می‌شود.</p>
<blockquote>
<p>حالا داخل بدنه شرط، تمپلیتی که قرار است پست های اضافی را به صورت بارگذاری بیشتر نمایش دهد؛ رندر میگیریم.</p>
</blockquote>
<p><strong>ایجاد تمپلیت list_ajax.html:</strong></p>
<p>پست های اضافی تر که لود میشوند را در این تملیت نمایش میدهیم.</p>
<p>حلقه ای که پست ها را نشان  میدهد را از تمپلیت post_list کپی کرده و در این تمپلیت جایگذاری میکنیم.</p>
<p><code>templates/social/list_ajax.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span>

<span class="x">    &lt;!-- لینک انتقال به صفحه جزئیات پست --&gt;</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">    &lt;/a&gt;</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="x">    &lt;br&gt;</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        </span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">    there are no posts!!! </span>
<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>تمپلیت تگ {% empty %} را به حلقه اضافه میکنیم تا زمانیکه پست ها به انتها رسیدند، به کاربر اعلام کند "دیگر پستی وجود ندارد".</p>
<p><strong>بریم سراغ تمپلیت post_list:</strong></p>
<p>1 -یک تگ div با <span class="en-text">id="post-list"</span> ایجاد کرده و محتوای پست؛ (توضیحات، تاریخ ایجاد و تگ های پست) را در آن قرار میدهیم.</p>
<p>2- یک دکمه برای <strong>بارگذاری بیشتر</strong> خارج از تگ div، ایجاد میکنیم.</p>
<p><code>templates/social/post_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">tag</span> <span class="cp">%}</span>
<span class="x">    &lt;h2&gt;posts tagged with </span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>

<span class="x">&lt;div id=&quot;post-list&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span>

<span class="x">        &lt;!-- لینک انتقال به صفحه جزئیات پست --&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>

<span class="x">        published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="x">        &lt;br&gt;</span>
<span class="x">        </span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">            </span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">        &lt;br&gt;</span>
<span class="x">        &lt;hr&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;button id=&quot;load-more&quot;&gt;More&lt;/button&gt;</span>
</pre></div>

<blockquote>
<p>از این div استفاده میکنیم تا پست های بعدی را به انتهای آن اضافه کنیم.</p>
</blockquote>
<p><strong>بریم سراغ ajax:</strong></p>
<p>اضافه کردن اسکریپت ajax jquery فراموش نشه!!!</p>
<p><code>templates/social/post_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">tag</span> <span class="cp">%}</span>
<span class="x">    &lt;h2&gt;posts tagged with </span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>

<span class="x">&lt;div id=&quot;post-list&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span>

<span class="x">        &lt;!-- لینک انتقال به صفحه جزئیات پست --&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>

<span class="x">        published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="x">        &lt;br&gt;</span>
<span class="x">        </span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">            </span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">        &lt;br&gt;</span>
<span class="x">        &lt;hr&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;button id=&quot;load-more&quot;&gt;More&lt;/button&gt;</span>

<span class="x">&lt;!-- ------------- ajax structure ------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function(){</span>
<span class="x">        let page = 2;</span>
<span class="x">        $(&#39;#load-more&#39;).click(function (){</span>
<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;GET&#39;,</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">tag</span> <span class="cp">%}{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}{%</span> <span class="k">else</span> <span class="cp">%}{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list&#39;</span> <span class="cp">%}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">&#39; + &#39;?page=&#39; + page,</span>
<span class="x">                dataType: &#39;html&#39;,</span>
<span class="x">                success: function (response){</span>
<span class="x">                    $(&#39;#post-list&#39;).append(response);</span>
<span class="x">                    page += 1;</span>
<span class="x">                }</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    })</span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<blockquote>
<p>برای اولین بار که صفحه لود میشود پست های صفحه اول نمایش داده میشوند، بنابراین یک متغیر بنام page ایجاد کرده و مقدار 2 را برایش ست میکنیم؛ از آن استفاده میکنیم تا وقتی روی دکمه  <strong>بارگذاری بیشتر</strong> کلیک شد پست های صفحه 2 را نمایش دهیم و مقدارش را هر بار یکی بیشتر میکنیم تا محتوای صفحات بعدی را به ترتیب نمایش دهیم.</p>
</blockquote>
<p>1- تعریف متغیر page = 2:
یک متغیر به نام page تعریف کرده ایم که با مقدار اولیه ۲ تنظیم شده است. این متغیر برای نگهداری شماره صفحه‌ای که باید بارگذاری شود، استفاده می‌شود.</p>
<p>2- دکمه <strong>بارگذاری بیشتر</strong> را انتخاب کرده و مشخص میکنیم وقتی روی آن کلیک شد ajax اجرا شود.</p>
<p>3- <strong><span class="en-text">$.ajax({ ... })</span></strong>: این بخش یک درخواست Ajax را آغاز می‌کند.</p>
<p>4- <strong>type</strong>: نوع درخواست Ajax را مشخص می‌کند که در اینجا از نوع GET است.</p>
<blockquote>
<p>چون فقط پست ها را لود میکنیم، متد را get مشخص میکنیم.</p>
</blockquote>
<p>5- <strong>url:</strong> آدرس(URL) ی که درخواست Ajax به آن ارسال می‌شود را تعیین می‌کند.</p>
<ul>
<li>
<p>برای لیست پست ها دو url داریم، و باید از هردو url در ajax استفاده کنیم؛ برای همین از شرط استفاده میکنیم.</p>
<ul>
<li>اگر متغیر <code>tag</code> وجود داشته باشد، از URL(آدرس) <code>social:post_list_tags</code> با <code>tag.slug</code> استفاده می‌کند.</li>
<li>در غیر این صورت، از URL(آدرس) <code>social:post_list</code> استفاده می‌کند.</li>
</ul>
</li>
<li>
<p>چون صفحه بندی داریم؛ باید انتهای  URL مشخص شده، <strong>page</strong> اضافه شود.</p>
</li>
</ul>
<blockquote>
<blockquote>
<p><span class="en-text">URL + '?page=' + page</span></p>
</blockquote>
<p>این page که در انتهای کد بالا نوشته شده همان متغیری است که ایجاد کردیم.</p>
</blockquote>
<p>6- <strong>dataType:</strong> نوع داده‌ای که از سرور انتظار می‌رود به عنوان پاسخ دریافت شود، مشخص می‌کند که در اینجا HTML است.</p>
<p>7- <strong>success:</strong> این تابع زمانی اجرا می‌شود که درخواست Ajax با موفقیت انجام شود.</p>
<ul>
<li>پارامتر <code>response</code> حاوی داده‌های HTML دریافت شده از سرور(view) است.</li>
</ul>
<p>8- <strong><span class="en-text">$('#post-list').append(response)</span></strong>: محتوای HTML دریافت شده (response) به عنصر با <span class="en-text">(id="post-list")</span> همان تگ div اضافه می‌شود.</p>
<p>9- <strong>page += 1</strong>: شماره صفحه را یک واحد افزایش می‌دهد تا در درخواست بعدی صفحه بعدی بارگذاری شود.</p>
<h3 id="dhkhyrh-pst-h-b-ajax">ذخیره پست ها با AJAX</h3>
<p>ذخیره پست ها مشابه با لایک پست ها انجام میشود./ فیلد ذخیره پست ها از نوع m2m میباشد.</p>
<p><strong>1- در مدل Post یک فیلد برای ذخیره پست ها ایجاد میکنیم:</strong></p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.managers</span> <span class="kn">import</span> <span class="n">TaggableManager</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_posts&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="c1"># date</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># tags field</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">TaggableManager</span><span class="p">()</span>

    <span class="c1"># likes field</span>
    <span class="n">likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;liked_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># saved field</span>
    <span class="n">saved_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;saved_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># ordering &amp; indexing</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-total_likes&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
</pre></div>

<p><strong>2- ایجاد URL برای ذخیره پست ها:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;save-post/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">save_post</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;save_post&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>3- ایجاد view برای ذخیره پست ها:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>


<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="k">def</span> <span class="nf">save_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">post_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_id&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">post_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">post</span><span class="o">.</span><span class="n">saved_by</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">post</span><span class="o">.</span><span class="n">saved_by</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post</span><span class="o">.</span><span class="n">saved_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;saved&#39;</span><span class="p">:</span> <span class="n">saved</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid request&#39;</span><span class="p">})</span>
</pre></div>

<p><strong>4- تغییر تمپلیت post_detail برای ذخیره پست ها:</strong></p>
<p>مثله دکمه لایک کردن، یک دکمه برای ذخیره پست ها اضافه میکنیم.</p>
<blockquote>
<p>برای اولین بار که صفحه لود میشود باید مشخص کنیم که save و یا unsave را به کاربر نشان دهد، پس یک شرط مشخص میکنیم.</p>
</blockquote>
<p><code>templates/social/post_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;div class=&quot;post&quot; data-post-id=&quot;</span><span class="cp">{{</span> <span class="nv">post.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>

<span class="x">    &lt;!-- ------------ like button ------------ --&gt;</span>
<span class="x">    &lt;button class=&quot;like-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.likes.all</span> <span class="cp">%}</span>
<span class="x">            UnLike</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Like</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">    &lt;br&gt;</span>

<span class="x">    &lt;span class=&quot;likes-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.likes.count</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; Likes</span>

<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="x">    &lt;!-- ------------ save button ------------ --&gt;</span>
<span class="x">    &lt;button class=&quot;save-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.saved_by.all</span> <span class="cp">%}</span>
<span class="x">            UnSave</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Save</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;br&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Similar Posts&lt;/h2&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">similar_posts</span> <span class="cp">%}</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">10</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">    There are no similar posts!</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;!-- ---------------- ajax structure ---------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function (){</span>
<span class="x">        $(&#39;.like-button&#39;).click(function (){</span>
<span class="x">            let post_id = $(this).closest(&#39;.post&#39;).data(&#39;post-id&#39;);</span>
<span class="x">            let button = $(this);</span>
<span class="x">            </span>
<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:like_post&#39;</span> <span class="cp">%}</span><span class="x">&quot;,</span>
<span class="x">                data: {&#39;post_id&#39;: post_id, &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.liked){</span>
<span class="x">                        button.text(&#39;UnLike&#39;);</span>
<span class="x">                    }else{</span>
<span class="x">                        button.text(&#39; Like&#39;);</span>
<span class="x">                    }</span>
<span class="x">                    $(&#39;.likes-count&#39;).text(response.likes_count);</span>
<span class="x">                },</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    })</span>
<span class="x">    </span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p><strong>5- ساختار ajax، برای ذخیره پست ها:</strong></p>
<p>کد ajax مربوط به ذخیره پست ها را کنار کد ajax لایک پست ها ایجاد میکنیم.</p>
<p><code>templates/social/post_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;div class=&quot;post&quot; data-post-id=&quot;</span><span class="cp">{{</span> <span class="nv">post.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>

<span class="x">    &lt;!-- ------------ like button ------------ --&gt;</span>
<span class="x">    &lt;button class=&quot;like-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.likes.all</span> <span class="cp">%}</span>
<span class="x">            UnLike</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Like</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">    &lt;br&gt;</span>

<span class="x">    &lt;span class=&quot;likes-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.likes.count</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; Likes</span>

<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="x">    &lt;!-- ------------ save button ------------ --&gt;</span>
<span class="x">    &lt;button class=&quot;save-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">post.saved_by.all</span> <span class="cp">%}</span>
<span class="x">            UnSave</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Save</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">    &lt;/button&gt;</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;br&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">post.tags.all</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_list_tags&#39;</span> <span class="nv">tag.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">tag.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span><span class="x">, </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Similar Posts&lt;/h2&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">similar_posts</span> <span class="cp">%}</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">10</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    &lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">    There are no similar posts!</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">&lt;!-- ---------------- ajax structure ---------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function (){</span>
<span class="x">        $(&#39;.like-button&#39;).click(function (){</span>
<span class="x">            let post_id = $(this).closest(&#39;.post&#39;).data(&#39;post-id&#39;);</span>
<span class="x">            let button = $(this);</span>
<span class="x">            </span>
<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:like_post&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                data: {&#39;post_id&#39;: post_id, &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.liked){</span>
<span class="x">                        button.text(&#39;UnLike&#39;);</span>
<span class="x">                    }else{</span>
<span class="x">                        button.text(&#39; Like&#39;);</span>
<span class="x">                    }</span>
<span class="x">                    $(&#39;.likes-count&#39;).text(response.likes_count);</span>
<span class="x">                }</span>
<span class="x">            })</span>
<span class="x">        })</span>

<span class="x">        $(&#39;.save-button&#39;).click(function (){</span>
<span class="x">            let button = $(this);</span>
<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:save_post&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                data: {&#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;, &#39;post_id&#39;: </span><span class="cp">{{</span> <span class="nv">post.id</span> <span class="cp">}}</span><span class="x">},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.saved){</span>
<span class="x">                        button.text(&#39;UnSave&#39;);</span>
<span class="x">                    }else{</span>
<span class="x">                        button.text(&#39;Save&#39;);</span>
<span class="x">                    }</span>
<span class="x">                },</span>
<span class="x">                error: function (error) {</span>
<span class="x">                    console.log(&quot;Error sending ajax request: &quot; + error);</span>
<span class="x">                }</span>
<span class="x">            })</span>
<span class="x">        }) </span>
<span class="x">    })</span>
<span class="x">    </span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p>با استفاده از تابع error؛ در صورت وجود ارور، خطا در console نمایش داده میشود.</p>
<p><strong>6- نمایش پست های ذخیره شده در صفحه profile:</strong></p>
<p><strong>ایجاد view برای صفحه profile:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">saved_posts</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">saved_posts</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;saved_posts&quot;</span><span class="p">:</span> <span class="n">saved_posts</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;social/profile.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p><strong>ایجاد تمپلیت برای profile:</strong></p>
<p><code>templates/social/profile.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;Saved Posts for you&lt;/h2&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">saved_posts</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<h3 id="yjd-mdl-wst-bry-fyld-m2m">ایجاد مدل واسط برای فیلد M2M</h3>
<p>همان طور که قبلا گفته شد، وقتی فیلد M2M ایجاد کنیم جنگو یک جدول میانی شامل id از هر دو جدول ایجاد میکند.</p>
<blockquote>
<p>مثلا در لایک کردن مشخص میکند که پستی توسط چه افرادی لایک شده و یا یک کاربر چه پست هایی را لایک کرده است.</p>
</blockquote>
<p>حالا بعضی مواقع لازمه یکسری اطلاعات اضافی تر مثله تاریخ، برای فیلد های M2M داشته باشیم؛ بنابراین جدول واسط را خودمان با اطلاعات اضافی شخصی سازی میکنیم.</p>
<p><strong>ایجاد جدول واسط:</strong></p>
<p>هرجا لازم داشتیم یک رابطه M2M داشته باشیم، چه بین دو مدل(مثل post و user) و یا بین یک مدل(مثل user)؛ یک مدل به عنوان جدول واسط ایجاد کرده و هر فیلد را به مدل خودش با ForeignKey متصل میکنیم.(برای هر مدل یک رابطه ForeignKey)</p>
<blockquote>
<p>همان طور که میدانیم در جنگو جداول همان مدل ها هستند، پس برای جدول واسط یک مدل ایجاد میکنیم.</p>
</blockquote>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Contact</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># کسی که فالو میکنه</span>
    <span class="n">user_from</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_from_set&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># کسی که فالو میشه</span>
    <span class="n">user_to</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_to_set&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_from</span><span class="si">}</span><span class="s1"> follows </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_to</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

<p>ما یک مدل User داریم ولی برای عملیات فالو/آنفالو دو کاربر داریم؛ یکی کاربری که فالو میکند و دومی کاربری که فالو میشود، پس در مدل واسط دو بار به مدل User ForeignKey میزنیم.</p>
<blockquote>
<p>یک فیلد برای کاربر فالو کننده ایجاد کرده؛ و با ForeignKey آنرا به مدل User متصل میکنیم.</p>
<p>یک فیلد برای کاربر فالو شده ایجاد کرده؛ و با ForeignKey آنرا به مدل User متصل میکنیم.</p>
<p>برای درک بهتر این روابط فرض کنید دو مدل برای کاربران دارید، یکی برای following و دیگری برای followers.</p>
</blockquote>
<p>دستورات makemigrations و migrate فراموش نشه!!!</p>
<p><strong>تغییر مدل User:</strong></p>
<p>حالا برای مدل User یک فیلد M2M بنام following ایجاد میکنیم.</p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractUser</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="n">profile_image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;profile_images&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">following</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;followers&#39;</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-username&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-username&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- در عملیات فالو کردن ارتباط بین دو کاربر هست؛ بنابراین فیلد following باید به خود مدل User متصل شود، پس "self" را برایش مشخص میکنیم.</p>
<p>2- حالا باید جدول واسط(Contact) ایجاد شده را برایش مشخص کنیم؛ برای این کار از آرگومان through استفاده کرده و اسم آن مدل را برایش مینویسیم.</p>
<blockquote>
<p><strong>نکته:</strong> اگر از اسم مدلی استفاده میکنیم که در پایین تر تعریف شده است برای اینکه آنرا بشناسد و خطایی نگیرد، اسم مدل را در کوتیشن مینویسیم.</p>
</blockquote>
<p>3- اسم related_name باید برعکس باشه(اسم فیلد following هستش، پس اسم related_name باید followers باشد)؛ چون با فیلد following، به لیست کاربران فالو کننده دسترسی داریم و با related_name به لیست کاربران فالو شده دسترسی داریم.</p>
<blockquote>
<p><span class="en-text">user.following.all()</span>  <br />
<span class="en-text">user.followers.all()</span></p>
</blockquote>
<p>4- آرگومان symmetrical را False مشخص میکنیم؛  <br />
 اگه True باشه رابطه متقارن صورت میگیره؛ اگر این آرگومان True باشه  وقتی کاربر1، کاربر2 رافالو کند، اتوماتیک از جانب کاربر2، کاربر1 را فالو میکند.</p>
<p><strong><em>*نکته:</em>* وقتی از جدول میانی شخصی سازی شده برای فیلد M2M استفاده کنیم، متدهای <span class="en-text">add()</span> و <span class="en-text">remove()</span> دیگر کار نخواهند کرد.</strong></p>
<h4>اگر از مدل User، پیشفرض جنگو؛ استفاده کنیم چطور فیلد M2M را به آن اضافه کنیم؟!</h4>
<p>1- برای این کار باید ماژول get_user_model را ایمپورت کنیم.</p>
<p>2- یک متغیر ایجاد کرده و ماژول ایمپورت شده را برایش مشخص میکنیم.</p>
<p>3- حالا برای آن متغیر از متد <span class="en-text">add_to_class()</span> استفاده میکنیم.</p>
<p>4- برای متد <span class="en-text">add_to_class()،</span> اولین مقدار اسم فیلد و مقدار دوم ساختاری است که برای فیلدها مینویسیم.</p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>

<span class="n">user_model</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
<span class="n">user_model</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="s2">&quot;following&quot;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;followers&#39;</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

<h3 id="khr-b-thumbnail-nmysh-tswyr-prwfyl">کار با thumbnail (نمایش تصویر پروفایل)</h3>
<p><strong>بهینه سازی تصاویر:</strong> این بار میخواهیم با پکیج easy-thumbnails بهینه سازی تصاویر را انجام دهیم. / از آن میتوان هم در مدل ها و هم در تمپلیت استفاده کرد؛ در اینجا از آن در تمپلیت استفاده میکنیم.</p>
<blockquote>
<p>با استفاده از متد get_full_name برای کاربر میتوان اسم و فامیل کاربر را یکجا نمایش داد.</p>
</blockquote>
<p><code>templates/social/profile.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">user: </span><span class="cp">{{</span> <span class="nv">request.user.get_full_name</span> <span class="cp">}}</span>
<span class="x">&lt;br&gt;</span>
<span class="x">&lt;hr&gt;</span>


<span class="x">&lt;h2&gt;Saved Posts for you&lt;/h2&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">saved_posts</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>نصب پکیج easy-thumbnails:</strong></p>
<p>1- نصب ماژول:</p>
<p><code>Terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>pip install easy-thumbnails
</pre></div>

<p>2- اضافه کردن easy-thumbnails به اپ های پروژه در settings.py:</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;easy_thumbnails&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

<p>3- از متغیر THUMBNAIL_DEBUG در تنظیمات استفاده میکنیم، تا اگر خطایی داشت به ما نشان دهد.</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">THUMBNAIL_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p>4- دستور makemigrations و migrate فراموش نشه!!!</p>
<p><strong>نمایش تصویر پروفایل کاربر:</strong></p>
<blockquote>
<p>برخی کاربرها ممکن است تصویر پروفایل نداشته باشند؛ بنابراین یک تصویر پیشفرض، در دایرکتوری static پروژه، قرار داده و برای کاربرانی که تصویر ندارند آنرا نمایش میدهیم، برای سایر کاربر ها هم تصویر آپلودی کاربر نمایش داده میشود.</p>
</blockquote>
<p><code>templates/social/profile.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">with</span> <span class="nv">user</span><span class="o">=</span><span class="nv">request.user</span> <span class="cp">%}</span>
<span class="x">    &lt;p&gt;user: </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.profile_image.url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">100</span><span class="nv">x100</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile-image&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;avatar&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Saved Posts for you&lt;/h2&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">saved_posts</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:post_detail&#39;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">post.description</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">20</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">    &lt;/a&gt;</span>

<span class="x">    published at </span><span class="cp">{{</span> <span class="nv">post.created</span> <span class="cp">}}</span><span class="x"> by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای استفاده از static و همچنین thumbnail لازمه آنها را در تمپلیت load کنیم.</p>
<p>2- برای جلوگیری از تکرار request.user با استفاده از تمپلیت تگ with یک متغیر ساخته و حالا از آن استفاده میکنیم.</p>
<p>3- برای نمایش تصویر پروفایل، شرط میگذاریم که اگر کاربر تصویر پروفایل داشت آنرا نمایش بده و در غیر این صورت تصویر پیشفرض را نمای بده.</p>
<ul>
<li>
<p>با استفاده از تمپلیت تگ thumbnail تنظیمات تصویر را مشخص میکنیم.</p>
</li>
<li>
<p>از تمپلیت تگ thumbnail در src تگ img استفاده میکنیم.</p>
<ol>
<li>
<p>برای اولین مقدار آدرس فایل تصویر را مشخص میکنیم، اینجا دیگه از <strong>متد url</strong> استفاده نمیکنیم.</p>
</li>
<li>
<p>برای تنظیم سایز تصویر از ساختار num1xnum2 استفاده میکنیم.(ایکس مابین اعداد نوشته میشود)</p>
<blockquote>
<p>هرکدام را که صفر مشخص کنیم، باعث میشود در تغییر سایز تصویر، تناسب ابعاد آن تصویر حفظ شود.</p>
</blockquote>
</li>
<li>
<p>برای کیفیت تصویر هم از quality استفاده میکنیم.</p>
</li>
</ol>
</li>
</ul>
<h3 id="nmysh-lyst-khrbr-h">نمایش لیست کاربر ها</h3>
<p><strong>ایجاد url برای لیست کاربرها:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">user_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_list&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>ایجاد view برای لیست کاربرها:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">user_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user/user_list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">})</span>
</pre></div>

<p>کاربرانی در لیست کاربران نمایش میدهیم که وضعیت فعال داشته باشند.(فیلد isactive=True باشد.)</p>
<p><strong>ایجاد تمپلیت برای لیست کاربرها:</strong></p>
<p><code>templates/user/user_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span>
<span class="x">    &lt;!-- ---------  نمایش تصویر پروفایل  --------- --&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;#&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">100</span><span class="nv">x100</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile-image&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;#&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;avatar&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">    &lt;!-- ---------- نمایش اسم کاربر ---------- --&gt;</span>
<span class="x">    &lt;a href=&quot;#&quot;&gt; </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="cp">}}</span><span class="x"> &lt;/a&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<blockquote>
<p>بجای # آدرس صفحه جزئیات کاربر را مشخص میکنیم.</p>
</blockquote>
<h3 id="nmysh-jzyyt-khrbr">نمایش جزئیات کاربر</h3>
<p><strong>ایجاد url برای صفحه جزئیات کاربر:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&lt;str:username&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">user_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_detail&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p>برای استفاده از url صفحه user_detail؛ برای مدل User متد get_absolute_url مشخص میکنیم:</p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractUser</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="n">profile_image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;profile_images&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">following</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;followers&#39;</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-username&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-username&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;social:user_detail&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
</pre></div>

<p><strong>خب حالا چطور برای مدل User (پیشفرض جنگو) متد get_absolute_url مشخص کنیم؟!</strong></p>
<p>1- در settings.py یک متغیر بنام ABSOLUTE_URL_OVERRIDES ایجاد کرده و برای یک دیکشنری مشخص میکنیم.</p>
<p>2- key این دیکشنری، User پیشفرض جنگو و value آن یک تابع lambda میباشد.</p>
<p>3- u را به عنوان کاربری که از آن متد استفاده میکند برداشته و url را برای ما برمیگرداند.</p>
<ul>
<li>u نماینده همان کاربر هست و بجای self از آن استفاده میکنیم.</li>
</ul>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse_lazy</span>

<span class="c1"># ...</span>

<span class="n">ABSOLUTE_URL_OVERRIDES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;auth.user&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;social:user_detail&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">]),</span>
<span class="p">}</span>
</pre></div>

<p><strong>خب دیگه! بریم سراغ view جزئیات کاربر:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">user_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user/user_detail.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>کاربر را با استفاده از username (که توسط url ارسال شده) بدست می آوریم. / البته آن کاربرانی که در وبسایت active باشند.</p>
<p><strong>در تمپلیت لیست کاربرها لینک صفحه جزئیات کاربر را برای تگ های a مشخص میکنیم.</strong></p>
<p>در اینجا از متد get_absolute_url استفاده میکنیم.</p>
<p><code>templates/user/user_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span>
<span class="x">    &lt;!-- ---------  نمایش تصویر پروفایل  --------- --&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">100</span><span class="nv">x100</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile-image&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;avatar&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">    &lt;!-- ---------- نمایش اسم کاربر ---------- --&gt;</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt; </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="cp">}}</span><span class="x"> &lt;/a&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>ایجاد تمپلیت برای صفحه جزئیات کاربر:</strong></p>
<p>در تمپلیت جزئیات کاربر؛ تصویر پروفایل، اسم کامل کاربر در صورت وجود، تعداد followers و following و یکسری اطلاعات اضافی را نمایش میدهیم.</p>
<p><code>templates/user/user_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش تصویر پروفایل --------------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.profile_image.url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">        &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">150</span><span class="nv">x0</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile_image&quot;&gt;</span>
<span class="x">    &lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">    &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;default_image&quot; width=&quot;150px&quot;&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش اسم کاربر --------------------- --&gt;</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>
<span class="x">hello I&#39;m </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="o">|</span> <span class="nf">default</span><span class="o">:</span><span class="nv">user.username</span> <span class="cp">}}</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>

<span class="x">&lt;!-- ------------ following و followers نمایش تعداد-------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">with</span> <span class="nv">total_followers</span><span class="o">=</span><span class="nv">user.followers.count</span> <span class="nv">total_following</span><span class="o">=</span><span class="nv">user.following.count</span> <span class="cp">%}</span>
<span class="x">    following: &lt;span class=&quot;following-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_following</span> <span class="cp">}}</span><span class="x"> following</span><span class="cp">{{</span> <span class="nv">total_following</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="x">    followers: &lt;span class=&quot;followers-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="cp">}}</span><span class="x"> Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش اطلاعات اضافی کاربر --------------------- --&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.bio</span> <span class="cp">%}</span><span class="x">Bio: </span><span class="cp">{{</span> <span class="nv">user.bio</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.job</span> <span class="cp">%}</span><span class="x">Job: </span><span class="cp">{{</span> <span class="nv">user.job</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.birth_date</span> <span class="cp">%}</span><span class="x">Date of Birth: </span><span class="cp">{{</span> <span class="nv">user.birth_date</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>

<p><strong>نمایش جدول واسط در پنل ادمین:</strong></p>
<p><code>app directory/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Contact</span><span class="p">)</span>
</pre></div>

<h3 id="pydh-szy-flw-w-nflw-b-ajax">پیاده سازی فالو و آنفالو با AJAX</h3>
<p><strong>ایجاد url برای عملیات فالو / آنفالو:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/follow/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">user_follow</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_follow&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>ایجاد view برای فالو / آنفالو:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@require_POST</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">user_follow</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># کاربری که قراره فالو یا آنفالو بشه</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_from</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">user_to</span><span class="o">=</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">followed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user_from</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">user_to</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
                <span class="n">followed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">followers_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">following_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;followers_count&#39;</span><span class="p">:</span> <span class="n">followers_count</span><span class="p">,</span>
                <span class="s1">&#39;following_count&#39;</span><span class="p">:</span> <span class="n">following_count</span><span class="p">,</span>
                <span class="s1">&#39;followed&#39;</span><span class="p">:</span> <span class="n">followed</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User not found&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid request&#39;</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p>در ساختاری که ایجاد کرده‌ایم، از مدل واسط Contact برای مدیریت رابطه‌ی فالو و آنفالو بین کاربران استفاده می‌کنیم. این مدل واسط به عنوان یک جدول واسط بین کاربران عمل می‌کند و اطلاعات مربوط به فالو و آنفالو را ذخیره می‌کند.</p>
</li>
<li>
<p>رابطه‌ی Many-to-Many بین کاربران از طریق مدل واسط Contact مدیریت می‌شود و وقتی کاربر دیگری را فالو یا آنفالو می‌کنید، داده‌ها در مدل واسط اضافه یا حذف می‌شوند. جنگو به طور خودکار از طریق رابطه‌ی Many-to-Many فیلدهای following و followers را به‌روزرسانی می‌کند. این بدان معناست که با اضافه یا حذف رکوردها در مدل واسط Contact، رابطه‌های following و followers به‌روز می‌شوند.</p>
</li>
</ul>
<blockquote>
<p>در مدل واسط (Contact) دو فیلد ایجاد کردیم:</p>
<p>زمانی که کاربر1(user_from) کاربر2(user_to) را فالو میکند</p>
<p><strong>user_from:</strong> کاربری که فالو میکند  <br />
بنابراین کاربر1 به لیست followers کاربر2 اضافه میشود.</p>
<p><strong>user_to:</strong> کاربری که فالو میشود  <br />
بنابراین کاربر2 به لیست following کاربر1 اضافه میشود.</p>
</blockquote>
<p>1- آیدی کاربر(user_id) ، که توسط ajax از تمپلیت ارسال شده را با استفاده از request دریافت کرده و آنرا در یک متغیر ذخیره میکینم.(آیدی کاربری که میخواهیم وی را فالو یا آنفالو کنیم)</p>
<p>2- کاربر فعلی وبسایت (request.user)، کاربری است که عملیات فالو کردن را انجام میدهد.</p>
<p>3- وقتی کاربر فعلی (request.user) می‌خواهد یک کاربر دیگر را فالو کند، ابتدا بررسی می‌شود که آیا کاربر فعلی در لیست فالوورهای کاربر دیگر (user.followers.all()) وجود دارد یا خیر.</p>
<p>4- اگر کاربر فعلی در لیست فالوورهای کاربر دیگر وجود دارد، رکورد مربوطه در مدل واسط Contact حذف می‌شود.</p>
<ul>
<li>یک متغیر بنام followed ایجاد کرده و مقدار آنرا False قرار میدهیم، یعنی کاربر را آنفالو کرده است. / از این متغیر برای تغییر وضعیت دکمه follow استفاده میکنیم.</li>
</ul>
<p>5- اگر کاربر در لیست فالووران وجود ندارد، یک رکورد جدید در مدل واسط Contact ایجاد میکنیم، که user_from به کاربر فعلی و user_to به کاربر دیگر اشاره می‌کند.</p>
<ul>
<li>متغیر followed این بار True خواهد بود.</li>
</ul>
<p>6- پس از عملیات فالو کردن؛ تعداد following و followers را با استفاده از متد count بدست می آوریم.</p>
<p>7- تعداد following و followers و نیز متغیر followed در response_data قرار گرفته و به عنوان json به تمپلیت ارسال میشوند.(با استفاده از JsonResponse به تمپلیت ارسال میشوند.)</p>
<p>8- ارورهای مربوطه را هم نمایش میدهیم.</p>
<p><strong>بریم سراغ ajax برای دکمه follow:</strong></p>
<p>یک دکمه برای فالو کردن ایجاد میکنیم.</p>
<p><strong>نکته:</strong> برای خود کاربر نباید دکمه follow نمایش داده شود.</p>
<blockquote>
<p>برای اولین بار که صفحه لود میشود view مربوط به following هنوز اجرا نشده بنابراین با استفاده از شرط متن دکمه follow را مشخص میکنیم.</p>
</blockquote>
<p><code>templates/user/user_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش تصویر پروفایل --------------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.profile_image.url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">        &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">150</span><span class="nv">x0</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile_image&quot;&gt;</span>
<span class="x">    &lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">    &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;default_image&quot; width=&quot;150px&quot;&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش اسم کاربر --------------------- --&gt;</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>
<span class="x">hello I&#39;m </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="o">|</span> <span class="nf">default</span><span class="o">:</span><span class="nv">user.username</span> <span class="cp">}}</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>

<span class="x">&lt;!-- --------------------- دکمه Follow ----------------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user</span> <span class="o">!=</span> <span class="nv">request.user</span> <span class="cp">%}</span>
<span class="x">    &lt;button class=&quot;follow-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">user.followers.all</span> <span class="cp">%}</span>
<span class="x">            UnFollow</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Follow</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">    &lt;/button&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">&lt;hr&gt;</span>

<span class="x">&lt;!-- ------------ following و followers نمایش تعداد-------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">with</span> <span class="nv">total_followers</span><span class="o">=</span><span class="nv">user.followers.count</span> <span class="nv">total_following</span><span class="o">=</span><span class="nv">user.following.count</span> <span class="cp">%}</span>
<span class="x">    following: &lt;span class=&quot;following-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_following</span> <span class="cp">}}</span><span class="x"> Following&lt;/span&gt;</span>
<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="x">    followers: &lt;span class=&quot;followers-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="cp">}}</span><span class="x"> Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>

<span class="x">&lt;!-- ----------------- نمایش اطلاعات اضافی کاربر ----------------- --&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.bio</span> <span class="cp">%}</span><span class="x">Bio: </span><span class="cp">{{</span> <span class="nv">user.bio</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.job</span> <span class="cp">%}</span><span class="x">Job: </span><span class="cp">{{</span> <span class="nv">user.job</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.birth_date</span> <span class="cp">%}</span><span class="x">Date of Birth: </span><span class="cp">{{</span> <span class="nv">user.birth_date</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>

<span class="x">&lt;!-- --------------------- ajax ساختار کد ----------------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>


<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function (){</span>
<span class="x">        $(&#39;.follow-button&#39;).click(function (){</span>
<span class="x">            let followButton = $(this);</span>

<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_follow&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                data: {&#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;, &#39;user_id&#39;: &#39;</span><span class="cp">{{</span><span class="nv">user.id</span><span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.followed){</span>
<span class="x">                        followButton.text(&#39;UnFollow&#39;);</span>
<span class="x">                    } else {</span>
<span class="x">                        followButton.text(&#39;Follow&#39;);</span>
<span class="x">                    }</span>
<span class="x">                    $(&#39;.followers-count&#39;).text(response.followers_count + &#39;Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&#39;);</span>
<span class="x">                    $(&#39;.following-count&#39;).text(response.following_count + &#39;Following&#39;);</span>
<span class="x">                }</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    })</span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p><strong>توضیحات کد ajax:</strong></p>
<p>1- دکمه فالو را انتخاب کرده و مشخص میکنیم، زمانیکه روی آن کلیک شد کارهایی صورت بگیره.</p>
<p>2- دکمه فالو را در یک متغیر ذخیره میکنیم، تا بتوانیم، وضعیت آن (Follow/Unfollow) را مشخص کنیم.</p>
<p>3- <strong>type:</strong> 'POST': نوع درخواست AJAX را به POST تنظیم می‌کند.</p>
<p>4- <strong>url:</strong> URL مقصد برای ارسال درخواست را تنظیم میکند.</p>
<p>5- <strong>data:</strong> داده‌هایی که باید به سرور ارسال شوند. شامل توکن CSRF برای امنیت و id کاربری که قرار است فالو یا آنفالو شود.</p>
<p>6- <strong>success:</strong> تابعی که بعد از موفقیت‌آمیز بودن درخواست اجرا می‌شود. response حاوی داده‌های برگشتی از سرور است.</p>
<ul>
<li>
<p>با استفاده از متغیر followed بررسی میکنیم که کاربر فالو شده است یا نه!</p>
</li>
<li>
<p>اگر کاربر فالو شده باشد(followed=True)، متن دکمه به "UnFollow" تغییر می‌کند.</p>
</li>
<li>
<p>اگر کاربر آنفالو شده باشد(followed=False)، متن دکمه به "Follow" تغییر می‌کند.</p>
</li>
<li>
<p>تعداد following و followers را آپدیت میکنیم.</p>
</li>
</ul>
<h3 id="bhynh-szy-khwyry-select-related-w-prefetch-related">بهینه سازی کوئری (select_related و prefetch_related)</h3>
<p>در این بخش می آموزیم که چطور، کوئری هایی که به دیتابیس میزنیم (تا مواردی را از دیتابیس بازیابی کنیم) را را به صرت بهینه تر بنویسیم تا تعامل با دیتابیس کمتر شود.(کمتر به دیتابیس کوئری بزنیم؛ تا کدها سریع تر اجرا شوند.)</p>
<p>برای بهینه سازی کوئری ها از select_related و prefetch_related استفاده میکنیم.</p>
<p><strong>این کار برای زمانیست که یکی از روابط (ManyToMany, OneToOne, ForeignKey) را داشته باشیم.</strong></p>
<p>در زمان هایی که در کوئری از فیلدهای دارای روابط استفاده میکنیم؛ چون با دو جدول سر و کار داریم در SQL دو بار کد میزند، (1: جدول اول 2: برای جدول دوم)، برای این حالات از select_related یا prefetch_related استفاده میکنیم.</p>
<blockquote>
<p><strong>نکته:</strong> select_related برای روابط OneToOne و ForeignKey مناسب است.</p>
<p>لال select_related با استفاده از <strong>inner join</strong> در کد <strong>SQL</strong> دو جدول را بهم متصل میکند؛ حالا درخواست ونتیجه کوئری  را از این جدول جدید استخراج میکند.</p>
</blockquote>
<p><strong>روش استفاده از select_related:</strong></p>
<p>بعد از manager از آن استفاده کرده و برایش اسم فیلد یا فیلدهای رابطه ای که در آن مدل هستند را مشخص میکنیم.</p>
<p>در مدل Post فیلد author دارای رابطه ForeignKey میباشد به همین خاطر آن فیلد را برای select_related مشخص میکنیم.</p>
<p><code>shell</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">shell</span>
        </div>
    <pre><span></span>Model_Name.manager.select_related<span class="o">(</span>relation_field_name<span class="o">)</span>

<span class="c1"># پست هایی را که نام کاربری، نویسنده آنها مارتین است را انتخاب میکند. </span>
Post.objects.select_related<span class="o">(</span><span class="s1">&#39;author&#39;</span><span class="o">)</span>.filter<span class="o">(</span><span class="nv">author__username</span><span class="o">=</span><span class="s2">&quot;Martin&quot;</span><span class="o">)</span>

<span class="c1"># پست با آیدی 5 را انتخاب کرده سپس اسم کوچک نویسنده آنرا درخواست کرده ام.</span>
Post.objects.select_related<span class="o">(</span><span class="s1">&#39;author&#39;</span><span class="o">)</span>.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">5</span><span class="o">)</span>.author.first_name
</pre></div>

<p>خروجی یک کد SQL میباشد که دو جدول را با inner join به یکدیگر متصل کرده است.</p>
<blockquote>
<p>در view میتوانیم هر جا که با فیلدهای رابطه ای سر و کار داریم از select_related استفاده کنیم.</p>
</blockquote>
<p><strong>دستور prefetch_related:</strong></p>
<p>این یکی متفاوت عمل میکند؛ select_related در کد SQL با استفاده از inner join دو جدول را بهم متصل میکرد ولی prefetch_related یکبار اطلاعات هر دو جدول را برمیدارد(یکبار SQL میزند ولی برای هر دو جدول) و سایر کارها را در پایتون انجام میدهد.</p>
<ul>
<li>در این حالت، یک کوئری جداگانه برای هر مجموعه از داده‌های مرتبط انجام می‌شود و سپس این داده‌ها در حافظه پایتون ترکیب می‌شوند.</li>
</ul>
<blockquote>
<p>برای روابط ManyToMany مناسب میباشد.</p>
</blockquote>
<p><strong>خب بریم توی shell نمونه select_related را ببینیم:</strong></p>
<blockquote>
<p><strong>connection:</strong> ماژول connection کد SQL مربوط به ORM را به ما نشان میدهد.</p>
<p><strong>reset_queries:</strong> کوئری های قبلی را پاک میکند.</p>
<p><strong>pprint:</strong> برای نمایش بهتر کد SQL استفاده میکنیم./ کدها پشت سر هم و بهم ریخته نباشند.</p>
</blockquote>
<p><code>shell</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">shell</span>
        </div>
    <pre><span></span>&gt;&gt;&gt;<span class="w"> </span>from<span class="w"> </span>django.db<span class="w"> </span>import<span class="w"> </span>reset_queries,<span class="w"> </span>connection
...<span class="w"> </span>from<span class="w"> </span>social.models<span class="w"> </span>import<span class="w"> </span>Post
...<span class="w"> </span>from<span class="w"> </span>pprint<span class="w"> </span>import<span class="w"> </span>pprint

&gt;&gt;&gt;<span class="w"> </span>Post.objects.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">7</span><span class="o">)</span>.author.username
<span class="s1">&#39;Martin&#39;</span>

&gt;&gt;&gt;<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>
<span class="o">[{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_post&quot;.&quot;id&quot;, &quot;social_post&quot;.&quot;author_id&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_post&quot;.&quot;description&quot;, &quot;social_post&quot;.&quot;created&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_post&quot;.&quot;updated&quot;, &quot;social_post&quot;.&quot;total_likes&quot; FROM &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_post&quot; WHERE &quot;social_post&quot;.&quot;id&quot; = 7 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}</span>,
<span class="w"> </span><span class="o">{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;WHERE &quot;social_user&quot;.&quot;id&quot; = 1 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}]</span>

&gt;&gt;&gt;<span class="w"> </span>reset_queries<span class="o">()</span>

&gt;&gt;&gt;<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>
<span class="o">[]</span>

&gt;&gt;&gt;<span class="w"> </span>Post.objects.select_related<span class="o">()</span>.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">7</span><span class="o">)</span>.author.username
<span class="s1">&#39;Martin&#39;</span>

&gt;&gt;&gt;<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>
<span class="o">[{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_post&quot;.&quot;id&quot;, &quot;social_post&quot;.&quot;author_id&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_post&quot;.&quot;description&quot;, &quot;social_post&quot;.&quot;created&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_post&quot;.&quot;updated&quot;, &quot;social_post&quot;.&quot;total_likes&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_post&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;INNER JOIN &quot;social_user&quot; ON (&quot;social_post&quot;.&quot;author_id&quot; = &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;id&quot;) WHERE &quot;social_post&quot;.&quot;id&quot; = 7 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}]</span>
</pre></div>

<p>در کد بالا میبینید که دو جدول را با INNER JOIN به یکدیگر متصل کرده است.</p>
<p><strong>خب بریم توی shell نمونه prefetch_related را ببینیم:</strong></p>
<p><code>shell</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">shell</span>
        </div>
    <pre><span></span>&gt;&gt;&gt;<span class="w"> </span>from<span class="w"> </span>django.db<span class="w"> </span>import<span class="w"> </span>reset_queries,<span class="w"> </span>connection
...<span class="w"> </span>from<span class="w"> </span>social.models<span class="w"> </span>import<span class="w"> </span>*
...<span class="w"> </span>from<span class="w"> </span>pprint<span class="w"> </span>import<span class="w"> </span>pprint


&gt;&gt;&gt;<span class="w"> </span><span class="k">for</span><span class="w"> </span>user<span class="w"> </span><span class="k">in</span><span class="w"> </span>User.objects.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>.followers.all<span class="o">()</span>:
...<span class="w">     </span>user.username
...
...<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>

<span class="o">[{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;WHERE &quot;social_user&quot;.&quot;id&quot; = 1 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}</span>,
<span class="w"> </span><span class="o">{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;INNER JOIN &quot;social_contact&quot; ON (&quot;social_user&quot;.&quot;id&quot; = &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_contact&quot;.&quot;user_from_id&quot;) WHERE &quot;social_contact&quot;.&quot;user_to_id&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;= 1 ORDER BY &quot;social_user&quot;.&quot;username&quot; DESC&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}</span>,
<span class="w"> </span><span class="o">{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;WHERE &quot;social_user&quot;.&quot;id&quot; = 1 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}</span>,
<span class="w"> </span><span class="o">{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;INNER JOIN &quot;social_contact&quot; ON (&quot;social_user&quot;.&quot;id&quot; = &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_contact&quot;.&quot;user_from_id&quot;) WHERE &quot;social_contact&quot;.&quot;user_to_id&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;= 1 ORDER BY &quot;social_user&quot;.&quot;username&quot; DESC&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}]</span>

&gt;&gt;&gt;<span class="w"> </span>reset_queries<span class="o">()</span>

&gt;&gt;&gt;<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>
<span class="o">[]</span>

&gt;&gt;&gt;<span class="w"> </span><span class="k">for</span><span class="w"> </span>user<span class="w"> </span><span class="k">in</span><span class="w"> </span>User.objects.prefetch_related<span class="o">()</span>.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>.followers.all<span class="o">()</span>:
...<span class="w">     </span>user.username
...
...<span class="w"> </span>pprint<span class="o">(</span>connection.queries<span class="o">)</span>

<span class="o">[{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;WHERE &quot;social_user&quot;.&quot;id&quot; = 1 LIMIT 21&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}</span>,
<span class="w"> </span><span class="o">{</span><span class="s1">&#39;sql&#39;</span>:<span class="w"> </span><span class="s1">&#39;SELECT &quot;social_user&quot;.&quot;id&quot;, &quot;social_user&quot;.&quot;password&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_login&quot;, &quot;social_user&quot;.&quot;is_superuser&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;username&quot;, &quot;social_user&quot;.&quot;first_name&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;last_name&quot;, &quot;social_user&quot;.&quot;email&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;is_staff&quot;, &quot;social_user&quot;.&quot;is_active&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;date_joined&quot;, &quot;social_user&quot;.&quot;profile_image&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;bio&quot;, &quot;social_user&quot;.&quot;birth_date&quot;, &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_user&quot;.&quot;job&quot;, &quot;social_user&quot;.&quot;phone_number&quot; FROM &quot;social_user&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;INNER JOIN &quot;social_contact&quot; ON (&quot;social_user&quot;.&quot;id&quot; = &#39;</span>
<span class="w">         </span><span class="s1">&#39;&quot;social_contact&quot;.&quot;user_from_id&quot;) WHERE &quot;social_contact&quot;.&quot;user_to_id&quot; &#39;</span>
<span class="w">         </span><span class="s1">&#39;= 1 ORDER BY &quot;social_user&quot;.&quot;username&quot; DESC&#39;</span>,
<span class="w">  </span><span class="s1">&#39;time&#39;</span>:<span class="w"> </span><span class="s1">&#39;0.000&#39;</span><span class="o">}]</span>
</pre></div>

<p>در ساختار بالا مشاهده میکنید که قبل از استفاده از prefetch_related چهار کوئری برای SQL داشتیم ولی پس از استفاده دو کوئری داریم.</p>
<blockquote>
<p>همان طور که گفته شد و در کد بالا میبینید، در SQL دو جدول را بر میدارد و سایر کارها در حافظه پایتون انجام میدهد.</p>
</blockquote>
<h3 id="khr-b-sygnl-h-mhsbh-mjmw-lykh">کار با سیگنال ها (محاسبه مجموع لایک)</h3>
<p>با استفاده از سیگنال‌ها می‌توان مشخص کرد که وقتی تغییری در یکی از مدل‌ها صورت گرفت، یکسری کارها انجام شود. سیگنال‌ها به شما این امکان را می‌دهند که به رویدادهای مختلف واکنش نشان داده و مشخص کنید چه عکس‌العملی نشان داده شود. این رویدادها می‌توانند شامل موارد زیر باشند:</p>
<p>1- ایجاد داده‌های جدید  <br />
2- ویرایش داده‌های موجود  <br />
3- حذف داده‌ها از دیتابیس <br />
4- ورود و خروج کاربران  <br />
و...</p>
<p><strong>حساسیت جنگو نسبت به استفاده از سیگنال‌ها</strong></p>
<p>جنگو نسبت به استفاده از سیگنال‌ها حساس است و توصیه می‌کند تا جایی که ممکن است از آن‌ها استفاده نکنید، زیرا استفاده نادرست و نابجا از سیگنال‌ها می‌تواند مشکلاتی ایجاد کند. در زیر برخی از این دلایل بیان شده است:</p>
<p><strong>دلایل حساسیت جنگو</strong></p>
<ol>
<li>
<p>پیچیدگی و دشواری در ردیابی</p>
<p>سیگنال‌ها می‌توانند کد را پیچیده‌تر کنند و ردیابی و اشکال‌زدایی آن را دشوارتر سازند. زیرا اتصال بین سیگنال‌ها و گیرنده‌ها اغلب به صورت صریح در یکجا تعریف نمی‌شود و ممکن است در نقاط مختلف پروژه پراکنده باشند. این می‌تواند باعث شود که فهمیدن اینکه چه چیزی باعث فراخوانی یک سیگنال شده است، مشکل باشد.</p>
</li>
<li>
<p>نامرئی بودن جریان کنترلی</p>
<p>در کدهای معمولی، جریان کنترلی (flow control) مشخص و قابل پیش‌بینی است. اما سیگنال‌ها می‌توانند جریان کنترلی نامرئی ایجاد کنند که باعث می‌شود کد به صورت غیرمنتظره‌ای عمل کند. این نامرئی بودن می‌تواند مشکلاتی در پیش‌بینی رفتار برنامه ایجاد کند.</p>
</li>
<li>
<p>احتمال مشکلات عملکردی</p>
<p>سیگنال‌ها می‌توانند به طور غیرمستقیم باعث کاهش عملکرد (performance) شوند، به خصوص اگر تعداد زیادی گیرنده برای یک سیگنال ثبت شده باشند و هر کدام کارهای سنگینی انجام دهند. این می‌تواند منجر به تأخیر در عملیات اصلی شود.</p>
</li>
<li>
<p>وابستگی‌ها و Coupling</p>
<p>سیگنال‌ها می‌توانند باعث ایجاد وابستگی‌های غیرمنتظره بین بخش‌های مختلف کد شوند. این وابستگی‌ها می‌توانند مانع از تغییرات راحت در کد شوند و نگهداری و توسعه کد را مشکل‌تر کنند.</p>
</li>
<li>
<p>تست‌پذیری پایین‌تر</p>
<p>کدی که به شدت به سیگنال‌ها وابسته است، می‌تواند تست کردن را مشکل‌تر کند. چون سیگنال‌ها به طور غیرمستقیم فراخوانی می‌شوند، ممکن است متوجه نشوید که چه چیزی باید تست شود و یا چگونه باید این کار را انجام دهید. همچنین، تست کردن کدی که به سیگنال‌ها وابسته است، می‌تواند نیاز به ابزارها و روش‌های خاصی داشته باشد که کار تست را پیچیده‌تر می‌کند.</p>
</li>
</ol>
<p><strong>جایگزین‌های مناسب برای سیگنال‌ها:</strong></p>
<p>در مواردی که امکان‌پذیر است، استفاده از روش‌های جایگزین می‌تواند منطقی‌تر باشد:</p>
<ul>
<li>
<p><strong>استفاده از متدهای مدل:</strong> در برخی موارد با override کردن متدهای مدل مثل save یا delete می‌توانید کار مشابه با سیگنال‌ها را انجام دهید.</p>
</li>
<li>
<p><strong>Middlewares:</strong> برای عملیات‌هایی که باید در سطح درخواست/پاسخ انجام شوند، می‌توان از Middlewares استفاده کرد.</p>
</li>
<li>
<p><strong>View و فرم‌ها:</strong> برای عملیات‌های وابسته به view، می‌توانید منطق را مستقیماً در view یا فرم‌ها پیاده‌سازی کنید.</p>
</li>
</ul>
<p><strong>نتیجه‌گیری:</strong></p>
<p>با توجه به این نکات، استفاده از سیگنال‌ها در Django باید با دقت و فقط در موارد ضروری انجام شود. سیگنال‌ها می‌توانند ابزار قدرتمندی باشند، اما استفاده نادرست از آن‌ها می‌تواند مشکلات قابل توجهی ایجاد کند.</p>
<blockquote>
<p>در جنگو انواع مختلفی از سیگنال ها داریم، با توجه به نیاز هر یک را ایمپورت کرده و استفاده میکنیم.</p>
</blockquote>
<p><strong>در این بخش میخواهیم یک فیلد بنام total_likes به مدل Post اضافه کنیم که تعداد کل لایک ها را نشان میدهد؛ برای اینکه با like و dislike مقدار این فیلد تغییر کند از سیگنال استفاده میکنیم. / در واقع میخواهیم سیگنالی بنویسیم که مقدار این فیلد را آپدیت میکند.</strong></p>
<p>یک فیلد برای نمایش تعداد کل لایک ها در مدل Post ایجاد میکنیم.</p>
<blockquote>
<p>این فیلد را از نوع PositiveIntegerField انتخاب میکنیم، چون تعداد لایک ها نمیتواند منفی باشد.</p>
</blockquote>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.managers</span> <span class="kn">import</span> <span class="n">TaggableManager</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_posts&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="c1"># date</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># tags field</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">TaggableManager</span><span class="p">()</span>

    <span class="c1"># likes field</span>
    <span class="n">likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;liked_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># total number of likes field</span>
    <span class="n">total_likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># saved field</span>
    <span class="n">saved_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;saved_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># ordering &amp; indexing</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-total_likes&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>مقدار پیشفرض فیلد total_likes را صفر مشخص کرده ایم، پس مقدار این فیلد برای تمام پست ها صفر میباشد.</p>
<p>چون میخواهیم براساس تعداد لایک ها(پست محبوب) مرتب سازی را انجام دهیم؛ بنابراین یک index برای فیلد total_likes اضافه میکنیم.</p>
<blockquote>
<p>خب پس از افزودن فیلد دستورات makemigrations و migrate فراموش نشه!!!</p>
</blockquote>
<p><strong>آپدیت دستی فیلد total_likes:</strong></p>
<p>در shell روی تمام پست ها حلقه زده و مقدار فیلد total_likes را برابر با تعداد کاربران فیلد likes قرار میدهیم، در پایان با متد save تغییرات را ذخیره میکنیم.</p>
<p><code>shell</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">shell</span>
        </div>
    <pre><span></span>&gt;&gt;&gt;<span class="w"> </span>from<span class="w"> </span>social.models<span class="w"> </span>import<span class="w"> </span>Post

&gt;&gt;&gt;<span class="w"> </span><span class="k">for</span><span class="w"> </span>post<span class="w"> </span><span class="k">in</span><span class="w"> </span>Post.objects.all<span class="o">()</span>:
...<span class="w">     </span>post.total_likes<span class="w"> </span><span class="o">=</span><span class="w"> </span>post.likes.count<span class="o">()</span>
...<span class="w">     </span>post.save<span class="o">()</span>
</pre></div>

<p><strong>تغییر view لیست پست ها:</strong></p>
<p>میخواهیم در لیست پست ها(post_list)؛ پست ها را براساس محبوبیت آنها نمایش دهیم بنابراین در view لیست پست ها(post_list) ، پست ها را براساس فیلد total_likes مرتب میکنیم.</p>
<blockquote>
<p>قاعدتا پستی که بیشترین تعداد لایک را دارد محبوب تر است.</p>
</blockquote>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.models</span> <span class="kn">import</span> <span class="n">Tag</span>
<span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span><span class="p">,</span> <span class="n">EmptyPage</span><span class="p">,</span> <span class="n">PageNotAnInteger</span>


<span class="k">def</span> <span class="nf">post_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tag_slug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-total_likes&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tag_slug</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">tag_slug</span><span class="p">)</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

    <span class="c1"># صفحه بندی برای پست ها</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PageNotAnInteger</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EmptyPage</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-requested-with&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/list_ajax.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="n">posts</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/post_list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;posts&#39;</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="p">})</span>
</pre></div>

<p><strong>بریم سیگنال ایجاد کنیم:</strong></p>
<p>در دایرکتوری app یک فایل پایتونی بنام signals.py ایجاد میکنیم، سیگنال ها در این فایل نوشته میشوند.</p>
<p>1- سیگنالی را که لازم داریم، را ایمپورت میکنیم.</p>
<p>(چون میخواهیم با تغییر فیلد لایک ها که M2M هست، فیلد total_likes را آپدیت کنیم، از سیگنال m2m_changed استفاده میکنیم.)</p>
<p>2- receiver هم باید ایمپورت شود.</p>
<p>3- مدلی که سیگنال ارسال میکند هم باید ایمپورت شود.</p>
<p><code>app directory/signals.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">m2m_changed</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Post</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">m2m_changed</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">through</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">like_change</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">total_likes</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<blockquote>
<p>وقتی فیلد likes تغییر میکنه، سیگنال ارسال میشه، دکوراتور receiver آن سیگنال را دریافت کرده و تابع اجرا میشود.</p>
</blockquote>
<p><strong>توضیحات:</strong></p>
<p>1- برای دکوراتور receiver، نوع سیگنال را مشخص میکنیم، تا با ارسال سیگنال، آنرا دریافت کند.</p>
<p>2- برای receiver، آرگومان sender را هم مشخص میکنیم.</p>
<blockquote>
<p><strong>sender:</strong> برایش آن مدلی را مشخص میکنیم که تغییر آن مدل (مثل حذف یک آبجکت) و یا فیلدهای آن(مثل لایک شدن پست) موجب ارسال سیگنال مربوطه میشود.</p>
<p>برای sender مدلی که سیگنال را ارسال میکند  مشخص میکنیم. / برای فیلدهای M2M مدل واسط را مشخص میکنیم.</p>
</blockquote>
<p><strong>اگر فیلد M2M هست برای آرگومان sender آن جدول میانی را مشخص میکنیم.</strong></p>
<blockquote>
<p><span class="en-text">Model_Name.relation_field.through</span></p>
<p><span class="en-text">Post.likes.through</span></p>
</blockquote>
<ul>
<li>through نشان دهنده همان جدول میانی است.</li>
</ul>
<p><strong>تابع برای سیگنال:</strong></p>
<p>برای تابع پارامترهای (sender, instance, **kwargs) را مشخص میکنیم.</p>
<blockquote>
<p>پارامتر instance: یک آبجکت از آن مدل هست که تغییر برایش صورت گرفته است. در اینجا مدل Post.</p>
</blockquote>
<ul>
<li>مثل کاری که در shell برای آپدیت فیلد total_likes انجام دادیم، اینجا هم همان کار را انجام میدهیم. / چون آبجکت آن مدل آپدیت شده است از متد save استفاده میکنیم.</li>
</ul>
<p><strong>برای استفاده از سیگنال ها باید کانفیگ آنرا به پروژه اضافه کنیم:</strong></p>
<p>برای این کار وارد فایل پایتونی apps.py میشویم(این فایل در دایرکتوری اپ(app) وجود دارد.)</p>
<p><code>app directory/apps.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>


<span class="k">class</span> <span class="nc">SocialConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">default_auto_field</span> <span class="o">=</span> <span class="s1">&#39;django.db.models.BigAutoField&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;social&#39;</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">social.signals</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p>داخل بدنه کلاس <span class="en-text">&lt;app_name&gt;</span>Config(در اینجا SocialConfig) متد ready را override میکنیم.</p>
</li>
<li>
<p>داخل بدنه متد ready فایل پایتونی سیگنال را ایمپورت میکنیم.</p>
<blockquote>
<p>signals اسم فایل پایتونی هست که سیگنال ها را آنجا مینویسیم.</p>
<blockquote>
<p><span class="en-text">import &lt;app_name&gt;.signals</span></p>
</blockquote>
</blockquote>
</li>
</ul>
<h3 id="khr-b-sygnl-h-rsl-ymyl-hdhf-pst">کار با سیگنال ها (ارسال ایمیل حذف پست)</h3>
<p>میخواهیم زمانیکه پست کاربری حذف میشود، به آن شخص ایمیلی با موضوع پست شما حذف شد ارسال شود.</p>
<blockquote>
<p>این عملیات پس از حذف پست صورت میگیرد بنابراین از سیگنال post_delete استفاده میکنیم.</p>
<p>از ماژول send_mail برای ارسال ایمیل استفاده میکنیم.</p>
</blockquote>
<p><code>app directory/signals.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_delete</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Post</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">author</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;deleted post&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;your post: &#39;post-id:</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has been deleted&quot;</span>

    <span class="n">send_mail</span><span class="p">(</span>
        <span class="n">subject</span><span class="p">,</span>
        <span class="n">message</span><span class="p">,</span>
        <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
        <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># structure of send_mail module:</span>
    <span class="c1"># send_mail(subject, message, settings.EMAIL_HOST_USER, [user.email])</span>
</pre></div>

<h3 id="khr-b-message-jngw">کار با message جنگو</h3>
<p>از message برای نمایش پیام های مختلف به کاربر استفاده میکنیم.</p>
<p><strong>برای استفاده از آن لازم است مواردی را چک کنیم:</strong></p>
<p>بررسی کنیم که تنظیمات message در settings.py وجود داشته باشند. / لازم نیست ما چیزی اضافه کنیم.</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

<p><strong>استفاده از message در view:</strong></p>
<p>قبل از هر چیزی باید آنرا ایمپورت کنیم:</p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
</pre></div>

<p>حالا هرجا لازم داریم پیامی نمایش داده شود، از ماژول messages استفاده میکنیم.</p>
<blockquote>
<p><strong>message چهار نوع مختلف دارد:</strong></p>
<p>1- <strong>info:</strong> برای اطلاع رسانی به کاربر(نمایش یکسری اطلاعات.)</p>
<p>2- <strong>warning:</strong> برای نمایش اخطار و هشدارها</p>
<p>3- <strong>success:</strong> نمایش پیام موفقیت آمیز بودن عملکردی.</p>
<p>4- <strong>error:</strong> نمایش خطا ها</p>
</blockquote>
<p><strong>شیوه استفاده از ماژول messages:</strong></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">messages</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;our message&quot;</span><span class="p">)</span>

<span class="c1"># examples:</span>
<span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;test text for info.&quot;</span><span class="p">)</span>
<span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;test text for warning!&quot;</span><span class="p">)</span>
<span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;test text for success.&quot;</span><span class="p">)</span>
<span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;test text for error!&quot;</span><span class="p">)</span>
</pre></div>

<p><strong>خب بریم یک مثال از messages ببینیم:</strong></p>
<p>قبلا برای نمایش پیام "ارسال تیکت" به کاربر از متغیر sent استفاده کرده و متن را در تمپلیت نوشته بودیم، ولی این بار از پکیج messages برای نمایش پیام استفاده میکنیم و پیام را در view مینویسیم.</p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>

<span class="k">def</span> <span class="nf">ticket</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TicketForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>

            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sender: </span><span class="si">{</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;email: </span><span class="si">{</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;content: </span><span class="si">{</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">send_mail</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">from_email</span><span class="o">=</span><span class="s1">&#39;sender@gmail.com&#39;</span><span class="p">,</span>
                <span class="n">recipient_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;recipient@gmail.com&#39;</span><span class="p">],</span>
                <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># :نمایش پیام دلخواه به کاربر</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;your ticket has been sent&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;social:index&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TicketForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;forms/ticket.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</pre></div>

<p>به این ترتیب پس از ارسال موفقیت آمیز تیکت به ادمین پیام نمایش داده میشود.</p>
<p><strong>نمایش message در تمپلیت:</strong></p>
<p><strong>نکته:</strong> متغیر messages در تمپلیت شناخته شده هست و نیازی به ارسال آن توسط context نیست.</p>
<blockquote>
<p>متغیر messages شامل تمام پیام های ارسال از view مربوطه میباشد(ممکن است در یک view برای بخش های مختلف پیام داشته باشیم.)، بنابراین باید روی آن حلقه بزنیم.</p>
</blockquote>
<p><code>templates/forms/ticket.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">            &lt;li class=&quot;</span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">message.tags</span> <span class="cp">%}{{</span> <span class="nv">message.tags</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="x"> </span>
<span class="x">            &lt;/li&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">    &lt;/ul&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- متد tags برای message نوع آن پیام را برمیگرداند. / (info, warning, success, error)</p>
<p>2- در اینجا از متد tags استفاده کرده تا برای هر نوع پیام یک کلاس مجزا مشخص کنیم؛ (برای اینکه به هر یک از انواع پیام ها استایل  خاص بدهیم.)</p>
<h3 id="khr-b-debug-toolbar-jngw">کار با debug toolbar جنگو</h3>
<p><strong>پکیج یا ابزار django-debug-toolbar:</strong> یک ابزار مفید برای توسعه‌دهندگان Django است که به شما کمک می‌کند تا عملکرد و رفتار اپلیکیشن Django خود را بهتر درک کنید. این ابزار به صورت یک نوار ابزار در رابط کاربری شما نمایش داده می‌شود و اطلاعات مفیدی در مورد درخواست‌ها و پاسخ‌ها، پایگاه داده، کش، و سایر جنبه‌های برنامه‌تان ارائه می‌دهد. کاربردهای اصلی آن عبارتند از:</p>
<ol>
<li>
<p><strong>پروفایلینگ پایگاه داده:</strong> نمایش کوئری‌های SQL که در درخواست‌های مختلف اجرا می‌شوند و زمان اجرای هر یک از آن‌ها. این ویژگی به شناسایی و بهینه‌سازی کوئری‌های کند کمک می‌کند.</p>
</li>
<li>
<p><strong>زمان‌های پردازش درخواست:</strong> ارائه زمان صرف‌شده برای پردازش هر درخواست و زمان بارگذاری صفحات.</p>
</li>
<li>
<p><strong>اطلاعات کش:</strong> نمایش اطلاعات مربوط به کش و نحوه استفاده از آن.</p>
</li>
<li>
<p><strong>اطلاعات در مورد Context:</strong> نمایش متغیرهای context که به قالب‌ها ارسال می‌شوند.</p>
</li>
<li>
<p><strong>اطلاعات درباره Cache و Middleware:</strong> نمایش اطلاعات در مورد استفاده از کش و middlewareها.</p>
</li>
<li>
<p><strong>مدیریت خطاها:</strong> ارائه اطلاعات دقیق‌تر در مورد خطاها و استثناها که در زمان توسعه مفید است.</p>
</li>
</ol>
<p><strong>نصب پکیج django-debug-toolbar:</strong></p>
<ol> 

<li><strong>نصب کتابخانه django-debug-toolbar:</strong></li>

<p><code>Terminal</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>pip install django-debug-toolbar
</pre></div>


<li><strong>بررسی پیش نیازها و الزامات:</strong></li>

<strong>اول:</strong>

اطمینان حاصل کنید که 'django.contrib.staticfiles' در تنظیمات INSTALLED_APPS شما وجود دارد:

<p><code>project directory/settings.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s2">&quot;django.contrib.staticfiles&quot;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s2">&quot;static/&quot;</span>
</pre></div>


<strong>دوم:</strong>

بررسی کنید که تنظیمات TEMPLATES شامل یک backend از نوع DjangoTemplates با گزینه APP_DIRS برابر با True باشد:

<p><code>project directory/settings.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.template.backends.django.DjangoTemplates&quot;</span><span class="p">,</span>
        <span class="s2">&quot;APP_DIRS&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># ...</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<li><strong>افزودن app آن به اپ های پروژه:</strong></li>

<p><code>project directory/settings.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s2">&quot;debug_toolbar&quot;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>
</pre></div>


<li><strong>افزودن URL آن به urlهای پروژه:</strong></li>

<p>URLهای django-debug-toolbar را به URLconf پروژه خود اضافه کنید:</p>

<p><code>project directory/urls.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;__debug__/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;debug_toolbar.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<li><strong>اضافه کردن middleware آن:</strong></li>

<p>Debug Toolbar به‌طور عمده در middleware پیاده‌سازی شده است. آن را به تنظیمات MIDDLEWARE اضافه کنید:</p>

<p><code>project directory/settings.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;debug_toolbar.middleware.DebugToolbarMiddleware&quot;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>
</pre></div>


<p><strong>هشدار:</strong> ترتیب MIDDLEWARE مهم است. این middleware باید تا حد امکان در بالای لیست قرار گیرد، اما باید بعد از middlewareهایی که محتویات پاسخ را رمزگذاری می‌کنند، مانند GZipMiddleware، قرار گیرد. / در حال حاضر آنرا دربالاترین بخش قرار میدهیم.</p>

<li><strong>پیکربندی IPs داخلی:</strong></li>

<p>Debug Toolbar فقط در صورتی نمایش داده می‌شود که آدرس IP شما در تنظیمات INTERNAL_IPS در Django لیست شده باشد. برای توسعه محلی، باید "127.0.0.1" را به INTERNAL_IPS اضافه کنید:</p>

<p><code>project directory/settings.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INTERNAL_IPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


</ol>

<blockquote>
<p>پس از این تنظیمات پنل مدیریتی آن به پروژه اضافه خواهد شد، میتوان از آن در صفحات مختلف استفاده کرد.</p>
</blockquote>
<p><strong>دستور debugsqlshell:</strong></p>
<p>دستور debugsqlshell در Django برای شروع یک شل تعاملی Python طراحی شده است که مشابه دستور مدیریت shell پیش‌فرض Django است. با این تفاوت که این شل، هر بار که یک فراخوانی ORM منجر به یک کوئری دیتابیس شود، به زیبایی نتایج SQL آنرا هم را در شل نمایش می‌دهد.</p>
<blockquote>
<p><span class="en-text">python manage.py debugsqlshell</span></p>
</blockquote>
<h3 id="yjd-khshn-action-dr-pnl-dmyn">ایجاد اکشن (action) در پنل ادمین</h3>
<blockquote>
<p>به صورت پیشفرض فقط اکشن delete وجود دارد.</p>
</blockquote>
<p>میخواهیم اکشن هایی پیاده سازی کنیم که پست ها را active و یا deactive میکند؛ برای این کار لازم است تا یک <strong>فیلد بولین</strong> برای اکتیو یا دی اکتیو بودن پست ها به مدل Post اضافه کنیم.</p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">taggit.managers</span> <span class="kn">import</span> <span class="n">TaggableManager</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_posts&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="c1"># date</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># tags field</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">TaggableManager</span><span class="p">()</span>

    <span class="c1"># likes field</span>
    <span class="n">likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;liked_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># total number of likes field</span>
    <span class="n">total_likes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># saved field</span>
    <span class="n">saved_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;saved_posts&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># ordering &amp; indexing</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-total_likes&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
</pre></div>

<p>به صورت پیشفرض مقدار فیلد active را True قرار میدهیم، یعنی پست ها فعال هستند.</p>
<p><strong>ایجاد اکشن:</strong></p>
<p>اکشن ها را در فایل پایتونی admin.py ایجاد میکنیم.</p>
<ul>
<li>
<p>برای هر اکشن یک تابع ایجاد میکنیم.</p>
<ul>
<li>اسم تابع را به صورت <span class="en-text">def make_name() </span> مشخص میکنند ولی با این حال نام گذاری دلخواه است.</li>
</ul>
</li>
<li>
<p>برای توابع، پارامتر های (modeladmin, request, queryset) را مشخص میکنیم.</p>
</li>
</ul>
<blockquote>
<p>آبجکت هایی که در پنل ادمین انتخاب میکنیم، در پارامتر queryset قرار میگیرند.</p>
</blockquote>
<p>داخل بدنه تابع یک متغیر ایجاد میکنیم؛ به صورت رایج اسم متغیر result  هست.</p>
<blockquote>
<p>متغیر result تعداد آبجکت هایی که انتخاب شده اند را برمیگرداند.</p>
</blockquote>
<p><code>app directory/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">deactivate_post</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

<p>با دستور بالا مشخص میکنیم که برای کوئری ست های انتخاب شده مقدار یک فیلد را تغییر بده(آپدیت کن).</p>
<p><strong>نمایش پیام پس از انجام اکشن:</strong></p>
<p>این ساختار در بدنه تابع نوشته میشود.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;our message&quot;</span><span class="p">)</span>
</pre></div>

<p><code>app directory/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">deactivate_post</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Post deactivated&#39;</span>
    <span class="k">elif</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Posts deactivated&#39;</span>

    <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></div>

<blockquote>
<p>برای نمایش اصولی تر متن که اگر تعداد بیشتر از 1 بود s جمع داشته باشد از این شرط استفاده شده و چیز خاص و ضروری نیست.</p>
</blockquote>
<p><strong>معرفی اکشن به model admin آن:</strong></p>
<p>پس از نوشتن اکشن باید آنرا به مدل ادمین مربوطه معرفی کنیم، از اتریبیوت کلاس actions استفاده کرده و اسم اکشن ها را در لیست آن مشخص میکنیم.</p>
<p><code>app directory/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># ——————————————————————————— Actions ———————————————————————————</span>

<span class="c1"># ------------- deactivation action -------------</span>
<span class="k">def</span> <span class="nf">deactivate_post</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Post deactivated&#39;</span>
    <span class="k">elif</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Posts deactivated&#39;</span>

    <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="c1"># rename action</span>
<span class="n">deactivate_post</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Deactivate&#39;</span>

<span class="c1"># ------------- activation action -------------</span>
<span class="k">def</span> <span class="nf">activate_post</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Posts activated&#39;</span>
    <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> Post activated&#39;</span>

    <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="c1"># rename action</span>
<span class="n">activate_post</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Activate&#39;</span>


<span class="c1"># ————————————————————————— Model Admins —————————————————————————</span>

<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">,</span> <span class="s1">&#39;-author&#39;</span><span class="p">]</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">]</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">deactivate_post</span><span class="p">,</span> <span class="n">activate_post</span><span class="p">]</span>
</pre></div>

<p><strong>نکته:</strong> اگر بخواهیم اسم مستعار برای اکشن های خود مشخص کنیم(اسمی که در پنل ادمین نشان داده میشود)؛ <strong>بیرون از تابع و بعد از آن</strong> اسم مستعار را مشخص میکنیم.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">function_name</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;اسم دلخواه&quot;</span>
</pre></div>

<h3 id="tmrynt-fsl-nhm-mhm">تمرینات فصل نهم (مهم)</h3>
<h4><strong>T1- تیکتی که کاربر ارسال میکند، توسط ادمین پاسخ داده شود؛ صفحه ای وجود داشته باشد که تیکت و پاسخ آن قابل مشاهده باشد:</strong></h4>
<ol>

<li><strong>لازم است تا برای ticket و reply_to_ticket مدل هایی ایجاد کنیم:</strong></li>

<p><code>app directory/models.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Ticket</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;tickets&#39;</span><span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="n">is_opened</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">}</span>

<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="k">class</span> <span class="nc">Reply</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Ticket</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;reply_to_ticket&#39;</span><span class="p">)</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="n">responded_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-responded_at&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-responded_at&#39;</span><span class="p">])]</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ticket&#39;</span><span class="p">,</span> <span class="s1">&#39;reply&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span>
</pre></div>


<li><strong>ایجاد فرم برای تیکت و پاسخ به تیکت:</strong></li>

<p><code>app directory/forms.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">TicketForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Ticket</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ReplyForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Reply</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span>
</pre></div>


<li><strong>ایجاد URL برای تیکت و پاسخ تیکت:</strong></li>

<p><code>app directory/urls.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;ticket/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ticket&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;reply/&lt;int:ticket_id&gt;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">reply_to_ticket</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;reply_ticket&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<li><strong>ایجاد view برای ارسال تیکت:</strong></li>

<p>تیکت ارسال شده هم به ایمیل ادمین ارسال میشود و هم در دیتابیس ذخیره میشود.</p>

<p><code>app directory/views.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">ticket</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TicketForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="n">ticket_obj</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ticket_obj</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">ticket_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">cd</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sender: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;content: </span><span class="si">{</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;email: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="se">\n\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;reply to ticket: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/reply/</span><span class="si">{</span><span class="n">ticket_obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="n">send_mail</span><span class="p">(</span>
                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="s1">&#39;sender@gmail.com&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;admin@gmail.com&#39;</span><span class="p">],</span>
                <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;your ticket has been sent&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TicketForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;forms/ticket_form.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</pre></div>


<strong>توضیحات:</strong>

<p>
1- اطلاعات فرم تیکت را دریافت کرده و در صورت معتبر بودن داده ها آنرا در دیتابیس ذخیره میکنیم.
</p>

<p>
2- حالا باید متن ایمیل به ادمین را آماده کنیم، در متن ایمیل؛ اسم فرستنده تیکت(کاربر وبسایت) متن تیکتی که ارسال کرده است، ایمیل کاربر و لینکی که ادمین را به صفحه پاسخ به تیکت ها هدایت میکند را داریم.
</p>

<blockquote><p><span class="rtl-text">
برای صفحه "پاسخ به تیکت" یک url ایجاد کردیم <span class="en-text">(reply/&lt;int:ticket_id&gt;/)</span>؛ برای آیدی تیکت از متغیر ticket_obj استفاده میکنیم، ولی نکته مهم این هست که باید آدرس url کامل و دقیق باشه، متد <span class="en-text">build_absolute_uri()</span> آدرس دقیق را به ما میدهد.(<span class="en-text">http://host/reply-to-ticket/&lt;ticket_id&gt;</span>)
</span></p></blockquote>

<li><strong>ایجاد view برای پاسخ به تیکت:</strong></li>

<p><code>app directory/views.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@staff_member_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">reply_to_ticket</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ticket_id</span><span class="p">):</span>
    <span class="n">sent_ticket</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Ticket</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">ticket_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReplyForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">reply_obj</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reply_obj</span><span class="o">.</span><span class="n">ticket</span> <span class="o">=</span> <span class="n">sent_ticket</span>
            <span class="n">reply_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;reply has been sent to user.&quot;</span><span class="p">)</span>

            <span class="n">sent_ticket</span><span class="o">.</span><span class="n">is_open</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sent_ticket</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReplyForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;forms/replies.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;ticket&quot;</span><span class="p">:</span> <span class="n">sent_ticket</span><span class="p">})</span>
</pre></div>


<strong>توضیحات:</strong>

<p>
1- تیکتی که ادمین به آن پاسخ میدهد را از دیتابیس دریافت میکنیم.
</p>

<p>
2- پاسخی که ادمین ثبت کرده است را از فرم دریافت کرده و به همراه، این تیکتی که مشخص کردیم؛ اطلاعات را در دیتابیس ذخیره میکنیم.
</p>

<p>
3- با استفاده از ماژول messages، پیغام موفقیت آمیز بودن را به تمپلیت ارسال میکنیم.
</p>

<p>
4- هر تیکتی یک فیلد برای مشخص کردن باز و یا بسته بودن آن دارد، پس از ثبت پاسخ ادمین تیکت بسته میشود بنابراین؛ آن تیکت را صدا زده و فیلد is_open را آپدیت میکنیم و برای ثبت در دیتابیس از متد <span class="en-text">save()</span> استفاده میکنیم.
</p>

<li><strong>ایجاد URL برای نمایش لیست تیکت ها و پاسخ آنها</strong></li>

<p><code>app directory/urls.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;tickets_list/&#39;</span><span class="p">,</span> <span class="n">tickets_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tickets_list&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<li><strong>ایجاد view برای نمایش لیست تیکت ها و پاسخ آنها</strong></li>

<p><code>app directory/views.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">tickets_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
        <span class="n">tickets</span> <span class="o">=</span> <span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tickets</span> <span class="o">=</span> <span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/ticket_list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;tickets&#39;</span><span class="p">:</span> <span class="n">tickets</span><span class="p">})</span>
</pre></div>


<li><strong>ایجاد URL برای نمایش جزئیات تیکت:</strong></li>

<p><code>app directory/urls.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;ticket/&lt;int:ticket_id&gt;&#39;</span><span class="p">,</span> <span class="n">ticket_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ticket_detail&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<li><strong>ایجاد view برای نمایش جزئیات تیکت:</strong></li>

<p><code>app directory/views.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">ticket_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ticket_id</span><span class="p">):</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Ticket</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">ticket_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;social/ticket_detail.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ticket&quot;</span><span class="p">:</span> <span class="n">ticket</span><span class="p">})</span>
</pre></div>


<li><strong>ایجاد قالب های html:</strong></li>

<strong>1- ticket_form.html:</strong>

<p><code>templates/forms/ticket_form.html</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;create ticket&lt;/h2&gt;</span>

<span class="x">&lt;form method=&quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>

<span class="x">    &lt;input type=&quot;text&quot; name=&quot;subject&quot; placeholder=&quot;Title&quot;&gt;</span>

<span class="x">    &lt;textarea name=&quot;content&quot; cols=&quot;20&quot; rows=&quot;10&quot; placeholder=&quot;Your Content...&quot;&gt;&lt;/textarea&gt;</span>

<span class="x">    &lt;input type=&quot;submit&quot; value=&quot;Send&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>

<span class="cp">{{</span> <span class="nv">form.errors</span> <span class="cp">}}</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">            &lt;li class=&quot;</span><span class="cp">{{</span> <span class="nv">message.tags</span> <span class="o">|</span> <span class="nf">default</span><span class="s2">:&quot;&quot;</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="x"> </span>
<span class="x">            &lt;/li&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">    &lt;/ul&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>


<strong>2- replies.html:</strong>

<p><code>templates/forms/replies.html</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;Reply to Ticket&lt;/h2&gt;</span>

<span class="x">&lt;div class=&quot;ticket&quot;&gt;</span>
<span class="x">    User: </span><span class="cp">{{</span> <span class="nv">ticket.user</span> <span class="cp">}}</span><span class="x">&lt;br&gt;</span>
<span class="x">    Email: </span><span class="cp">{{</span> <span class="nv">ticket.email</span> <span class="cp">}}</span>
<span class="x">    &lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="x">    title: </span><span class="cp">{{</span> <span class="nv">ticket.subject</span> <span class="cp">}}</span><span class="x">&lt;br&gt;&lt;br&gt;</span>
<span class="x">    content: </span><span class="cp">{{</span> <span class="nv">ticket.body</span> <span class="cp">}}</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;div class=&quot;reply&quot;&gt;</span>
<span class="x">    &lt;form method=&quot;post&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="x">        </span>
<span class="x">        &lt;textarea name=&quot;reply&quot; id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; placeholder=&quot;reply to ticket&quot;&gt;&lt;/textarea&gt;</span>
<span class="x">        &lt;br&gt;&lt;br&gt;</span>
<span class="x">        &lt;input type=&quot;submit&quot; value=&quot;send reply&quot;&gt;</span>
<span class="x">    &lt;/form&gt;</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;div class=&quot;messages&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">&lt;/div&gt;</span>

<span class="cp">{{</span> <span class="nv">form.errors</span> <span class="cp">}}</span>
</pre></div>


<strong>3- ticket_list.html:</strong>

<p><code>templates/social/ticket_list.html</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;tickets list&lt;/h2&gt;</span>

<span class="x">&lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">ticket</span> <span class="k">in</span> <span class="nv">tickets</span> <span class="cp">%}</span>
<span class="x">        &lt;li&gt;</span>
<span class="x">            &lt;strong&gt;</span><span class="cp">{{</span> <span class="nv">ticket.subject</span> <span class="cp">}}</span><span class="x">&lt;/strong&gt; - </span><span class="cp">{{</span> <span class="nv">ticket.created_at</span> <span class="cp">}}</span>
<span class="x">            &lt;br&gt;</span>
<span class="x">            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:ticket_detail&#39;</span> <span class="nv">ticket.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">ticket.content</span> <span class="o">|</span> <span class="nf">truncatewords</span><span class="o">:</span><span class="m">10</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">            &lt;br&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">ticket.is_opened</span> <span class="cp">%}</span>
<span class="x">                &lt;em&gt;it&#39;s open&lt;/em&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">                &lt;em&gt;it closed&lt;/em&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/ul&gt;</span>
</pre></div>


<strong>4- ticket_detail.html:</strong>

<p><code>templates/social/ticket_detail.html</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;ticket: </span><span class="cp">{{</span> <span class="nv">ticket.subject</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>

<span class="x">&lt;strong&gt;Body:&lt;/strong&gt; </span><span class="cp">{{</span> <span class="nv">ticket.content</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span>
<span class="x">&lt;br&gt;</span>
<span class="cp">{{</span> <span class="nv">ticket.created_at</span> <span class="cp">}}</span>
<span class="x">&lt;hr&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">ticket.is_opened</span> <span class="cp">%}</span>
<span class="x">    &lt;em&gt;it&#39;s open&lt;/em&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">    &lt;em&gt;it closed&lt;/em&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">&lt;h2&gt;Reply:&lt;/h2&gt;</span>

<span class="x">&lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">response</span> <span class="k">in</span> <span class="nv">ticket.reply_to_ticket.all</span> <span class="cp">%}</span>
<span class="x">        &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">response.reply</span> <span class="cp">}}</span><span class="x"> &lt;br&gt;&lt;hr&gt; </span><span class="cp">{{</span> <span class="nv">response.responded_at</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/ul&gt;</span>
</pre></div>


</ol>

<hr />
<h4><strong>T2- نمایش لیست followers با لیست following با کلیک روی آنها:</strong></h4>
<p>میخواهیم برای کاربرها جایی که تعداد following و followers را نشان میدهد، به آنها لینک بدهیم تا به صفحه جدید رفته و در آن لیست followers یا لیست following آن کاربر را نشان دهد.</p>
<p><strong>ایجاد URL برای لیست following و followers:</strong></p>
<p><code>app directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user_contacts/&lt;str:username&gt;/&lt;str:rel&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">user_contacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_contacts&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- با استفاده از username کاربری که در صفحه وی هستیم، و میخواهیم لیست followers یا following را ببینیم را از دیتابیس دریافت میکنیم.</p>
<p>2- <strong>متغیر rel:</strong> رابطه را مشخص میکند، اینکه میخواهیم لیست following ویا followers را ببینیم.</p>
<p><strong>ایجاد view برای لیست following و followers:</strong></p>
<p><code>app directory/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">user_contacts</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rel</span> <span class="o">==</span> <span class="s1">&#39;followers&#39;</span><span class="p">:</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">rel</span> <span class="o">==</span> <span class="s1">&#39;following&#39;</span><span class="p">:</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">contacts</span><span class="p">,</span>
        <span class="s1">&#39;rel&#39;</span><span class="p">:</span> <span class="n">rel</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;user/user_list.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p><strong>ایجاد لینک برای following و followers:</strong></p>
<p><code>templates/user/user_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;!-- ------------ following و followers نمایش تعداد-------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">with</span> <span class="nv">total_followers</span><span class="o">=</span><span class="nv">user.followers.count</span> <span class="nv">total_following</span><span class="o">=</span><span class="nv">user.following.count</span> <span class="cp">%}</span>

<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_contacts&#39;</span> <span class="nv">user.username</span> <span class="s2">&quot;following&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">        &lt;strong&gt;following:&lt;/strong&gt;</span>
<span class="x">    &lt;/a&gt;</span>
<span class="x">     &lt;span class=&quot;following-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_following</span> <span class="cp">}}</span><span class="x"> Following&lt;/span&gt;</span>

<span class="x">    &lt;br&gt;&lt;br&gt;</span>

<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_contacts&#39;</span> <span class="nv">user.username</span> <span class="s2">&quot;followers&quot;</span>  <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">        &lt;strong&gt;followers:&lt;/strong&gt;</span>
<span class="x">    &lt;/a&gt;</span>
<span class="x">     &lt;span class=&quot;followers-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="cp">}}</span><span class="x"> Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>

<span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
</pre></div>

<p><strong>کد کامل:</strong></p>
<p><code>templates/user/user_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش تصویر پروفایل --------------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.profile_image.url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">        &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">150</span><span class="nv">x0</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile_image&quot;&gt;</span>
<span class="x">    &lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">    &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;default_image&quot; width=&quot;150px&quot;&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">&lt;!-- --------------------- نمایش اسم کاربر --------------------- --&gt;</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>
<span class="x">hello I&#39;m </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="o">|</span> <span class="nf">default</span><span class="o">:</span><span class="nv">user.username</span> <span class="cp">}}</span>
<span class="x">&lt;br&gt;&lt;br&gt;</span>

<span class="x">&lt;!-- --------------------- دکمه Follow ----------------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user</span> <span class="o">!=</span> <span class="nv">request.user</span> <span class="cp">%}</span>
<span class="x">    &lt;button class=&quot;follow-button&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user</span> <span class="k">in</span> <span class="nv">user.followers.all</span> <span class="cp">%}</span>
<span class="x">            UnFollow</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">            Follow</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">    &lt;/button&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">&lt;hr&gt;</span>

<span class="x">&lt;!-- ------------ following و followers نمایش تعداد-------------- --&gt;</span>
<span class="cp">{%</span> <span class="k">with</span> <span class="nv">total_followers</span><span class="o">=</span><span class="nv">user.followers.count</span> <span class="nv">total_following</span><span class="o">=</span><span class="nv">user.following.count</span> <span class="cp">%}</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_contacts&#39;</span> <span class="nv">user.username</span> <span class="s2">&quot;following&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;&lt;strong&gt;following:&lt;/strong&gt;&lt;/a&gt; &lt;span class=&quot;following-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_following</span> <span class="cp">}}</span><span class="x"> Following&lt;/span&gt;</span>
<span class="x">    &lt;br&gt;&lt;br&gt;</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_contacts&#39;</span> <span class="nv">user.username</span> <span class="s2">&quot;followers&quot;</span>  <span class="cp">%}</span><span class="x">&quot;&gt;&lt;strong&gt;followers:&lt;/strong&gt;&lt;/a&gt; &lt;span class=&quot;followers-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="cp">}}</span><span class="x"> Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>

<span class="x">&lt;!-- ----------------- نمایش اطلاعات اضافی کاربر ----------------- --&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.bio</span> <span class="cp">%}</span><span class="x">Bio: </span><span class="cp">{{</span> <span class="nv">user.bio</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.job</span> <span class="cp">%}</span><span class="x">Job: </span><span class="cp">{{</span> <span class="nv">user.job</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.birth_date</span> <span class="cp">%}</span><span class="x">Date of Birth: </span><span class="cp">{{</span> <span class="nv">user.birth_date</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>

<span class="x">&lt;!-- --------------------- ajax ساختار کد ----------------------- --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>


<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function (){</span>
<span class="x">        $(&#39;.follow-button&#39;).click(function (){</span>
<span class="x">            let followButton = $(this);</span>

<span class="x">            $.ajax({</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;social:user_follow&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                data: {&#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;, &#39;user_id&#39;: &#39;</span><span class="cp">{{</span><span class="nv">user.id</span><span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                success: function(response){</span>
<span class="x">                    if (response.followed){</span>
<span class="x">                        followButton.text(&#39;UnFollow&#39;);</span>
<span class="x">                    } else {</span>
<span class="x">                        followButton.text(&#39;Follow&#39;);</span>
<span class="x">                    }</span>
<span class="x">                    $(&#39;.followers-count&#39;).text(response.followers_count + &#39;Followers</span><span class="cp">{{</span> <span class="nv">total_followers</span> <span class="o">|</span> <span class="nf">pluralize</span> <span class="cp">}}</span><span class="x">&#39;);</span>
<span class="x">                    $(&#39;.following-count&#39;).text(response.following_count + &#39;Following&#39;);</span>
<span class="x">                }</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    })</span>
<span class="x">&lt;/script&gt;</span>
</pre></div>

<p><strong>تغییر تمپلیت user_list.html:</strong></p>
<p>برای نمایش لیست following با لیست followers از همان تمپلیت user_list استفاده میکنیم، البته میتوان تمپلیت مجزایی نیز استفاده کرد.</p>
<p><code>templates/user/user_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">thumbnail</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="x">&lt;h1&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">rel</span> <span class="cp">%}</span>
<span class="x">        &lt;!-- following or followers --&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">rel</span> <span class="cp">}}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        All Users</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="x">&lt;/h1&gt;</span>

<span class="x">&lt;!-- ——————————————————————— user&#39;s list ——————————————————————— --&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span>
<span class="x">    &lt;!-- ---------  نمایش تصویر پروفایل  --------- --&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.profile_image</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">thumbnail</span> <span class="nv">user.profile_image</span> <span class="m">100</span><span class="nv">x100</span> <span class="nv">quality</span><span class="o">=</span><span class="m">80</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;profile-image&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;images/profile/avatar.png&#39;</span> <span class="cp">%}</span><span class="x">&quot; alt=&quot;avatar&quot;&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">    &lt;!-- ---------- نمایش اسم کاربر ---------- --&gt;</span>
<span class="x">    &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">user.get_absolute_url</span> <span class="cp">}}</span><span class="x">&quot;&gt; </span><span class="cp">{{</span> <span class="nv">user.get_full_name</span> <span class="cp">}}</span><span class="x"> &lt;/a&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<hr />
<h4><strong>T3- قابلیت اشتراک گذاری برای پست ها:</strong></h4>
<blockquote>
<p>برای قابلیت اشتراک گذاری از پکیج <strong>django-social-share</strong> استفاده میکنیم.</p>
</blockquote>
<ol>
<li>
<p>نصب پکیج <strong>django-social-share</strong>:</p>
<p><code>terminal</code></p>
<p><div class="code-box">
    <div class="code-info">
        <button class="copy-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
            <span>Copy code</span>
        </button>
        <span class="language">terminal</span>
    </div>
<pre><span></span>pip install django-social-share
</pre></div></p>
</li>
<li>
<p>پیکربندی ها و تنظیمات لازم:</p>
<p>1- پس از نصب، نیاز است که این پکیج را به لیست اپلیکیشن‌های نصب‌شده اضافه کنید:</p>
<p><code>project directory/settings.py</code></p>
<p><div class="code-box">
    <div class="code-info">
        <button class="copy-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
            <span>Copy code</span>
        </button>
        <span class="language">python</span>
    </div>
<pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;django_social_share&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div></p>
<p>2- همچنین باید django.template.context_processors.request را به لیست context_processors اضافه کنید تا تگ‌ها بتوانند از scheme  و host_name به طور صحیح استفاده کنند:</p>
<p><code>project directory/settings.py</code></p>
<p><div class="code-box">
    <div class="code-info">
        <button class="copy-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
            <span>Copy code</span>
        </button>
        <span class="language">python</span>
    </div>
<pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">&#39;templates&#39;</span><span class="p">]</span>
        <span class="p">,</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="c1"># ...</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div></p>
</li>
</ol>
<blockquote>
<p><strong>براساس توضیحات داکیومنت django-social-share:</strong></p>
<p>در بیشتر موارد، اشتراک‌گذاری کار نخواهد کرد اگر از localhost استفاده کنید یا دامنه شما از اینترنت عمومی قابل دسترسی نباشد. برای تست در محیط توسعه محلی، می‌توانید از سرویس‌هایی مانند ngrok استفاده کنید و دامنه Site instance خود را به hostname ارائه شده توسط ngrok تنظیم کنید.</p>
</blockquote>
<p><strong>شیوه استفاده:</strong></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">social_share</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">post_to_facebook</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_gplus</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_twitter</span> <span class="o">&lt;</span><span class="nv">text_to_post</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_linkedin</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">send_email</span> <span class="o">&lt;</span><span class="nv">subject</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">text_to_post</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_reddit</span> <span class="o">&lt;</span><span class="nv">text_to_post</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_telegram</span> <span class="o">&lt;</span><span class="nv">text_to_post</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span>  <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_whatsapp</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">save_to_pinterest</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span>  <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">copy_to_clipboard</span> <span class="o">&lt;</span><span class="nv">object_or_url</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_text</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">link_class</span><span class="o">&gt;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">add_pinterest_script</span> <span class="cp">%}</span><span class="x"> // Required for save_to_pinterest. Add to the end of body tag.</span>
<span class="cp">{%</span> <span class="k">add_copy_script</span> <span class="cp">%}</span><span class="x"> // Required for copy_to_clipboard. Add to the end of body tag.</span>
</pre></div>

<p>هر تگ قالب django-social-share یک یا چند پارامتر می‌پذیرد. این پارامترها می‌توانند شامل موارد زیر باشند:</p>
<ol>
<li>
<p><strong>متغیر &lt;object_or_url&gt;:</strong> این پارامتر می‌تواند یک آبجکت مدل جنگو یا یک URL باشد. اگر یک آبجکت مدل را پاس بدهید، از متد get_absolute_url آن استفاده می‌شود. اگر از پکیج django_bitly استفاده کنید، URL کوتاه شده نیز تولید می‌شود.</p>
</li>
<li>
<p><strong>متغیر &lt;text_to_post&gt;:</strong> متنی که می‌خواهید در پست به اشتراک گذاشته شود. می‌تواند شامل کدهای قالب جنگو باشد.</p>
</li>
<li>
<p><strong>متغیر &lt;link_text&gt;:</strong> متن لینک که به عنوان متن anchor در تگ &lt;a&gt; استفاده می‌شود. اگر مشخص نشود، مقادیر پیش‌فرض مانند 'Post to Facebook' یا 'Post to Twitter' استفاده می‌شوند. / در مثال زیر آیکون شبکه های اجتماعی را نمایش میدهیم.</p>
</li>
<li>
<p><strong>متغیر &lt;link_class&gt;:</strong> کلاس‌های CSS که به لینک &lt;a&gt; اعمال می‌شوند. می‌توانید از آن برای استایل‌دهی به لینک‌های اشتراک‌گذاری استفاده کنید. / مثلا اگر مقدار social برایش مشخص کنیم، اسم کلاس تگ a ایجاد شده social خواهد بود.</p>
</li>
<li>
<p><strong>متغیر &lt;subject&gt;:</strong> موضوع ایمیل (برای تگ send_email). این می‌تواند شامل کدهای قالب جنگو نیز باشد.</p>
</li>
</ol>
<p><strong>بریم چند نمونه ببینیم:</strong></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">social_share</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">post_to_facebook</span> <span class="nv">object_or_url</span> <span class="s1">&#39;&lt;i class=&quot;fa-brands fa-facebook&quot;&gt;&lt;/i&gt;&#39;</span> <span class="s2">&quot;social&quot;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_twitter</span> <span class="s1">&#39;post from django&#39;</span> <span class="nv">object_or_url</span> <span class="s1">&#39;&lt;i class=&quot;fa-brands fa-x-twitter&quot;&gt;&lt;/i&gt;&#39;</span> <span class="s2">&quot;social&quot;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_telegram</span> <span class="s1">&#39;post from django&#39;</span> <span class="nv">object_or_url</span> <span class="s1">&#39;&lt;i class=&quot;fa-brands fa-telegram&quot;&gt;&lt;/i&gt;&#39;</span> <span class="s2">&quot;social&quot;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">post_to_whatsapp</span> <span class="nv">object_or_url</span> <span class="s1">&#39;&lt;i class=&quot;fa-brands fa-whatsapp&quot;&gt;&lt;/i&gt;&#39;</span> <span class="s2">&quot;social&quot;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">copy_to_clipboard</span> <span class="nv">object_or_url</span> <span class="s1">&#39;copy to clipboard&#39;</span> <span class="cp">%}</span>
</pre></div>

<blockquote>
<p>تمامی فایل‌های قالب در مسیر django_social_share/templatetags/ قرار دارند که شامل قالب‌های اشتراک‌گذاری برای هر یک از شبکه‌های اجتماعی و ایمیل و کپی به کلیپ‌بورد می‌شوند. این قالب‌ها را می‌توانید بر اساس نیاز خود تغییر دهید و شخصی‌سازی کنید.</p>
</blockquote>
<hr />
<h4><strong>T4- ثبت فعالیت های اخیر کاربر:</strong></h4>
<p><strong>فعالیت اخیر کاربر؛</strong> طی 24 ساعت گذشته، کاربر چه افرادی را فالو کرده، چه افرادی وی را فالو کرده اند و همچنین پست های اخیری که لایک کرده را نمایش دهیم.</p>
<blockquote>
<p>برای نمایش فعالیت های اخیر کاربر (following, followers, پست هایی که اخیرا لایک و یا ذخیره کرده است)؛ باید آنها، فیلد زمان داشته باشند، اما در پروژه فعلی فقط following, followers دارای فیلد زمان هستند.</p>
</blockquote>
<hr />
<h4><strong>T5- ارسال کامنت با AJAX:</strong></h4>
<ol>

<li><strong>ایجاد مدل کامنت:</strong></li>

<p><code>app directory/models.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;post_comments&#39;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_comments&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
</pre></div>


<li><strong>ایجاد فرم کامنت:</strong></li>

<p><code>app directory/forms.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</pre></div>


<li><strong>ایجاد URL برای افزودن کامنت:</strong></li>

<p><code>app directory/urls.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;comments/&lt;int:post_id&gt;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add_comment</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add_comment&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<li><strong>تغییر view برای post_detail و ایجاد view برای افزدن کامنت:</strong></li>

<p><code>app directory/views.py</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">post_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

    <span class="c1"># for similar post&#39;s</span>
    <span class="n">post_tags_ids</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">similar_posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="n">post_tags_ids</span><span class="p">)</span>
    <span class="n">similar_posts</span> <span class="o">=</span> <span class="n">similar_posts</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">same_tags</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-same_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;-created&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># for comment</span>
    <span class="n">comment_form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">post_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span> 
        <span class="s1">&#39;similar_posts&#39;</span><span class="p">:</span> <span class="n">similar_posts</span><span class="p">,</span>
        <span class="s1">&#39;comment_form&#39;</span><span class="p">:</span> <span class="n">comment_form</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;social/post_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

<span class="c1"># ————————————————————————————————————————————————————————————————————————</span>
<span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                <span class="s1">&#39;comments_count&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">post_comments</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid data!&#39;</span><span class="p">})</span>
</pre></div>


<li><strong>تغییر تمپلیت post_detail-ارسال کامنت با ajax:</strong></li>

<p>ساختار کد post_detail.html طولانی هست، برای درک راحت تر فقط کد مربوط به کامنت را نمایش میدهیم؛ کدهای مربوط به کامنت بعد از پست های مشابه نوشته میشود.</p>

<p><code>templates/social/post_detail.html</code></p>

<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h3&gt;Comment Form&lt;/h3&gt;</span>

<span class="x">&lt;form id=&quot;comment-form&quot; method=&quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>

<span class="x">    </span><span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span><span class="x">&lt;br&gt;&lt;br&gt;</span>
<span class="x">    &lt;input type=&quot;submit&quot; value=&quot;send comment&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>

<span class="x">&lt;p class=&quot;comment-count&quot;&gt;تعداد کامنت‌ها: </span><span class="cp">{{</span> <span class="nv">comments.count</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">&lt;h3&gt;Comments List&lt;/h3&gt;</span>

<span class="x">&lt;div id=&quot;comments&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">comment</span> <span class="k">in</span> <span class="nv">comments</span> <span class="cp">%}</span>
<span class="x">        &lt;p&gt;User: </span><span class="cp">{{</span> <span class="nv">comment.user.username</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;div&gt;</span><span class="cp">{{</span> <span class="nv">comment.content</span> <span class="o">|</span> <span class="nf">linebreaks</span> <span class="cp">}}</span><span class="x"> - </span><span class="cp">{{</span> <span class="nv">comment.created_at</span> <span class="cp">}}</span><span class="x">&lt;/div&gt;</span>
<span class="x">        &lt;hr&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">        &lt;p&gt;هیچ کامنتی وجود ندارد.&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;!-- ————————————————————————— Scripts ————————————————————————— --&gt;</span>
<span class="x">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&lt;script&gt;</span>
<span class="x">    $(document).ready(function() {</span>
<span class="x">        $(&#39;#comment-form&#39;).submit(function(event) {</span>
<span class="x">            event.preventDefault(); // جلوگیری از ارسال فرم به صورت پیش‌فرض</span>

<span class="x">            let formData = $(this).serialize(); // دریافت داده‌های فرم</span>

<span class="x">            $.ajax({</span>
<span class="x">                url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;social:add_comment&quot;</span> <span class="nv">post.id</span> <span class="cp">%}</span><span class="x">&#39;, // آدرس view برای ارسال داده‌ها</span>
<span class="x">                type: &#39;POST&#39;,</span>
<span class="x">                data: formData,</span>
<span class="x">                success: function(response) {</span>
<span class="x">                    let commentUser = &#39;&lt;p&gt;&#39; + &#39;User: &#39; + response.user + &#39;&lt;/p&gt;&#39;;</span>
<span class="x">                    let commentContent = &#39;&lt;div&gt;&#39; + response.content + &#39; - &#39; + response.created_at + &#39;&lt;/div&gt;&#39;;</span>

<span class="x">                    $(&#39;#comments&#39;).prepend(commentUser + commentContent + &#39;&lt;hr&gt;&#39;);</span>

<span class="x">                    $(&#39;#comment-form&#39;)[0].reset(); // پاک کردن فرم برای ورود داده جدید</span>
<span class="x">                    $(&#39;.comment-count&#39;).text(&#39;تعداد کامنت ها: &#39; + response.comments_count)</span>
<span class="x">                },</span>
<span class="x">                error: function(xhr, status, error) {</span>
<span class="x">                    console.error(&#39;خطا در ارسال اطلاعات:&#39;, error);</span>
<span class="x">                    alert(&#39;خطایی در ارسال کامنت رخ داده است.&#39;);</span>
<span class="x">                }</span>
<span class="x">            });</span>
<span class="x">        });</span>
<span class="x">    });</span>
<span class="x">&lt;/script&gt;</span>
</pre></div>


</ol>

<h4><strong>T6- تکمیل خودکار اطلاعات کاربر با مقادیر پیشفرض با استفاده از </strong>signal<strong>:</strong></h4>
<p>نوشتن سیگنال مدنظر در signals.py.</p>
<p><code>app directory/signals.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">complete_profile</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;نام پیش‌فرض&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;نام خانوادگی پیش‌فرض&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s1">&#39;example@gmail.com&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">bio</span> <span class="o">=</span> <span class="s1">&#39;توضیحات پیش‌فرض&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="s1">&#39;شغل پیش‌فرض&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">birth_date</span> <span class="o">=</span> <span class="s1">&#39;2001-01-01&#39;</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<h4><strong>T7- نوشتن اکشنی که وضعیت فعلی پست را نویسنده اش ایمیل کند:</strong></h4>
<p><code>app directory/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>

<span class="c1"># ——————————————————————————— Actions ———————————————————————————</span>
<span class="k">def</span> <span class="nf">post_status</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Active&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Inactive&#39;</span>

        <span class="n">send_mail</span><span class="p">(</span>
            <span class="s2">&quot;Post_status&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;your post with id: </span><span class="si">{</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> =&gt; is </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;sender@gmail.com&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="n">modeladmin</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Post status, was sent&quot;</span><span class="p">)</span>

<span class="c1"># ————————————————————————— Model Admins —————————————————————————</span>

<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">,</span> <span class="s1">&#39;-author&#39;</span><span class="p">]</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">]</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">deactivate_post</span><span class="p">,</span> <span class="n">activate_post</span><span class="p">,</span> <span class="n">post_status</span><span class="p">]</span>
</pre></div>

<hr />
<h3 id="nkht-dfy">نکات اضافی</h3>
<p><strong>نکته 1:</strong></p>
<p>در جنگو برای محدود کردن <strong>کوئری ست</strong> انتخاب شده از slicing استفاده میکنیم.</p>
<blockquote>
<p><span class="en-text">Post.objects.all()[:5]</span></p>
</blockquote>
<p><strong>نکته 2:</strong></p>
<p><strong>slicing در تمپلیت:</strong></p>
<p>با استفاده از تمپلیت فیلتر slice این کار را انجام میدهیم.</p>
<blockquote>
<p><span class="en-text">{{ variable | slice:'0:5' }}</span></p>
</blockquote>
<p><strong>نکته 3:</strong></p>
<p><strong>indexing در تمپلیت:</strong></p>
<blockquote>
<p>posts.3</p>
</blockquote>
<p><strong>نکته 4:</strong></p>
<p><strong>تمپلیت فیلتر divisibleby:</strong></p>
<p>برای بررسی بخش پذیر بودن</p>
<p>divisibleby:2 =&gt; یعنی بخش پذیر بر 2</p>
<blockquote>
<p>مثلا میخواهیم پست های زوج یک استایل و پست های فرد یک استایل دیگر داشته باشند.</p>
</blockquote>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nb">forloop</span><span class="nv">.counter0</span> <span class="o">|</span> <span class="nf">divisibleby</span><span class="o">:</span><span class="m">2</span> <span class="cp">%}</span>
<span class="x">        اقدامات مربوط به پست های زوج</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        اقدامات مربوط به پست های فرد</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"> </span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<p><strong>نکته 5:</strong></p>
<p>اگه makemigrations کار نمیکرد، از دستور (makemigrations --empty app_name) استفاده میکنیم.</p>
<p><strong>نکته 6:</strong></p>
<p><strong>دستور request.build_absolute_uri:</strong> آدرس URL مطلق را برمیگرداند.</p>
<h3 id="wyjgy-hy-jdyd-bry-prwjh">ویژگی های جدید برای پروژه</h3>
<p><strong>آخرین کاربرانی که عضو سایت شده اند:</strong></p>
<p>نمایش کاربرانی که به تازگی در وبسایت عضو شده اند.</p>
<p>مدل User یک فیلد بنام date_joined دارد که تاریخ join شدن کاربر در وبسایت را رمیگرداند.</p>
<blockquote>
<p>User.objects.filter(is_active=True).order_by('-date_joined')[:10]</p>
</blockquote>
<p><strong>نمایش followers و following از جدید به قدیم:</strong></p>
<p><code>app directory/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">get_following</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">contact</span><span class="o">.</span><span class="n">user_to</span> <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_from_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_followers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">contact</span><span class="o">.</span><span class="n">user_from</span> <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_to_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created&quot;</span><span class="p">)]</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>متغیر contact یک آبجکت از مدل Contact میباشد که هر دو فیلد user_to و user_from را در خود دارد.</p>
<p><strong>user_to:</strong>  برای هر کدام از آبجکت های contact فالوشوندگان (following) را برمیگرداند.</p>
<p><strong>user_from:</strong> برای هر کدام از آبجکت های contact فالوکنندگان (followers) را برمیگرداند.</p>
<p><strong>توضیحات بیشتر:</strong></p>
<blockquote>
<p>با استفاده از related_name های rel_from_set و rel_to_set؛ کوئری ستی که برگردانده میشود شامل آبجکت های مدل Contact هستند.</p>
</blockquote>
<p><strong>rel_from_set:</strong> آبجکت هایی (از مدل Contact) که در آنها کاربر (self) جزء فالو کنندگان(followers) میباشد را برمیگرداند. / اگر ما جزء followers کاربران دیگر باشیم مسلما آنها در لیست following ما قرار دارند.</p>
<blockquote>
<p><span class="en-text">user follows x.</span>  <br />
<span class="en-text">user follows y.</span>  <br />
<span class="en-text">user follows z.</span>  <br />
<span class="en-text">...</span></p>
</blockquote>
<p><strong>rel_to_set:</strong>  آبجکت هایی (از مدل Contact) که در آنها کاربر (self) جزء فالو شوندگان(following) میباشد را برمیگرداند. / اگر ما جزء following کاربران دیگر باشیم مسلما آنها در لیست followers ما قرار دارند.</p>
<blockquote>
<p><span class="en-text">a follows user.</span>  <br />
<span class="en-text">b follows user.</span>  <br />
<span class="en-text">c follows user.</span>  <br />
<span class="en-text">...</span></p>
</blockquote>
<p>در توابع ایجاد شده  <strong>self</strong> نشان دهنده یک کاربر هست.</p>
<blockquote>
<p>علامت (=&gt;) در معنای <strong>معادل است</strong> استفاده شده است.</p>
</blockquote>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">rel_from_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_from</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

<span class="n">user</span><span class="o">.</span><span class="n">rel_to_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_to</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</pre></div>

<p>متغیر user نشان دهنده یک کاربر میباشد.</p>
            <a href="https://github.com/mahd25/Django-E-booklet/edit/seasons-source/season-09.md" target="_blank" class="edit-icon">
                <i class="fa-solid fa-pen-to-square"></i>
            </a>
        </div>
    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="../seasons-css-&-js/Django-seasons.js"></script>
<script src="../seasons-css-&-js/copy-icon.js"></script>
<script src="../seasons-css-&-js/Footer-Copyright.js"></script>
</body>
</html>
    
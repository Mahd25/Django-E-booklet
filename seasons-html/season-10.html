<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<title>Season Ten</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Django e-booklet">
<meta name="keywords" content="django, django learning">
<meta name="author" content="Mahdi Rezaie, Ali Ebrahimian">
<link rel="icon" href="../Images/favicon.ico" type="image/ico">

<link rel="stylesheet" type="text/css" href="https://mahd25.github.io/assets/CSS/seasons-style.css">
<link rel="stylesheet" type="text/css" href="https://mahd25.github.io/assets/CSS/Footer-style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<main>
    <div class="container">
        <div class="content">
            <h2>فصل دهم: اپلیکیشن فروشگاه اینترنتی (بخش اول)</h2><div class="toc"><h3>فهرست مطالب</h3><ul>
<li><a href="#yjd-prwjh-w-mdl-mhswl">ایجاد پروژه و مدل محصول</a></li>
<li><a href="#nmysh-mdl-h-dr-dmyn-w-sygnl-tkhfyf">نمایش مدل ها در ادمین و سیگنال تخفیف</a></li>
<li><a href="#dfh-khrdn-url-w-view-bry-mhswlt">اضافه کردن Url و View برای محصولات</a></li>
<li><a href="#dfh-khrdn-tmplyt-lyst-mhswlt">اضافه کردن تمپلیت لیست محصولات</a></li>
<li><a href="#dfh-khrdn-tmplyt-jzyyt-mhswl">اضافه کردن تمپلیت جزئیات محصول</a></li>
<li><a href="#khr-b-sshn-session">کار با سشن (session)</a></li>
<li><a href="#dfh-khrdn-p-sbd-khryd">اضافه کردن اپ سبد خرید</a></li>
<li><a href="#khr-b-context-processor">کار با context processor</a></li>
<li><a href="#fzwdn-ytm-bh-sbd-khryd-b-ajax">افزودن آیتم به سبد خرید با Ajax</a></li>
<li><a href="#tmplyt-sbd-khryd">تمپلیت سبد خرید</a></li>
<li><a href="#khlyd-fzysh-w-khhsh-sbd-khryd-b-ajax">کلید افزایش و کاهش سبد خرید با Ajax</a></li>
<li><a href="#khlyd-hdhf-z-sbd-khryd-b-ajax">کلید حذف از سبد خرید با Ajax</a></li>
<li><a href="#dfh-khrdn-p-w-mdl-hy-sfrsh-order">اضافه کردن اپ و مدل های سفارش (Order)</a></li>
<li><a href="#nmysh-mdl-sfrsh-dr-pnl-dmyn">نمایش مدل سفارش در پنل ادمین</a></li>
<li><a href="#yjd-khrbr-sfrshy-abstractbaseuser">ایجاد کاربر سفارشی (AbstractBaseUser)</a></li>
<li><a href="#shkhsy-szy-frm-dmyn-bry-khrbr-sfrshy">شخصی سازی فرم ادمین برای کاربر سفارشی</a></li>
<li><a href="#tbr-snjy-khrbr-sfrshy">اعتبار سنجی کاربر سفارشی</a></li>
<li><a href="#tmrynt-fsl-dhm-mhm">تمرینات فصل دهم (مهم)</a></li>
</ul></div>
<h3 id="yjd-prwjh-w-mdl-mhswl">ایجاد پروژه و مدل محصول</h3>
<p>برای فروشگاه یک پروژه جدید ایجاد میکنیم حالا یک اپلیکیشن ایجاد کرده و آنرا به پروژه خود معرفی میکنیم (<a href="season-02.html">آموزش ایجاد و معرفی اپ</a>)</p>
<p>مدل «category»:</p>
<p>یک مدل بنام «category» برای دسته بندی محصولات ایجاد میکنیم</p>
<p>یک فیلد «name» برای اسم دسته بندی مشخص میکنیم</p>
<p>یک فیلد برای «slug» نوشته و برای آن از آرگومان (unique=True) استفاده میکنیم تا «slug» تکراری نداشته باشیم</p>
<p>برای بهینه تر بودن از کلاس «Meta» استفاده کرده و داخل بدنه اش «ordering» و «indexes» را براساس فیلد «name» ایجاد میکنیم. / با «verbose_name» میتوانیم یک اسم (برای مدل «category») جهت نمایش در پنل ادمین استفاده کنیم.</p>
<p>با استفاده از آرگومان «verbose_name» هم میتوان برای هر فیلد اسم مستعار مشخص کرد حتی به فارسی.</p>
<p><code>app_name &gt; models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="c1"># Create your models here.</span>
<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])]</span>
        <span class="c1"># اسم مستعار</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s1">&#39;دسته بندی&#39;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s1">&#39;دسته بندی ها&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>

<p>خب حالا میریم مدل «product» را ایجاد کنیم:</p>
<p>با فرض اینکه هر محصول یک «category» داره ولی هر «category» میتونه چند محصول داشته باشه،  یک فیلد بنام «category» از نوع «foreignkey» ایجاد کرده و آنرا به مدل «Category» متصل میکنیم.</p>
<h4>در ایجاد فروشگاه باید به یک نکته توجه کنیم آن هم اینکه فروشگاه ما یک فروشنده داره و یا دارای چند فروشنده هست.</h4>
<p>اگه چند فروشنده داشه باشیم باید یک مدل برای فروشنده ایجاد کنیم«seller» حالا باید این دو مدل (محصول و فروشنده) را بهم متصل کنیم وااسه همین توی مدل  «product» یک فیلد از نوع «foreignkey» ایجاد کرده و آنرا به مدل seller» متصل میکنیم</p>
<p>نکته دیگر اینکه باید مثل پستهای منتشر شده یک «manager» برای «seller» ایجاد میکنیم تا آنهایی که تایید شده اند  توی وبسایت نمایش داده بشوند و بتوانند فعالیت کنند.</p>
<p>«یک فروشنده میتواند چند محصول داشته باشه ولی هر محصول یک فروشنده داره.»</p>
<p>در اینجا ما پروژه را با فرض بر یک فروشنده پیش میبریم.</p>
<p>برای product فیلدهایی مثله (name, slug, descripton, product_image, inventory, price) و... مشخص میکنیم.</p>
<p>توی وبسایت های خارجی price از نوع اعشاری است (DesimalField یا FloatField) ولی توی ایران از «PositiveIntegerField» استفاده میکنیم</p>
<p>برای قیمت دو فیلد دیگر هم ایجاد میکنیم یکی درصد تخفیف برای محصول و دومی قیمت پس از اعمال تخفیف.</p>
<hr />
<p>خب حالا نوبت به ایجاد فیلدهای مربوط به تاریخ (create, update) میرسه(بهتره با تاریخ جلالی تاریخ و زمان را فارسی کنیم.)</p>
<p><code>app_name &gt; models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;products&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">3500</span><span class="p">)</span>

    <span class="n">inventory</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># price = models.DecimalField(max_digits=10, decimal_places=2)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">offers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">new_price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># date</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>

<p>ویژگی و مشخصات محصول «feature»: محصولات دارای یکسری ویژگی و مشخصاتی هستند، مثلا برای برخی از محصولات وزن آنرا بیان میکنیم ،برای کتب تعداد صفحات را مشخص میکنیم، یکسری از محصولات ابعاد برایشان بیان میشه / در کل یک محصول میتواند چندین ویژگی داشته باشه.</p>
<p>برای اینکه با تغییر ویژگی یک محصول ویزگی محصولات دیگه تغییر نکنه بجای رابطه «ManyToMany» از «ForeignKey» استفاده میکنیم</p>
<p>خب ویژگی«feature» هر محصول را منحصر به فرد در نظر میگیریم؛ بدین ترتیب یک محصول میتواند چند ویژگی(«feature») داشته باشه ولی هر ویژگی«feature» به یک محصول تعلق دارد.</p>
<p>با این توصیفات فیلد رابطه ای مربوط به مشخصات محصول، توی مدل مشخصات «ProductFeatures» نوشته میشود:</p>
<p><code>app_name &gt; models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">ProductFeatures</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;features&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

<p>چون محصولات دارای چندین عکس هستند، یک مدل برای تصاویر ایجاد کرده و آنرا به مدل «product» متصل میکنیم.</p>
<p><code>app_name &gt; models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Images</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">image_file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;product_images/%Y/%m/</span><span class="si">%d</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</pre></div>

<p>نکته: برای اینکه تصاویر آپلودی در هر روزی مجزا توی یک پوشه قرار بگیرند(دسته بندی براساس تاریخ) برای آرگومان «upload_to» از حالت (product_images/%Y/%m/%d/) استفاده میکنیم.</p>
<hr />
<h4>تنظیمات و کارهای لازم برای ذخیره شدن تصاویر آپلودی</h4>
<p>1- برای اینکه تصاویر آپلودی بتوانند ذخیره شوند توی «settings.py» باید «MEDIA_URL» و «MEDIA_ROOT» را مشخص کنیم.</p>
<p><code>project_name &gt; settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s1">&#39;/media/&#39;</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">)</span>
</pre></div>

<hr />
<p>2- حالا توی «urls.py» پروژه باید یک «urlpatterns» هم اضافه کنیم. / «static» و «settings» رو هم باید ایمپورت کنیم (توی فایل یکسری مقادیر از قبل وجود دارد)</p>
<p><code>project_name &gt; urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</pre></div>

<p>حالا باید پکیج «pillow» را نصب کنیم</p>
<p><code>Terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pillow</span>
</pre></div>

<p>حالا بادستورات «makemigrations» و «migrate» تغییرات را در دیتابیس اعمال میکنیم.</p>
<hr />
<h3 id="nmysh-mdl-h-dr-dmyn-w-sygnl-tkhfyf">نمایش مدل ها در ادمین و سیگنال تخفیف</h3>
<p>خب بریم سیگنال تخفیف را ایجاد کنیم</p>
<p>برای نوشتن سیگنال هایمان توی دایرکتوری اپ(app) یک فایل پایتونی بنام «signals.py» ایجاد میکنیم</p>
<p>برای تخفیف محصول از سیگنال «pre_save» استفاده میکنیم پس باید ایمپورت بشه. / reciever رو هم باید ایمپورت کنیم.</p>
<p>حالا وقتی قیمت محصول و یا درصد تخفیف تغییر کنه سیگنال ارسال میشه حالا آن میاد و قیمت پس از تخفیف را محاسبه کرده و آنرا در دیتابیس ذخیره میکنه.</p>
<p><code>app_name &gt; signals.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">pre_save</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">pre_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Product</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">calculate_new_price</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">new_price</span> <span class="o">=</span> <span class="p">((</span><span class="mi">100</span> <span class="o">-</span> <span class="n">instance</span><span class="o">.</span><span class="n">offers</span><span class="p">)</span> <span class="o">*</span> <span class="n">instance</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
</pre></div>

<p>برای اینکه سیگنال های نوشته شده کار کنند باید آنها را کانفیگ کنیم. / برای این کار توی فایل پایتونی «apps.py» متد «ready» رو «override» میکنیم.</p>
<p>signals =&gt; اسم فایلی است که سیگنالها را در آن مینویسیم</p>
<p>app_name =&gt; اسمی که برای اپلیکیشن خود نوشته ایم.</p>
<p><code>app_name &gt; apps.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">app_name.signals</span>
</pre></div>

<p><code>app_name &gt; apps.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>


<span class="k">class</span> <span class="nc">ShopConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">default_auto_field</span> <span class="o">=</span> <span class="s1">&#39;django.db.models.BigAutoField&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;shop&#39;</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">shop.signals</span>
</pre></div>

<hr />
<p>خب حالا بریم مدل ها را در پنل ادمین نمایش بدیم:</p>
<p>برای مشاهده و مدیریت مدل های «Image» و «ProductFeatures» در مدل «Product»  وقتی در پنل ادمین هستیم؛ برای آن دو از «InlineModelAdmin» استفاده کرده و آنها را به لیست «Inlines» در کلاس «ProductAdmin» اضافه میکنیم.</p>
<p><code>app_name &gt; admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">FeaturesInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ProductFeatures</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">ImageInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Images</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1"># Register your models here.</span>
<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ProductAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;new_price&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
    <span class="n">prepopulated_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)}</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">FeaturesInline</span><span class="p">,</span> <span class="n">ImageInline</span><span class="p">]</span>


<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CategoryAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">)</span>
    <span class="n">prepopulated_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)}</span>


<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ProductFeatures</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ProductFeaturesAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">)</span>
</pre></div>

<hr />
<p>حالا برای ورود به پنل ادمین باید یک «superuser» ایجاد کنیم.</p>
<p><code>Terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>
</pre></div>

<h3 id="dfh-khrdn-url-w-view-bry-mhswlt">اضافه کردن Url و View برای محصولات</h3>
<p>بریم یک view برای لیست محصولات ایجاد کنیم / موارد لازم مثل مدل ها را ایمپورت میکنیم:</p>
<p>برای view لیست محصولات دو حالت داریم =&gt; 1- زمانی که میخواهیم کل محصولات را نمایش دهیم 2- زمانی که میخواهیم کل محصولات مربوط به یک دسته بندی را نمایش بدهیم.</p>
<p>برای همین به عنوان آرگومان «category_slug=None» را برایش مشخص میکنیم تا زمانی که کاربر آنرا وارد نکرده مقدارش «None» باشد.</p>
<p>تمامی دسته بندی ها(category) و محصولات (product)  را از دیتابیس دریافت کرده و در متغیر ذخیره میکنیم. / اینها به تمپلیت ارسال میشوند.</p>
<p>حالا یک شرط مینویسیم تا اگر دسته بندی توسط کاربر ارسال شد اول چک کنیم آن دسته بندی وجود داره یا نه / اگه وجود داشت محصولات را براساس آن دسته بندی فیلتر میکنیم. در غیر این صورت ارور 404</p>
<p>حالا مواردی مثله (دسته بندی فعلی ، محصولات بدست آمده و کل دسته بندی ها) را از طریق «context» به تمپلیت ارسال میکنیم.</p>
<p><code>app_name &gt; views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>


<span class="c1"># Create your views here.</span>
<span class="k">def</span> <span class="nf">products_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">category_slug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">category_slug</span><span class="p">:</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">category_slug</span><span class="p">)</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s1">&#39;products&#39;</span><span class="p">:</span> <span class="n">products</span><span class="p">,</span>
        <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;shop/products_list.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p>حالا بریم «view» مربوط به جئیات محصول را ایجاد کنیم.</p>
<p>این کار را براساس «id» و «slug» آن پست انجام میدهیم. / اگه «id» ویا «slug» وجود نداشت ارور «404» میدهد.</p>
<p>آن محصول را از طریق «context» به تمپلیت ارسال میکنیم.</p>
<p><code>app_name &gt; views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">product_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;shop/product_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p>حالا بریم سراغ url</p>
<p>برای لیست محصولات دو url لازم داریم 1- بدون متغیر که برای کل محصولات هستش 2- به همراه متغیر (category_slug) که برای تمام محصولات مربوط به آن دسته بندی هستش</p>
<p>یک url هم برای جزئیات محصول ایجاد میکنیم. / برای شناسایی محصول مدنظر «slug» و «id» محصول را ارسال میکنیم.</p>
<p><code>app_name &gt; urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;shop&#39;</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;products/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">products_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;products-list&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;products/&lt;slug:category_slug/&gt;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">products_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;products-list-by-category&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;products/&lt;int:id&gt;/&lt;slug:slug&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">product_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;product_detail&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p>حالا برای اینکه این «url» ها کار بکنند باید آنها را به فایل «urls.py» پروژه معرفی کنیم.</p>
<p>لازمه «include» را ایمپورت کنیم.</p>
<p><code>project_name &gt; urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
</pre></div>

<p>حالا عبارت زیر را به لیست «urlpatterns» اضافه میکنیم.</p>
<p><code>project_name &gt; urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shop.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;shop&#39;</span><span class="p">)),</span>
</pre></div>

<p>خب بریم کد کامل را ببینیم:</p>
<p><code>project_name &gt; urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shop.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;shop&#39;</span><span class="p">)),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</pre></div>

<p>برای مدل «Category» و «Product» متد «get_absolute_url» را مشخص تا هرجا لازم داشتیم از آن استفاده کنیم. / «reverse» را باید ایمپورت کنیم.</p>
<p><code>app_name &gt; models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="c1"># in Category model =&gt; محصولات را براساس یک دسته بندی برمیگرداند</span>
<span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;shop:products-list-by-category&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">})</span>

<span class="c1"># in Product model =&gt; یک محصول را براساس (آیدی) و (اسلاگ) آن برمیگرداند.</span>
<span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;shop:product_detail&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">})</span>
</pre></div>

<h3 id="dfh-khrdn-tmplyt-lyst-mhswlt">اضافه کردن تمپلیت لیست محصولات</h3>
<p>داخل دایرکتوری اپ (app) دایرکتوری «static» را ایجاد میکنیم. / برای فایل هایی مثله «css», «JS», «images», «font» استفاده میشه.</p>
<p>توی دایرکتوری «templates» یک دایرکتوری بنام «parent» میسازیم حالا داخل آن یک دایرکتوری دیگه بنام «base» ایجاد کرده و تمپلیت پایه را آنجا ذخیره میکنیم. / حالا داخل دایرکتوری «templates» یک دایرکتوری هم بنام «partials» ساخته و (هدر و فوتر و...) را آنجا ذخیره میکنیم.</p>
<p>حالا بریم تمپلیت پایه خود (base-template.html) را ایجاد کنیم:</p>
<p>داخل تمپلیت برای استفاده از فایل های موجود در دایرکتوری «static» باید  «static» را با تمپلیت تگ «{% load %}» به تمپلیت معرفی کنیم</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">html</span>
        </div>
    <pre><span></span>{% load static %}
</pre></div>

<p>برای تگ (title) از تمپلیت تگ ({% block name %}{% block %}) استفاده میکنیم. / تا هر تمپلیتی که از «base_template.html» ارث بری میکنه بتواند «title» خودش را داشته باشه.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">html</span>
        </div>
    <pre><span></span><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>shop | {% block title %}{% endblock %}<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</pre></div>

<p>با استفاده از «static» فایل «css» مربوط به تمپلیت «base» را به آن لینک میکنیم.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">html</span>
        </div>
    <pre><span></span><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% static &#39;CSS/base_style.css&#39; %}&quot;</span><span class="p">&gt;</span>
</pre></div>

<p>چنانچه بخواهیم توی تگ (head) موارد دیگری هم اضافه کنیم یک تمپلیت تگ «block» هم به آخر تگ (head) اضافه میکنیم.</p>
<p>فایل هایی مثله «header», «navigation», «footer» را به صورت مجزا توی دایرکتوری «partials»  ایجاد میکنیم. / حالا به کمک تمپلیت تگ {% include path %} آنها را به تمپلیت پایه اضافه میکنیم.</p>
<p>برای نوشتن محتوای اصلی تمپلیتی که از فایل «base» ارث بری میکنه باید توی فایل «base» قبل از «footer» از تمپلیت تگ «block» استفاده کنیم.</p>
<p>خب بریم کد کامل تمپلیت پایه را ببینیم:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">html</span>
        </div>
    <pre><span></span>{% load static %}

<span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;ie=edge&quot;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>shop | {% block title %}{% endblock %}<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% static &#39;CSS/base_style.css&#39; %}&quot;</span><span class="p">&gt;</span>
    {% block head %}{% endblock %}
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    {% include &#39;partials/header.html&#39; %}

    {% block content %}{% endblock %}

    {% include &#39;partials/footer.html&#39; %}
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>

<p>خب بریم تمپلیت لیست محصولات را ایجاد کنیم:</p>
<p>اول از تمپلیت پایه ارث  بری میکنیم</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">html</span>
        </div>
    <pre><span></span>{% extends &#39;path of base_template.html&#39; %}
</pre></div>

<p>در کل در هر تمپلیتی که نیاز به فایل هایی مثل (CSS, JS, image, ...) هست باید «static» را لود کنیم. / پس اینجا هم همین کار را میکنیم.</p>
<h3 id="dfh-khrdn-tmplyt-jzyyt-mhswl">اضافه کردن تمپلیت جزئیات محصول</h3>
<p>در این تمپلیت؛ تصاویر محصول، توضیحات، دسته بندی، ویژگی های آن و... را نمایش میدهیم.</p>
<p>در گام اول از تمپلیت پایه ارث بری میکنیم.</p>
<p><code>templates/shop/product_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="nv">product.name</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">head</span> <span class="cp">%}</span><span class="x">&lt;link rel=&quot;stylesheet&quot; href=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;CSS/product-detail.css&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>


<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;heading-text&quot;&gt;</span>
<span class="x">        &lt;h1&gt;جزئیات محصول&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>


<span class="x">    &lt;div class=&quot;product-detail&quot;&gt;</span>
<span class="x">        &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">product.name</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="x">        &lt;p&gt;دسته بندی: </span><span class="cp">{{</span> <span class="nv">product.category</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;موجودی: </span><span class="cp">{{</span> <span class="nv">product.inventory</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;ul&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">feature</span> <span class="k">in</span> <span class="nv">product.features.all</span> <span class="cp">%}</span>
<span class="x">                &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">feature.name</span> <span class="cp">}}</span><span class="x">: </span><span class="cp">{{</span> <span class="nv">feature.value</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">        &lt;/ul&gt;</span>

<span class="x">        &lt;div class=&quot;price&quot;&gt;</span>
<span class="x">            &lt;span class=&quot;original-price&quot;&gt;قیمت: </span><span class="cp">{{</span> <span class="nv">product.price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">            &lt;br&gt;</span>
<span class="x">            &lt;span class=&quot;discounted-price&quot;&gt;قیمت پس از تخفیف: </span><span class="cp">{{</span> <span class="nv">product.new_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;product-images&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">image</span> <span class="k">in</span> <span class="nv">product.images.all</span> <span class="cp">%}</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">image.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;</span><span class="cp">{{</span> <span class="nv">image.title</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;product-description&quot;&gt;</span>
<span class="x">        &lt;h3&gt;description&lt;/h3&gt;</span>
<span class="x">        &lt;p&gt;</span><span class="cp">{{</span> <span class="nv">product.description</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p>یک تگ div برای جزئیات محصول ایجاد کرده و در آن؛ اسم محصول، دسته بندی، موجودی، ویژگی های محصول را در آن نمایش میدهیم.</p>
<p>برای تصاویر محصول نیز یک div ایجاد کرده و با پیمایش روی تصاویر توسط حلقه، تصاویر آن را نمایش میدهیم.</p>
<p>و در پایان توضیحات محصول را اضافه میکنیم.</p>
<blockquote>
<p>ساختار html میتواند بسته به علایق تغییراتی داشته باشد، مثلا ابتدا تصاویر نمایش داده شوند.</p>
</blockquote>
<h3 id="khr-b-sshn-session">کار با سشن (session)</h3>
<p>توضیحات اصلی در مورد سشن و کوکی ها در <a href="season-00.html#14-khwkhy-h-w-sshn-h">فصل صفرم</a> بیان شده است.</p>
<p>session ها در سمت سرور ذخیره میشوند برخلاف کوکی ها؛ و فقط sessionID در کوکی ها ذخیره میشود.</p>
<blockquote>
<p>برای هر کاربر یک sessionID وجود دارد، امنیت بالاتری دارد.</p>
</blockquote>
<p>معمولا سشن ها را زمانی استفاده میکنیم، که میخواهیم یکسری داده ها را به صورت موقتی ذخیره کنیم و بعد پاک شوند(به صورت اتوماتیک و یا دستی).</p>
<blockquote>
<p>مثلا در برخی فرم های ثبت نامی که شماره تلفن را گرفته و کدی را به کاربر  ارسال میکند؛ آن شماره در سشن ذخیره میشود.</p>
</blockquote>
<p><strong>برای استفاده از سشن ها لازم است که تنظیمات آن وجود داشته باشد:</strong></p>
<p>بررسی شود که در settings.py بخش  MIDDLEWARE تنظیمات سشن وجود داشته باشد.(به صورت پیشفرض این تنظیمات وجود دارد.)</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>
</pre></div>

<p>در سشن؛ ساختار عملکردی به صورت دیکشنری میباشد، با کلید و مقدار داده ها را ذخیره میکنیم.</p>
<p><strong>روش استفاده:</strong></p>
<blockquote>
<p>تنظیمات MIDDLEWARE سشن باعث میشود که session در request وجود داشته باشد؛ بنابراین با دستور <strong>request.session</strong> میتوانیم به سشن دسترسی داشته باشیم.</p>
<p>request.session یک دیکشنری میباشد.     </p>
</blockquote>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="c1"># با ساختار دستوری بالا میتوانیم، یک داده را در سشن ذخیره کنیم.</span>

<span class="c1"># -------------------------------------------------------------------</span>

<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="c1"># و با دستور بالا میتوانیم به داده مدنظر در سشن دسترسی داشته باشیم.</span>
</pre></div>

<p><strong>نکته: به صورت پیشفرض سشن ها به مدت 2 هفته نگهداری میشوند.</strong></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># با کلمه کلیدی del میتوان آن سشن را پاک کرد.</span>
<span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</pre></div>

<p><strong>تنظیمات اضافی برای سشن:</strong></p>
<p>یکسری تنظیمات برای مدیریت سشن وجود دارد اینجا چند مورد را بررسی میکنیم:</p>
<p><strong>SESSION_COOKIE_AGE:</strong> تاریخ انقضای سشن را مشخص میکنیم، باید به ثانیه وارد شود.</p>
<p><strong>SESSION_ENGINE:</strong> مشخص میکنیم، سشن ها را در سمت سرور در کجا ذخیره شوند. / به صورت پیشفرض دیتابیس میباشد.</p>
<p><strong>SESSION_EXPIRE_AT_BROWSER_CLOSE:</strong> دو مقدار True  و False دارد، مقدار True  باعث میشود به محض بستن مرورگر سشن ها پاک شوند ولی اگر False باشد مقداری که برای متغیر SESSION_COOKIE_AGE مشخص کردیم، اعمال میشود. / به صورت پیشفرض <strong>False</strong> میباشد.</p>
<blockquote>
<p><strong>نکته:</strong> اگر قبل از لاگین کردن مواردی را در سشن ذخیره کنیم، پس از لاگین کردن آن داده ها از بین میروند و یک سشن جدید ایجاد میشود.</p>
<p><span class="rtl-text">ولی اگر میخواهیم آن مقادیر پس از لاگین کردن هم باقی بمانند؛ قبل از استفاده از کلاس <span class="en-text">login()</span> مقادیر آن سشن را در یک متغیر ذخیره کنیم، حالا پس از لاگین کردن اطلاعات ذخیره شده در متغیر را در سشن جدید ذخیره میکنیم.</span></p>
<blockquote>
<p>my_data = request.session</p>
<p>login()</p>
<p>request.session = my_data</p>
</blockquote>
</blockquote>
<h3 id="dfh-khrdn-p-sbd-khryd">اضافه کردن اپ سبد خرید</h3>
<p>چون ساختار فروشگاه یک پروژه بزرگ بوده و قابل توسعه میباشد، برای مدیریت بهتر و سریع تر از چندین اپ(app) برای بخش های مختلف استفاده میکنیم.</p>
<blockquote>
<p>مثلا برای سبد خرید و یا پرداخت هزینه ها از اپ های جداگانه ایجاد میکنیم.</p>
</blockquote>
<p>پس یک اپ بنام <strong>cart</strong> ایجاد کرده و آنرا در تنظیمات(INSTALLED_APPS) به پروژه خود معرفی میکینم.</p>
<p><strong>برای هر کاربر، اطلاعات سبد خرید را در سشن ذخیره میکنیم.</strong></p>
<ul>
<li>برای مدیریت سبد خرید که در سشن ذخیره میشود، یک کلاس ایجاد کرده و برای عملکردهای مختلف مثل افزودن کالا به سبد خرید، حذف کالا از سبد خرید و... متدهایی در این کلاس ایجاد میکنیم.</li>
</ul>
<p><strong>بریم ببینیم چطور اطلاعات سبد خرید را در سشن ذخیره میکنیم:</strong></p>
<p>برای اینکه در سشن یک سبد خرید داشته باشیم؛ یک کلید بنام <strong>cart</strong> ایجاد کرده و برای مقدار آن یک دیکشنری قرار میدهیم.(آیتم های سبد خرید در این دیکشنری قرار میگیرند.)</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># session =&gt; {&quot;cart&quot;: {item&#39;s}}</span>
</pre></div>

<p><strong>ساختار دیکشنری داخلی:</strong></p>
<p>در این دیکشنری به عنوان <strong>کلید(key)</strong> product_id و برای <strong>مقدار(value)</strong> آن یک دیکشنری دیگر خواهیم داشت؛ در این دیکشنری اطلاعات آن محصول(مثل: تعداد محصول، قیمت محصول، وزن محصول) را ذخیره میکنیم.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># {item&#39;s} =&gt; {PId1: {&#39;quantity&#39;: 2, &#39;price&#39;: product.new_price, &#39;weight&#39;: product.weight}, PId2: {&#39;quantity&#39;: 7, &#39;price&#39;: product.new_price, &#39;weight&#39;: product.weight}, ...}</span>

<span class="c1"># مقادیر وارد شده فرضی میباشند.</span>
</pre></div>

<blockquote>
<p>به این ترتیب تا وقتی این سشن برقرار است حتی اگر قیمت محصول تغییر کند، برای محصولاتی که در سبد خرید قرار دارند، تغییر قیمت نخواهیم داشت.(قیمت ثابته.)</p>
</blockquote>
<p>کلیدهای ما id محصولات میباشند؛ البته باید به صورت رشته باشد، چون قرار است به json (سریال سازی: فرایند ترجمه ساختمان داده)serialize شود.(پس کلیدها باید به صورت رشته باشند.)</p>
<blockquote>
<p>هر کاربر یک سشن منحصر به فرد با سبدخرید (cart) منحصر به فرد میباشد.</p>
</blockquote>
<p><strong>خب بریم این ساختار را پیاده سازی کنیم:</strong></p>
<p>در app(اپ)، <strong>cart</strong> یک فایل پایتونی بنام cart.py ایجاد میکنیم؛ در آن فایل یک کلاس ایجاد میکنیم.</p>
<blockquote>
<p>این کلاس همان کلاسی است که در بالا در مورد آن توضیح داده شد(برای مدیریت سبد خرید).</p>
</blockquote>
<p>در این فایل، با مدل Product سروکار داریم، ولی این مدل در یک اپ دیگر قرار دارد؛ بنابراین از آن app به مدل ها رفته و مدل Product را انتخاب میکنیم.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>
</pre></div>

<p>خب حالا یک کلاس بنام Cart ایجاد میکنیم(این کلاس از هیچ کلاس دیگری ارث بری نمیکنه) داخل بدنه آن متدهایی که لازم داریم را اضافه میکنیم.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>برای متد <strong>__init__</strong>، باید request را به عنوان پارامتر مشخص کنیم؛ چرا؟!، چون برای دسترسی به سشن به آن نیاز داریم. / در دستور <strong>request.session</strong>.</p>
<ol>
<li>
<p>با استفاده از دستور request.session سشن را به دست آورده و آنرا در اتریبیوت session ذخیره میکنیم.</p>
</li>
<li>
<p>یک متغیر موقت بنام cart ایجاد میکنیم و در آن بررسی میکنیم که در سشن cart(سبد خرید) وجود دارد یا نه؟!</p>
<blockquote>
<p><span class="rtl-text">با استفاده از متد <span class="en-text">get()</span> بررسی میکنیم که کلیدی تحت عنوان cart وجود دارد یا نه؟!</span></p>
<p>اگر cart وجود داشته باشد مقدار آنرا (value) را برمیگرداند و در غیر این صورت None برمیگرداند. / خروجی آن در متغیر ذخیره میشود.</p>
</blockquote>
</li>
<li>
<p>اگر مقدار متغیر cart(سبد خرید)، None بود(یعنی کلید cart در سشن وجود ندارد)؛ بنابراین برای سشن یک کلید(key) بنام cart ایجاد کرده و برای مقدار آن(value) یک دیکشنری خالی مشخص میکنیم.
    &gt; <span class="rtl-text">در ساختار <span class="en-text">cart = self.session['cart'] = {}</span> یک کلید و مقدار برای سشن ست میشود (یک کلید بنام cart با مقدار دیکشنری خالی در سشن ایجاد میشود) از طرفی دیکشنری خالی برای این <strong>متغیر cart</strong> ست میشود.</span>
    &gt;
    &gt; در ضمن این ساختار باعث میشود که هر بار cart آپدیت میشود سشن هم تغییر کند. / وقتی محصولی به cart(سبد خرید) اضافه میکنیم این تغییر در سشن هم لحاظ میشود.
    &gt;
    &gt; الان هم سشن، سبد خرید را دارد و هم متغیر cart دارای مقدار (دیکشنری خالی) میباشد.</p>
<p><strong>بذارید یک مثال بزنیم:</strong></p>
<blockquote>
<blockquote>
<p><span class="en-text">a = b = 5</span></p>
</blockquote>
<p>در مثال بالا مشخص کرده ایم که متغیر a با متغیر b برابر بوده و برای هردو مقدار 5 ست شده است.</p>
<blockquote>
<p><span class="en-text">cart = self.session['cart'] = {}</span></p>
</blockquote>
<p>در متد __init__ هم مشخص کرده ایم که متغیر cart با value(مقدار)، <strong>کلید cart</strong> در دیکشنری session برابر هست و برای هردو یک دیکشنری خالی ست کرده ایم.</p>
</blockquote>
</li>
<li>
<p>حالا متغیر cart مقدار دارد(1- یا یک دیکشنری با یکسری مقادیر(اطلاعات محصول) میباشد 2- و یا یک دیکشنری خالیست)؛ آن متغیر را به عنوان اتریبیوت cart ذخیره میکنیم.</p>
<blockquote>
<p>پس حالا این self.cart یا یک دیکشنری خالی میباشد و یا یک دیکشنری هست که از قبل وجود داشته شامل یکسری محصولات هست.</p>
<p>با این مقداردهی های اولیه cart(سبد خرید) را در (session)سشن ست میکند.</p>
</blockquote>
</li>
</ol>
<p><strong>در اپ shop برای مدل Product، فیلد weight را اضافه میکنیم تا از آن در اطلاعات محصول استفاده کنیم:</strong></p>
<p><code>app directory(shop)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;products&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">3500</span><span class="p">)</span>

    <span class="n">inventory</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># price = models.DecimalField(max_digits=10, decimal_places=2)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">offers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">new_price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># —————————————————————————— weight field ——————————————————————————</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># date</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>

<p><strong>ایجاد متدهایی برای مدیریت سبد خرید در سشن:</strong></p>
<p>متدهایی که ایجاد میکنیم اطلاعات سبد خرید را در سشن تغییر میدهد.</p>
<blockquote>
<p>برای راحتی در هر بخش فقط متد همان بخش را در کد نمایش میدهیم و در پایان یک دید کلی از کد خواهیم دید.</p>
</blockquote>
<p>1- <strong>متد save:</strong></p>
<p>در آن مشخص میکنیم، که در این سشن یکسری تغییرات صورت گرفته است.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————————————————————————————————————————</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p>بنابراین هروقت از متد <span class="en-text">save()</span> استفاده کنیم، به جنگو میفهمانیم که سشن modify شده است.</p>
<p>2- <strong>متد add:</strong></p>
<p>برای افزودن یک کالا به سبد خرید و یا افزایش تعداد یک کالا در سبد خرید استفاده میشود.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ———————————————————————— افزودن به سبد خرید ——————————————————————— #</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">new_price</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">weight</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>        

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ol>
<li>
<p>product را به عنوان پارامتر برای متد add مشخص میکنیم.</p>
</li>
<li>
<p>حالا آیدی آن محصول را به صورت رشته در متغیر product_id ذخیره میکنیم.</p>
<p><strong>نکته:</strong> self.cart یک دیکشنری میباشد که برای کلیدهای آن(key)، آیدی محصولات(productID) و برای مقدار(value) هر یک از آنها یک دیکشنری دیگر خواهیم داشت که در آن، اطلاعات محصول مثل تعداد محصول، قیمت محصول، وزن محصول قرار دارد.</p>
</li>
<li>
<p>حالا یک شرط مشخص میکنیم که اگر محصولی با این آیدی در دیکشنری self.cart (سبد خرید) وجود ندارد؛ آنرا به دیکشنری اضافه میکنیم:</p>
<blockquote>
<p>یک کلید بنام آن product_id ایجاد کرده و برای مقدار آن یک دیکشنری با اطلاعات آن محصول مشخص میکنیم. / این محصول جدید به سبد خرید اضافه میشود.</p>
<p>چون این محصول به تازگی اضافه شده تعداد آن را 1 قرار میدهیم.</p>
</blockquote>
</li>
<li>
<p>ولی اگر محصول از قبل در سبد خرید وجود داشته باشد، باید یکی به تعداد آن(quantity) اضافه کنیم.</p>
<blockquote>
<p>ولی با این وجود نباید بیشتر از موجودی  آن کالا ثبت کند برای همین یک شرط میگذاریم  که اگر «تعداد آن کالا در سبد خرید» کمتر از «موجودی کالا» هست یکی به تعداد آن اضافه کن.</p>
</blockquote>
</li>
<li>
<p>و در پایان متد <span class="en-text">save()</span> را صدا میزنیم چون سشن تغییر کرده است.</p>
</li>
</ol>
<p>3- <strong>متد decrease:</strong></p>
<p>این متد تعداد محصول را کاهش می‌دهد و در صورت لزوم آن را از سبد خرید حذف می‌کند.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ———————————————————— کاهش تعداد کالا از سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">decrease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>               

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ol>
<li>
<p>product را به عنوان پارامتر برای متد decrease مشخص میکنیم.</p>
</li>
<li>
<p>در اینجا هم آیدی آن محصول را به صورت رشته در متغیر product_id ذخیره میکنیم</p>
</li>
<li>
<p>یک شرط مشخص میکنم که اگر تعداد کالا در سبد خرید بیشتر از 1 بود؛ از تعداد آن کالا یکی کم کند.</p>
</li>
<li>
<p>و در پایان از متد <span class="en-text">save()</span> استفاده میکنیم.</p>
</li>
</ol>
<p><strong>4- متد delete:</strong></p>
<p>برای حذف یک کالا از سبد خرید کاربرد دارد.</p>
<blockquote>
<p>یک محصول را (حالا هر تعداد که داشته باشد)؛ از سبد خرید پاک میکند.</p>
</blockquote>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————————— حذف یک محصول از سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>                       

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ol>
<li>
<p>product را به عنوان پارامتر برای متد delete مشخص میکنیم.</p>
</li>
<li>
<p>در اینجا هم آیدی آن محصول را به صورت رشته در متغیر product_id ذخیره میکنیم</p>
</li>
<li>
<p>حالا با استفاده از یک شرط مشخص میکنیم که اگر آن کالا در سبد خرید وجود دارد، آنرا از دیکشنری سبد خرید پاک کن.</p>
</li>
<li>
<p>استفاده از متد <span class="en-text">save()</span></p>
</li>
</ol>
<p><strong>5- متد clear:</strong></p>
<p>برای پاکسازی کامل سبد خرید استفاده میشود؛ تمام محصولات را از سبد خرید پاک میکند.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————— پاکسازی سبد خرید(حذف تمام محصولات) ——————————————— #</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>                             

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>با استفاده از کلمه کلیدی <strong>del</strong> کلید و مقدار مربوط به cart(سبد خرید) را حذف میکنیم؛ این طوری اطلاعات سبد خرید از سشن پاک میشوند.</p>
<p><strong>6- متد get_post_price:</strong></p>
<p>با این متد هزینه پستی کالا ها را برای کاربر محاسبه میکنیم.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————————————— محاسبه هزینه پستی ——————————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_post_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">20000</span>
        <span class="k">elif</span> <span class="mi">1000</span> <span class="o">&lt;</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">30000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50000</span>                                  

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>هزینه پستی براساس وزن کالاها محاسبه میشود بنابراین لازم است تا وزن تمام محصولات، سبد خرید را بدست بیاوریم.</p>
<blockquote>
<p>ممکن است از برخی کالاها چند تا وجود داشته باشه؛ پس باید وزن آن کالا را در تعداد آن ضرب کرده و در نهایت تمام وزن ها را باهم جمع کنیم.</p>
<p>quantity * weight</p>
</blockquote>
<p>با استفاده از <span class="en-text">self.cart.values()</span> به تمام دیکشنری ها (که اطلاعات محصولات، موجود در سبد خرید را نشان میدهند) دسترسی داریم.</p>
<blockquote>
<blockquote>
<p><span class="en-text">{PId1: {'quantity': 2, 'price': product.new_price, 'weight': product weight}, PId2: {'quantity': 7, 'price': product.new_price, 'weight': product.weight}, ...}</span></p>
</blockquote>
<p>اگر این نمونه بالا یک سبد خرید باشد، کدی که بالاتر گفته شد؛ دیکشنری ها که به عنوان value هستند را برمیگرداند.</p>
</blockquote>
<p>حالا روی این دیکشنری ها حلقه زده و وزن و تعداد هر کالا را بدست آورده و با یکدیگر ضرب میکنیم؛ این کار را در تابع sum انجام میدهیم تا آن مقادیر را باهم جمع هم بکند.</p>
<p>با استفاه از API و یا به صورت دستی هزینه پستی را محاسبه میکنیم.</p>
<p><strong>7- متد get_total_price:</strong></p>
<p>با این متد هزینه کل کالا های سبد خرید را محاسبه میکنیم.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ————————————————————— محاسبه هزینه کل محصولات ————————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">total_price</span>                                           

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>این بار میخواهیم هزینه کل کالا ها را حساب کنیم؛ ممکن است از یک کالا چند مورد وجود داشته باشد پس باید تعداد کالا را در قیمت آن ضرب کنیم و در نهایت همه آنها را باهم جمع کنیم.</p>
<blockquote>
<p>این فرایند مشابه با محاسبه وزن کل کالا ها میباشد.</p>
</blockquote>
<p><strong>8- متد get_final_price:</strong></p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————————— محاسبه هزینه نهایی سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_final_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">final_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_post_price</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">final_price</span>                                        

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>از مجموع هزینه کل محصولات و هزینه پستی؛ هزینه نهایی محسبه میشود.</p>
<p><strong>9- override کردن متد __len__:</strong></p>
<p>با این متد تعداد کل محصولات را بدست می آوریم.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ————————————————————— مجموع تعداد کل محصولات —————————————————————— #</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>

<p><strong>10- override کردن متد __iter__:</strong></p>
<p>متد <strong>iter</strong> یکی از متدهای خاص در پایتون است که به اشیا این امکان را می‌دهد تا قابل تکرار (iterable) شوند. | بتوان روی آنها حلقه زد.</p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ——————————————————————————— iteration ———————————————————————————— #</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">product_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">product_ids</span><span class="p">)</span>
        <span class="n">cart_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
            <span class="n">cart_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">item</span>
</pre></div>

<p><strong>توضیح کامل کد:</strong></p>
<ol>
<li>
<p><strong>استخراج شناسه‌های محصولات در سبد خرید</strong>:
    <div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">product_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div></p>
<ul>
<li>در این خط، تمام کلیدهای دیکشنری <code>self.cart</code> که شناسه‌های محصولات (product IDs) هستند، به صورت یک لیست در <code>product_ids</code> ذخیره می‌شوند.</li>
<li><code>self.cart</code> یک دیکشنری است که در آن کلیدها شناسه‌های محصولات هستند و مقادیر آن شامل اطلاعات مربوط به هر محصول مانند تعداد، قیمت و وزن هستند.</li>
</ul>
</li>
<li>
<p><strong>استخراج محصولات از دیتابیس</strong>:
    <div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">product_ids</span><span class="p">)</span>
</pre></div></p>
<ul>
<li>این خط، تمامی محصولات مرتبط با <code>product_ids</code> را از دیتابیس واکشی می‌کند. این کوئری تمام محصولاتی که شناسه‌هایشان در <code>product_ids</code> هستند را برمی‌گرداند.</li>
</ul>
</li>
<li>
<p><strong>ایجاد یک کپی از سبد خرید</strong>:
    <div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">cart_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div></p>
<ul>
<li>این خط یک کپی از سبد خرید (<code>self.cart</code>) می‌سازد تا اطمینان حاصل شود که تغییرات بعدی بر روی نسخه اصلی سبد خرید تأثیر نمی‌گذارد.</li>
</ul>
</li>
<li>
<p><strong>اضافه کردن اشیاء محصول به آیتم‌های سبد خرید</strong>:
    <div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">cart_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>
</pre></div></p>
<ul>
<li>در اینجا، برای هر محصولی که از دیتابیس واکشی شده است، شیء محصول مربوطه به آیتم سبد خرید در <code>cart_dict</code> اضافه می‌شود. این به شما این امکان را می‌دهد که دسترسی مستقیم به اشیاء محصول (به جای فقط شناسه‌های آن‌ها) در سبد خرید داشته باشید.</li>
<li>این کار با استفاده از شناسه محصول به عنوان کلید و شیء محصول به عنوان مقدار در دیکشنری انجام می‌شود.</li>
</ul>
</li>
<li>
<p><strong>حلقه تکرار روی آیتم‌های سبد خرید و بازگرداندن آن‌ها</strong>:
    <div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">item</span>
</pre></div></p>
<ul>
<li>این قسمت از کد، از <code>yield</code> برای بازگرداندن هر آیتم سبد خرید استفاده می‌کند. متد <code>yield</code> به جای بازگرداندن همه آیتم‌ها به صورت یکباره، یکی یکی آیتم‌ها را بازمی‌گرداند که این کار باعث می‌شود که متد <code>__iter__</code> یک generator شود.</li>
<li><code>cart_dict.values()</code> تمام مقادیر دیکشنری <code>cart_dict</code> را بازمی‌گرداند که شامل اطلاعات محصولات همراه با اشیاء محصول می‌باشد.</li>
</ul>
</li>
</ol>
<p><strong>کل کد در یک نگاه:</strong></p>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="k">class</span> <span class="nc">Cart</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cart&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cart</span><span class="p">:</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">cart</span>

    <span class="c1"># ———————————————————————— افزودن به سبد خرید ——————————————————————— #</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">new_price</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">weight</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> 

    <span class="c1"># ———————————————————— کاهش تعداد کالا از سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">decrease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># ——————————————————— حذف یک محصول از سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="n">product_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  

    <span class="c1"># ——————————————— پاکسازی سبد خرید(حذف تمام محصولات) ——————————————— #</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>   

    <span class="c1"># ——————————————————————— محاسبه هزینه پستی ——————————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_post_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">20000</span>
        <span class="k">elif</span> <span class="mi">1000</span> <span class="o">&lt;</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">30000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50000</span>   

    <span class="c1"># ————————————————————— محاسبه هزینه کل محصولات ————————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">total_price</span> 

    <span class="c1"># ——————————————————— محاسبه هزینه نهایی سبد خرید ——————————————————— #</span>
    <span class="k">def</span> <span class="nf">get_final_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">final_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_post_price</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">final_price</span>

    <span class="c1"># ————————————————————— مجموع تعداد کل محصولات —————————————————————— #</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>   

    <span class="c1"># ——————————————————————————— iteration ———————————————————————————— #</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">product_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">product_ids</span><span class="p">)</span>
        <span class="n">cart_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
            <span class="n">cart_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">item</span>                                                       

    <span class="c1"># —————————————————————————————————————————————————————————————————— #</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

<h3 id="khr-b-context-processor">کار با context processor</h3>
<p>در view ها بارها، متغیرها را از طریق context که یک دیکشنری میباشد به تمپلیت ارسال کرده و از آنها استفاده کرده ایم. (به عنوان template variable)</p>
<p>بعضی وقت ها در تمپلیت از یکسری متغیرها استفاده کردیم که از سمت view ارسال نشده اند، مثل request یا csrf_token پس از کجا آمده اند؟! اینها context processor هستند.</p>
<p>context processor در setting پروژه تعریف شده اند و در تمام تمپلیت ها در دسترس میباشند.</p>
<blockquote>
<p>در قسمت TEMPLATES و در بخش OPTIONS، یک کلید(key) بنام context_processors وجود دارد و برای مقدار(value) آن یک لیست شامل یکسری مقادیر قرار دارد که آن مقادیر همان context processor ها میباشند.</p>
</blockquote>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">&#39;templates&#39;</span><span class="p">]</span>
        <span class="p">,</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.auth.context_processors.auth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.messages.context_processors.messages&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>

<p>شاید به یک متغیر نیاز داشته باشیم که در همه تمپلیت ها در دسترس باشد ولی از طریق view ارسال نشود در این زمان ها از context processor استفاده میکنیم.</p>
<blockquote>
<p>اگر به چیزی احتیاج داشته باشیم که فقط در برخی از تمپلیت ها نیاز باشد، میتوان از تمپلیت تگ سفارشی استفاده کرد.</p>
</blockquote>
<p><strong>context processor:</strong> یک تابع(function) هست که request را به عنوان آرگومان میگیرد و یک دیکشنری برمیگرداند(return میکند).</p>
<p><strong>ایجاد context processor:</strong></p>
<blockquote>
<p>میخواهیم برای اطلاعات سبد خرید یک context processor ایجاد کنیم.</p>
</blockquote>
<p>در اپ(app) cart، یک فایل پایتونی بنام context_processors.py ایجاد میکنیم؛ حالا داخل آن یک تابع تعریف کرده که request را به عنوان آرگومان گرفته و یک دیکشنری برمیگرداند.</p>
<p>کلید (key) این دیکشنری همان اسم متغیر هست که در تمپلیت از آن استفاده میکنیم؛ مقدار آن چیزی است که میخواهیم از آن استفاده کنیم.</p>
<blockquote>
<p>در اینجا یک آبجکت از کلاس Cart که request را به عنوان آرگومان میگیرد  را برای مقدار متغیر ست میکنیم.</p>
</blockquote>
<p><code>app directory(cart)/context_processors.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">.cart</span> <span class="kn">import</span> <span class="n">Cart</span>


<span class="k">def</span> <span class="nf">cart_context</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cart&#39;</span><span class="p">:</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>کلاس Cart که در فایل پایتونی cart.py قرار دارد را ایمپورت میکنیم.</p>
<p>برای context processor مدنظر، یک تابع ایجاد میکنیم که request را به عنوان آرگومان میگیرد.</p>
<p>حالا باید یک دیکشنری را return کند؛ به عنوان کلید cart را مشخص میکنیم(از آن در تمپلیت استفاده میکنیم)، و به عنوان value یک آبجکت از کلاس Cart ایجاد کرده و request را برایش مشخص میکنیم.</p>
<blockquote>
<p>request برای آبجکت cart الزامیه؛ چرا؟! چون برای دسترسی به سشن به آن احتیاج داریم.</p>
</blockquote>
<p><strong>معرفی context processor به پروژه:</strong></p>
<p>در settings.py در قسمت TEMPLATES و بخش OPTIONS رفته و context processor شخصی سازی شده را به لیست context_processors اضافه میکنیم.</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">&#39;templates&#39;</span><span class="p">]</span>
        <span class="p">,</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="c1"># ...</span>
                <span class="c1"># structure:</span>
                <span class="s1">&#39;app_name.python_file.function_name&#39;</span>
                <span class="s1">&#39;cart.context_processors.cart_context&#39;</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>

<p><strong>نمایش اطلاعات سبد خرید در header.html:</strong></p>
<p>header در base بارگذاری میشود پس در تمام صفحات قابل مشاهده است.</p>
<p>در تمپلیت header که در اپ shop میباشد این کار را انجام میدهیم.</p>
<p><code>shop app/templates/partials/header.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;div class=&quot;cart-container&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">with</span> <span class="nv">item_count</span><span class="o">=</span><span class="nv">cart</span><span class="o">|</span><span class="nf">length</span> <span class="cp">%}</span>
<span class="x">        &lt;a href=&quot;#&quot; class=&quot;cart-link&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;cart-info-container&quot;&gt;</span>
<span class="x">                &lt;span class=&quot;cart-icon&quot;&gt;🛒&lt;/span&gt;</span>

<span class="x">                &lt;span class=&quot;cart-info&quot;&gt;</span>
<span class="x">                    &lt;span class=&quot;item-count&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item_count</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; item&#39;s, &lt;span class=&quot;total-price&quot;&gt;</span>
<span class="x">                    </span><span class="cp">{{</span> <span class="nv">cart.get_total_price</span> <span class="cp">}}</span><span class="x">T&lt;/span&gt;</span>
<span class="x">                &lt;/span&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">        &lt;/a&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>

<h3 id="fzwdn-ytm-bh-sbd-khryd-b-ajax">افزودن آیتم به سبد خرید با Ajax</h3>
<p>برای اپ cart فایل urls.py را ایجاد میکنیم.(برای ایجاد url های  اپ cart)</p>
<p><code>app directory(cart)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;cart&#39;</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>

<p>حالا باید آنرا به پروژه خود معرفی کنیم، تا url های آن اجرا شوند:</p>
<p><code>project directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;cart/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;cart.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;cart&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>

<blockquote>
<p>حالا هر url که در فایل urls.py اپ cart ایجاد کنیم؛ برای اجرا شدن آن باید قبلش عبارت <span class="en-text">cart/</span> قرار بگیره.</p>
<blockquote>
<p><span class="en-text">cart/URL</span></p>
</blockquote>
</blockquote>
<p><strong>ایجاد url برای دکمه افزودن به سبد خرید:</strong></p>
<p><code>app directory(cart)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;add/&lt;int:product_id&gt;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add_to_cart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add_to_cart&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>ایجاد view برای دکمه افزودن به سبد خرید:</strong></p>
<p>یکسری کتابخانه مورد نیاز مثله (render, get_object_or_404), (require_POST), (JsonResponse) را ایمپورت میکنیم.</p>
<p>مدل Product (از اپ shop) و کلاس Cart (از همین اپ(cart)) را هم ایمپورت میکنیم.</p>
<blockquote>
<p>کلاس Cart در فایل cart.py قرار دارد.</p>
</blockquote>
<p><code>app directory(cart)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>

<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>
<span class="kn">from</span> <span class="nn">.cart</span> <span class="kn">import</span> <span class="n">Cart</span>


<span class="c1"># Create your views here.</span>
<span class="nd">@require_POST</span>
<span class="k">def</span> <span class="nf">add_to_cart</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">product_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;item_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">),</span>
            <span class="s1">&#39;total_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Something went wrong&quot;</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای view از دکوراتور require_POST استفاده میکنیم چون متد ajax باید از نوع POST باشد. / با این دکوراتور آنرا الزام میکنیم.</p>
<p>2- در url متغیر product_id را مشخص کرده ایم پس باید آنرا به عنوان آرگومان تابع در کنار request دریافت کنیم.</p>
<p>3- با استفاده از product_id محصول مربوطه را از دیتابیس دریافت میکنیم و آنرا در یک متغیر ذخیره میکنیم. | یک آبجکت هم از کلاس Cart ایجاد میکنیم.</p>
<p>4- حالا برای آبجکت cart، با استفاده از متد <span class="en-text">add()</span> محصول را به سبد خرید در سشن اضافه میکنیم.</p>
<p>5- تعداد کل محصولات(آیتم های سبد خرید) و هزینه کل سبد خرید را به صورت json به تمپلیت ارسال میکنیم.(در ajax استفاده میشوند.)</p>
<blockquote>
<p>برای کلاس Cart متد __len__ را override کردیم که تعداد محصولات را باهم جمع کند و آن مجموع را return کند برای همین وقتی از تابع <span class="en-text">len()</span> استفاده کنیم تعداد کل محصولات را برمیگرداند.</p>
</blockquote>
<p>برای جلوگیری از استثناهای ممکن این ساختارها را در try, except قرار میدهیم.</p>
<blockquote>
<p>اطلاعات سبد خرید که در header نوشتیم باید (با افزودن کالا به سبد خرید) باید آپدیت شوند؛ با همین مقادیری که در context ارسال میکنیم آنها را آپدیت میکنیم.</p>
</blockquote>
<p><strong>ایجاد دکمه افزودن کالا به سبد خرید و ajax آن، در تمپلیت جزئیات محصول:</strong></p>
<p>در تمپلیت جزئیات محصول در اپ shop، دکمه افزودن کالا به سبد خرید را اضافه کرده و ajax آنرا هم ایجاد میکنیم تا با افزودن کالا اطلاعات سبد خرید آپدیت شوند.</p>
<p><code>app(shop)/templates/shop/product_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="nv">product.name</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">head</span> <span class="cp">%}</span><span class="x">&lt;link rel=&quot;stylesheet&quot; href=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;CSS/product-detail.css&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>


<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;heading-text&quot;&gt;</span>
<span class="x">        &lt;h1&gt;جزئیات محصول&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>


<span class="x">    &lt;div class=&quot;product-detail&quot;&gt;</span>
<span class="x">        &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">product.name</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="x">        &lt;p&gt;دسته بندی: </span><span class="cp">{{</span> <span class="nv">product.category</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;موجودی: </span><span class="cp">{{</span> <span class="nv">product.inventory</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;ul&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">feature</span> <span class="k">in</span> <span class="nv">product.features.all</span> <span class="cp">%}</span>
<span class="x">                &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">feature.name</span> <span class="cp">}}</span><span class="x">: </span><span class="cp">{{</span> <span class="nv">feature.value</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">        &lt;/ul&gt;</span>

<span class="x">        &lt;div class=&quot;price&quot;&gt;</span>
<span class="x">            &lt;span class=&quot;original-price&quot;&gt;قیمت: </span><span class="cp">{{</span> <span class="nv">product.price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">            &lt;br&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">product.offers</span> <span class="cp">%}</span>
<span class="x">                &lt;span class=&quot;discounted-price&quot;&gt;قیمت پس از تخفیف: </span><span class="cp">{{</span> <span class="nv">product.new_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    </span>
<span class="x">    &lt;button id=&quot;add-cart&quot; type=&quot;button&quot;&gt;افزودن به سبد خرید&lt;/button&gt;</span>

<span class="x">    &lt;div class=&quot;product-images&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">image</span> <span class="k">in</span> <span class="nv">product.images.all</span> <span class="cp">%}</span>
<span class="x">            &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">image.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;</span><span class="cp">{{</span> <span class="nv">image.title</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;product-description&quot;&gt;</span>
<span class="x">        &lt;h3&gt;description&lt;/h3&gt;</span>
<span class="x">        &lt;p&gt;</span><span class="cp">{{</span> <span class="nv">product.description</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    </span>
<span class="x">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">    &lt;script&gt;</span>
<span class="x">        $(document).ready(function (){</span>
<span class="x">            $(&#39;#add-cart&#39;).click(function (){</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:add_to_cart&#39;</span> <span class="nv">product.id</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {&#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;},</span>
<span class="x">                    success: function (response){</span>
<span class="x">                        $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                        $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                    },</span>
<span class="x">                })</span>
<span class="x">            })</span>
<span class="x">        })</span>
<span class="x">    &lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- یک دکمه برای افزودن به سبد خرید ایجاد میکنیم و یک id برای آن مشخص میکنیم.</p>
<p>2- حالا برای jquery مشخص میکنیم، که وقتی رو دکمه کلیک شد ajax عمل کند.</p>
<p><strong>type:</strong> نوع متد را POST مشخص میکنیم.</p>
<p><strong>url:</strong> url که برای (دکمه افزودن کالا به سبد خرید) ایجاد کردیم را برایش مشخص میکنیم، همچنین آیدی محصول فعلی.</p>
<p><strong>data:</strong> برای امنیت csrf_token  را برای آن مشخص میکنیم.</p>
<p>برای تابع success؛ تعداد کل کالا ها و قیمت کل سبد خرید که در header هستند را آپدیت میکنیم.</p>
<h3 id="tmplyt-sbd-khryd">تمپلیت سبد خرید</h3>
<p>میخواهیم تمپلیت سبد خرید را جهت نمایش (محصولات سفارش داده شده، تعداد و قیمت هر محصول، مجموع هزینه ها و..) ایجاد کنیم.</p>
<p><strong>ایجاد url برای تمپلیت سبد خرید:</strong></p>
<p><code>app directory(cart)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">cart_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cart_detail&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<blockquote>
<p>در تمپلیت header که اطلاعات سبد خرید را نشان میدهیم یک لینک برای رفتن به صفحه سبد خرید ایجاد کردیم، حالا باید برای href آن این url بالا را مشخص کنیم.</p>
</blockquote>
<p><strong>ایجاد view برای تمپلیت سبد خرید:</strong></p>
<p><code>app directory(cart)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">cart_detail</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;cart/cart_detail.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cart&quot;</span><span class="p">:</span> <span class="n">cart</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>برای نمایش اطلاعات سبد خرید در تمپلیت؛ یک آبجکت از کلاس Cart ایجاد کرده و آنرا به تمپلیت سبد خرید ارسال میکنیم.</p>
<blockquote>
<p>از آبجکت cart برای مدیریت سبد خرید استفاده میکنیم.</p>
</blockquote>
<p><strong>ایجاد templates:</strong></p>
<p>در دایرکتوری اپ cart یک دایرکتوری بنام templates ایجاد میکنیم؛ حالا داخل آن یک دایرکتوری دیگه بنام cart ایجاد کرده و در آن تمپلیت cart_detail.html را میسازیم.</p>
<p><strong>ایجاد تمپلیت سبد خرید:</strong></p>
<p><code>app (cart)/templates/cart/cart_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">Cart</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;header&quot;&gt;</span>
<span class="x">        &lt;h1&gt;سبد خرید&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;cart-content&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">item</span> <span class="k">in</span> <span class="nv">cart</span> <span class="cp">%}</span>
<span class="x">            </span><span class="c">{# item = product-info(dictionary) #}</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">with</span> <span class="nv">product</span><span class="o">=</span><span class="nv">item.product</span> <span class="cp">%}</span>
<span class="x">                &lt;div class=&quot;product-item&quot;&gt;</span>
<span class="x">                    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                        &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">product.images.first.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;</span><span class="cp">{{</span> <span class="nv">product.images.first.image_file</span> <span class="cp">}}</span><span class="x">&quot; width=&quot;225px&quot;&gt;</span>
<span class="x">                    &lt;/a&gt;</span>

<span class="x">                    &lt;div class=&quot;product-info&quot;&gt;</span>
<span class="x">                        &lt;h3&gt;</span>
<span class="x">                            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                                نام محصول: </span><span class="cp">{{</span> <span class="nv">product.name</span> <span class="cp">}}</span>
<span class="x">                            &lt;/a&gt;</span>
<span class="x">                        &lt;/h3&gt;</span>

<span class="x">                        &lt;p&gt;تعداد: &lt;span class=&quot;quantity&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.quantity</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;قیمت: &lt;span class=&quot;price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;مجموع قیمت: &lt;span class=&quot;product-total-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.total</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                    &lt;/div&gt;</span>

<span class="x">                    &lt;div class=&quot;actions&quot;&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-decrease&quot;&gt;-&lt;/button&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-add&quot;&gt;+&lt;/button&gt;</span>
<span class="x">                        &lt;span class=&quot;delete&quot;&gt;🗑️&lt;/span&gt;</span>
<span class="x">                    &lt;/div&gt;</span>
<span class="x">                &lt;/div&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>

<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span>
<span class="x">                &lt;hr&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">        </span><span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">            cart is empty!</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">        &lt;div class=&quot;cart-total-price&quot;&gt;</span>
<span class="x">            &lt;p&gt;قیمت کل محصولات: &lt;span id=&quot;total-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_total_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه پستی: &lt;span class=&quot;post-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_post_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه نهایی: &lt;span class=&quot;final-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_final_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div class=&quot;checkout-button&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;continue-btn&quot;&gt;&lt;a href=&quot;#&quot;&gt;ادامه خرید&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;back-btn&quot;&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;shop:products-list&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;برگشت به لیست محصولات&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- در اینجا هم از همان تمپلیت پایه موجود در اپ shop استفاده میکنیم؛ لازم نیست یک تمپلیت پایه دیگر در این اپ بسازیم.</p>
<p>2- فایل های static را لود کرده، یک عنوان برای این صفحه مشخص میکنم.</p>
<p>3- یک div برای محتوای  سبد خرید ایجاد کرده و در آن روی آبجکت cart که از view ارسال شده حلقه میزنیم.</p>
<blockquote>
<p>روی آبجکت cart میتوانیم حلقه بزنیم، چون برای کلاس Cart متد __iter__ ست کرده ایم.</p>
<p>و در آن مشخص کردیم که در هر iteration(پیمایش روی حلقه)، اطلاعات یک محصول را برگرداند(تعداد محصول، قیمت محصول، وزن، آبجکت آن محصول(product)، مجموع قیمت آن کالا با توجه به تعدادش) / و اینکه این اطلاعات در دیکشنری هستند پس item یک دیکشنری شامل اطلاعات محصول میباشد.</p>
</blockquote>
<p>4- برای id محصول، slug محصول و... به آبجکت product که در item میباشد؛ نیاز داریم ولی برای اینکه هربار آنرا از دیکشنری دریافت نکنیم از تمپلیت تگ with استفاده کرده و آنرا در یک متغیر ذخیره میکنیم، حالا هرجا به آبجکت product نیاز داشتیم از این متغیر استفاده میکنیم.</p>
<blockquote>
<p><strong>نکته مهم:</strong> در تمپلیت برای اینکه به مقدار یک کلید از دیکشنری دسترسی داشته باشیم از (.) بجای [] استفاده میکنیم</p>
</blockquote>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">pyhon</span>
        </div>
    <pre><span></span>item = {&#39;product&#39;: &#39;Laptop&#39;}
</pre></div>

<table>
<thead>
<tr>
<th style="text-align: center;">python</th>
<th style="text-align: center;">template</th>
<th style="text-align: center;">EXPORT</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">item['product']</td>
<td style="text-align: center;">item.product</td>
<td style="text-align: center;">=&gt; laptop</td>
</tr>
</tbody>
</table>
<p>5- در بدنه حلقه for، یک div برای نمایش محصول ثبت شده؛ (مثله نام محصول، تصویر محصول، تعداد و قیمت محصول و...) ایجاد میکنیم.</p>
<ul>
<li>
<p>تصویر محصول را در تگ a قرار داده و آنرا به صفحه جزئیات محصول هدایت میکنیم تا با کلیک روی تصویر به صفحه آن محصول برود. / id و slug محصول را برای url آن مشخص میکنیم.
    &gt; برای نمایش تصویر ، از اولین عکس محصول استفاده میکنیم.</p>
</li>
<li>
<p>برای نام محصول هم این لینک را ایجاد میکنیم.</p>
</li>
<li>
<p>نام محصول، تعداد، قیمت و مجموع قیمت را در یک تگ div قرار میدهیم.</p>
<blockquote>
<p>برای مجموع قیمت هر محصول در فایل cart.py در متد __iter__ یک کلید بنام total  و مقدار مجموع قیمت کالا را برای هر محصول اضافه میکنیم.</p>
</blockquote>
</li>
</ul>
<p><code>app directory(cart)/cart.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">product_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">product_ids</span><span class="p">)</span>
    <span class="n">cart_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">cart_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">item</span>
</pre></div>

<ul>
<li>در یک تگ آیکون های + (افزایش تعداد)، - (کاهش تعداد) و 🗑️ (حذف محصول) را قرار میدهیم.</li>
</ul>
<blockquote>
<p>برای زمانی که سبد خرید خالیست هم متن "cart is empty" را نشان میدهیم.</p>
</blockquote>
<p>6- بیرون از حلقه for، یک تگ ایجاد کرده و هزینه کل سبد خرید، هزینه پستی و مبلغ قابل پرداخت(مجموع هزینه کل و هزینه پستی) را در آن مینویسیم.</p>
<p>7- یک دکمه برای ادامه خرید و یک دکمه برای برگشت به لیست محصولات اضافه میکنیم.</p>
<h3 id="khlyd-fzysh-w-khhsh-sbd-khryd-b-ajax">کلید افزایش و کاهش سبد خرید با Ajax</h3>
<p><strong>ایجاد url برای تغییر تعداد کالا:</strong></p>
<p>برای عملکرد دکمه های افزایش(+) و کاهش(-) تعداد کالا یک url ایجاد میکنیم.</p>
<p><code>app directory(cart)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;update-quantity&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">update_quantity</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;update_quantity&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>بریم سراغ ajax دکمه های افزایش و کاهش محصول:</strong></p>
<p><code>app(cart)/templates/cart/cart_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">products</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;header&quot;&gt;</span>
<span class="x">        &lt;h1&gt;سبد خرید&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;cart-content&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">item</span> <span class="k">in</span> <span class="nv">cart</span> <span class="cp">%}</span>
<span class="x">            </span><span class="c">{# item = product-info(dictionary) #}</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">with</span> <span class="nv">product</span><span class="o">=</span><span class="nv">item.product</span> <span class="cp">%}</span>
<span class="x">                &lt;div class=&quot;product-item&quot; data-item-id=&quot;</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                        &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">product.images.first.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;</span><span class="cp">{{</span> <span class="nv">product.images.first.image_file</span> <span class="cp">}}</span><span class="x">&quot; width=&quot;225px&quot;&gt;</span>
<span class="x">                    &lt;/a&gt;</span>

<span class="x">                    &lt;div class=&quot;product-info&quot;&gt;</span>
<span class="x">                        &lt;h3&gt;</span>
<span class="x">                            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                                نام محصول: </span><span class="cp">{{</span> <span class="nv">product.name</span> <span class="cp">}}</span>
<span class="x">                            &lt;/a&gt;</span>
<span class="x">                        &lt;/h3&gt;</span>

<span class="x">                        &lt;p&gt;تعداد: &lt;span class=&quot;quantity&quot; id=&quot;quantity-</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.quantity</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;قیمت: &lt;span class=&quot;price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;مجموع قیمت: &lt;span class=&quot;product-total-price&quot; id=&quot;product-price-</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.total</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                    &lt;/div&gt;</span>

<span class="x">                    &lt;div class=&quot;actions&quot;&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-decrease&quot;&gt;-&lt;/button&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-add&quot;&gt;+&lt;/button&gt;</span>
<span class="x">                        &lt;span class=&quot;delete&quot;&gt;🗑️&lt;/span&gt;</span>
<span class="x">                    &lt;/div&gt;</span>
<span class="x">                &lt;/div&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span>
<span class="x">                &lt;hr&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">            cart is empty!</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">        &lt;div class=&quot;cart-total-price&quot;&gt;</span>
<span class="x">            &lt;p&gt;قیمت کل محصولات: &lt;span id=&quot;total-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_total_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه پستی: &lt;span class=&quot;post-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_post_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه نهایی: &lt;span class=&quot;final-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_final_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div class=&quot;checkout-button&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;continue-btn&quot;&gt;&lt;a href=&quot;#&quot;&gt;ادامه خرید&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;back-btn&quot;&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;shop:products-list&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;برگشت به لیست محصولات&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">    &lt;script&gt;</span>
<span class="x">        $(document).ready(function (){</span>
<span class="x">            $(&#39;.quantity-add&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;add&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            $(&#39;.quantity-decrease&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;decrease&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            </span><span class="c">{# ——————————————————————————— update-quantity function ——————————————————————————— #}</span>
<span class="x">            function updateQuantity(action, productId) {</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:update_quantity&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {</span>
<span class="x">                        &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;,</span>
<span class="x">                        &#39;action&#39;: action,</span>
<span class="x">                        &#39;product_id&#39;: productId,</span>
<span class="x">                    },</span>

<span class="x">                    success: function (response){</span>
<span class="x">                        if(response.success){</span>
<span class="x">                            </span><span class="c">{# بخش بالایی(header) #}</span>
<span class="x">                            $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                            $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                            </span><span class="c">{# تعداد و مجموع قیمت کالا #}</span>
<span class="x">                            $(&#39;#quantity-&#39; + productId).text(response.quantity);</span>
<span class="x">                            $(&#39;#product-price-&#39; + productId).text(response.product_cost);</span>
<span class="x">                            </span><span class="c">{# قیمت کل محصولات، هزینه پستی و هزینه نهایی محصولات #}</span>
<span class="x">                            $(&#39;#total-price&#39;).text(response.total_price);</span>
<span class="x">                            $(&#39;.post-price&#39;).text(response.post_price);</span>
<span class="x">                            $(&#39;.final-price&#39;).text(response.final_price);</span>

<span class="x">                        }else{</span>
<span class="x">                            alert(&quot;Error update quantity!!!&quot;);</span>
<span class="x">                        }</span>
<span class="x">                    }</span>
<span class="x">                });</span>
<span class="x">            }</span>
<span class="x">        });</span>
<span class="x">    &lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- اسکریپت ajax-jquery را به تمپلیت اضاف میکنیم.</p>
<p><strong>نکته:</strong> محصولات را با حلقه نمایش میدهیم پس با هربار تکرار حلقه یک آیتم(اطلاعات محصول) تکرار میشود، حالا نکته این هست که وقتی روی + و یا - میزنیم باید مشخص شود که مربوط به کدام محصول میباشد بنابراین با کلیک روی هرکدام از این دکمه ها id محصول را نیز از طریق ajax به view ارسال میکنیم.</p>
<blockquote>
<p>برای ارسال داده به ajax از اتریبیوت <strong><span class="en-text">data-*</span></strong> استفاده میکنیم. / آنرا برای div پرنت مشخص میکنیم و آیدی محصول را برایش تعیین میکنیم.</p>
</blockquote>
<p><strong>برای span های تعداد و مجموع قیمت هر محصول، باید id منحصر به فرد مشخص کنیم؛ برای همین از "آیدی آن محصول" در اتریبیوت id استفاده میکنیم.</strong></p>
<p>2- حالا مشخص میکنیم که هروقت روی دکمه + و یا - کلیک شد یک تابع(function) بنام updateQuantity صدا زده شود.</p>
<blockquote>
<p>تابع updateQuantity برای هردو مشترک هست؛ این تابع دو ورودی میگیرد، یکی product_id و دیگری وضعیت آن دکمه(add or decrease)</p>
<p><span class="rtl-text">آیدی محصول را از اتریبیوت <span class="en-text">data-item-id</span> دریافت میکنیم.</span></p>
</blockquote>
<p>3- ساختار ajax را داخل بدنه تابع updateQuantity پیاده سازی میکینم.</p>
<ul>
<li>
<p><strong>type:</strong> POST.</p>
</li>
<li>
<p><strong>url:</strong> url، آپدیت تعداد محصول را برایش مشخص میکنیم.</p>
</li>
<li>
<p><strong>data:</strong> وضعیت دکمه(add, decrease) و آیدی محصول را به view ارسال میکنیم.</p>
</li>
</ul>
<p>4- <strong>success:</strong> با استفاده از مقادیر دریافت شده از view موارد مربوطه را آپدیت میکنیم.(تعداد کل محصولات، قیمت کل محصولات، تعداد هر محصول، مجموع قیمت هر محصول با توجه به تعداد آن، مبلغ قابل پرداخت)</p>
<blockquote>
<p>برای مشخص کردن آیدی محصول، در بخش success؛ از آرگومان productId که برای تابع updateQuantity مشخص کرده ایم استفاده میکنیم.</p>
</blockquote>
<p><strong>ایجاد view برای تغییر تعداد کالا:</strong></p>
<p><code>app directory(cart)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@require_POST</span>
<span class="k">def</span> <span class="nf">update_quantity</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;decrease&quot;</span><span class="p">:</span>
            <span class="n">cart</span><span class="o">.</span><span class="n">decrease</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

        <span class="n">product_cost</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cart</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;item_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">),</span>
            <span class="s1">&#39;total_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">(),</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">cart</span><span class="p">[</span><span class="n">product_id</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;product_cost&#39;</span><span class="p">:</span> <span class="n">product_cost</span><span class="p">,</span>
            <span class="s1">&#39;post_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_post_price</span><span class="p">(),</span>
            <span class="s1">&#39;final_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_final_price</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Something went wrong: product not found!&quot;</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- متد ajax باید POST باشد بنابراین برای الزام کردن view از دکوراتور require_POST استفاده میکنیم.</p>
<p>2- action (وضعیت دکمه) و product_id را از تمپلیت دریافت کرده و در متغیر ذخیره میکینم.</p>
<p>3- با استفاده از آیدی دریافت شده؛ محصول را از دیتابیس دریافت میکنیم.</p>
<p>4- یک آبجکت از کلاس Cart ایجاد کرده و request را برایش مشخص میکنیم.</p>
<p>5- حالا یک شرط مشخص میکنیم، که اگر وضعیت دکمه add هست متد <span class="en-text">add()</span> و چنانچه وضعیت دکمه decrease هست متد <span class="en-text">decrease()</span> را برای آبجکت cart صدا زده و product را برایش مشخص میکنیم.</p>
<p>6- برای متغیر product_cost مجموع قیمت یک کالا را مشخص میکنیم.</p>
<p>7- مواردی را که در تمپلیت آپدیت میشوند را محاسبه کرده و به صورت json به تمپلیت ارسال میکنیم.</p>
<blockquote>
<p>"success", item_count(تعداد کالاهای سبد خرید), total_price(هزینه کل سبد خرید), quantity(تعداد یک محصول), product_cost(مجموع قیمت یک کالا), post_price(هزینه پستی), final_price(مبلغ قابل پرداخت)</p>
</blockquote>
<p>8- با استفاده از <span class="en-text">JsonResponse()</span> مقادیر را به ajax ارسال میکنیم.</p>
<h3 id="khlyd-hdhf-z-sbd-khryd-b-ajax">کلید حذف از سبد خرید با Ajax</h3>
<p><strong>برای دکمه حذف کالا از سبد خرید، یک url و view جدید ایجاد میکنیم.</strong></p>
<p><strong>ایجاد url برای دکمه حذف کالا:</strong></p>
<p><code>app directory(cart)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;delete-product&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">delete_product</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;delete_product&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>ایجاد view برای دکمه حذف کالا:</strong></p>
<p>برای <strong>دکمه حذف</strong> هم آیدی محصول(product_id) را با استفاده از ajax به view ارسال میکنیم.</p>
<p><code>app directory(cart)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">delete_product</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
        <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">cart</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;item_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">),</span>
            <span class="s1">&#39;total_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">(),</span>
            <span class="s1">&#39;post_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_post_price</span><span class="p">(),</span>
            <span class="s1">&#39;final_price&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_final_price</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Something went wrong: product not found!&quot;</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- با استفاده از آیدی دریافت شده؛ محصول را از دیتابیس دریافت میکنیم.</p>
<p>2- یک آبجکت از کلاس Cart ایجاد کرده و request را برایش مشخص میکنیم.</p>
<p>3- متد <span class="en-text">delete()</span> را برای آبجکت cart صدا میزنیم، تا آن محصول را از سشن پاک کند.</p>
<p>4- (تعداد کل محصولات در سبد خرید، مجموع قیمت محصولات، هزینه پستی و مبلغ قابل پرداخت) را به صورت json به ajax ارسال میکنیم تا این موارد را در تمپلیت آپدیت کند. / "success": True را هم برای شرطی که گذاشتیم ارسال میکنیم.</p>
<blockquote>
<p>با استفاده از JsonResponse() مقادیر را به ajax ارسال میکنیم.</p>
</blockquote>
<p><strong>بریم سراغ ajax دکمه حذف محصول:</strong></p>
<p>برای درک راحت ابتدا فقط ساختار ajax را نمایش میدهیم و سپس کل کدهای تمپلیت نشان داده خواهند شد.</p>
<p><code>app(cart)/templates/cart/cart_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;script&gt;</span>
<span class="x">        $(document).ready(function (){</span>
<span class="x">            $(&#39;.quantity-add&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;add&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            $(&#39;.quantity-decrease&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;decrease&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            $(&#39;.delete&#39;).click(function (){</span>
<span class="x">                deleteProduct($(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            </span><span class="c">{# ——————————————————————————— update-quantity function ——————————————————————————— #}</span>
<span class="x">            function updateQuantity(action, productId) {</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:update_quantity&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {</span>
<span class="x">                        &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;,</span>
<span class="x">                        &#39;action&#39;: action,</span>
<span class="x">                        &#39;product_id&#39;: productId,</span>
<span class="x">                    },</span>

<span class="x">                    success: function (response){</span>
<span class="x">                        if(response.success){</span>
<span class="x">                            </span><span class="c">{# بخش بالایی(header) #}</span>
<span class="x">                            $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                            $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                            </span><span class="c">{# تعداد و مجموع قیمت کالا #}</span>
<span class="x">                            $(&#39;#quantity-&#39; + productId).text(response.quantity);</span>
<span class="x">                            $(&#39;#product-price-&#39; + productId).text(response.product_cost);</span>
<span class="x">                            </span><span class="c">{# قیمت کل محصولات، هزینه پستی و هزینه نهایی محصولات #}</span>
<span class="x">                            $(&#39;#total-price&#39;).text(response.total_price);</span>
<span class="x">                            $(&#39;.post-price&#39;).text(response.post_price);</span>
<span class="x">                            $(&#39;.final-price&#39;).text(response.final_price);</span>

<span class="x">                        }else{</span>
<span class="x">                            alert(&quot;Error update quantity!!!&quot;);</span>
<span class="x">                        }</span>
<span class="x">                    }</span>
<span class="x">                });</span>
<span class="x">            }</span>
<span class="x">            </span><span class="c">{# ——————————————————————————— delete-product function ——————————————————————————— #}</span>
<span class="x">            function deleteProduct(productId) {</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:delete_product&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {</span>
<span class="x">                        &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;,</span>
<span class="x">                        &#39;product_id&#39;: productId,</span>
<span class="x">                    },</span>

<span class="x">                    success: function (response){</span>
<span class="x">                        if(response.success){</span>
<span class="x">                            </span><span class="c">{# بخش بالایی(header) #}</span>
<span class="x">                            $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                            $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                            </span><span class="c">{# قیمت کل محصولات، هزینه پستی و هزینه نهایی محصولات #}</span>
<span class="x">                            $(&#39;#total-price&#39;).text(response.total_price);</span>
<span class="x">                            $(&#39;.post-price&#39;).text(response.post_price);</span>
<span class="x">                            $(&#39;.final-price&#39;).text(response.final_price);</span>
<span class="x">                            </span><span class="c">{# حذف کالا از سبد خرید #}</span>
<span class="x">                            $(`.product-item[data-item-id=${ productId }]`).remove();</span>
<span class="x">                        }else{</span>
<span class="x">                            alert(&quot;Error update quantity!!!&quot;);</span>
<span class="x">                        }</span>
<span class="x">                    }</span>
<span class="x">                });</span>
<span class="x">            }</span>

<span class="x">        });</span>
<span class="x">    &lt;/script&gt;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای عملکرد دکمه حذف در script یک تابع ایجاد میکنیم. / این تابع آیدی محصول را به عوان آرگومان دریافت میکنه.</p>
<p>2- ساختار ajax در این تابع پیاده سازی میشود.</p>
<ul>
<li>
<p><strong>type:</strong> متد ajax را از نوع POST مشخص میکنیم.</p>
</li>
<li>
<p><strong>url:</strong> آدرس حذف محصول  را برای آن مشخص میکنیم.</p>
</li>
<li>
<p><strong>data:</strong> آیدی محصول(product_id) و csrf_token را به view ارسال میکنیم.</p>
</li>
</ul>
<p>3- برای تابع success: (تعداد کل محصولات، مجموع قیمت کالا ها، هزینه پستی و مبلغ قابل پرداخت) را از view دریافت کرده و  پس از حذف محصول آنها را آپدیت میکنیم.</p>
<p><strong>نکته:</strong> هر محصول و اطلاعات آن در div با کلاس <strong>product-item</strong> قرار دارد؛ پس باید آن div  حذف شود. / چندین div با آن کلاس وجود دارد ولی باید آن div که مقدار اتریبیوت <strong>data-item-id</strong> اش، برابر با آرگومان مشخص شده در تابع هست پاک شود.</p>
<blockquote>
<p><span class="rtl-text">با متد <span class="en-text">remove()</span> در جاوااسکریپت (ajax) آن div را حذف میکنیم.</span></p>
</blockquote>
<p><strong>تمپلیت سبد خرید در یک نگاه:</strong></p>
<p><code>app(cart)/templates/cart/cart_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">products</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;header&quot;&gt;</span>
<span class="x">        &lt;h1&gt;سبد خرید&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;cart-content&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">item</span> <span class="k">in</span> <span class="nv">cart</span> <span class="cp">%}</span>
<span class="x">            </span><span class="c">{# item = product-info(dictionary) #}</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">with</span> <span class="nv">product</span><span class="o">=</span><span class="nv">item.product</span> <span class="cp">%}</span>
<span class="x">                &lt;div class=&quot;product-item&quot; data-item-id=&quot;</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                        &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">product.images.first.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;</span>
<span class="x">                            </span><span class="cp">{{</span> <span class="nv">product.images.first.image_file</span> <span class="cp">}}</span><span class="x">&quot; width=&quot;225px&quot;&gt;</span>
<span class="x">                    &lt;/a&gt;</span>

<span class="x">                    &lt;div class=&quot;product-info&quot;&gt;</span>
<span class="x">                        &lt;h3&gt;</span>
<span class="x">                            &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:product_detail&#39;</span> <span class="nv">product.id</span> <span class="nv">product.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
<span class="x">                                نام محصول: </span><span class="cp">{{</span> <span class="nv">product.name</span> <span class="cp">}}</span>
<span class="x">                            &lt;/a&gt;</span>
<span class="x">                        &lt;/h3&gt;</span>

<span class="x">                        &lt;p&gt;تعداد: &lt;span class=&quot;quantity&quot; id=&quot;quantity-</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.quantity</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;قیمت: &lt;span class=&quot;price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">item.price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                        &lt;p&gt;مجموع قیمت: &lt;span class=&quot;product-total-price&quot; id=&quot;product-price-</span><span class="cp">{{</span> <span class="nv">product.id</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">                            </span><span class="cp">{{</span> <span class="nv">item.total</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;&lt;/p&gt;</span>
<span class="x">                    &lt;/div&gt;</span>

<span class="x">                    &lt;div class=&quot;actions&quot;&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-decrease&quot;&gt;-&lt;/button&gt;</span>
<span class="x">                        &lt;button class=&quot;quantity-add&quot;&gt;+&lt;/button&gt;</span>
<span class="x">                        &lt;span class=&quot;delete&quot;&gt;🗑️&lt;/span&gt;</span>
<span class="x">                    &lt;/div&gt;</span>
<span class="x">                &lt;/div&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nb">forloop</span><span class="nv">.last</span> <span class="cp">%}</span>
<span class="x">                &lt;hr&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">empty</span> <span class="cp">%}</span>
<span class="x">            cart is empty!</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>

<span class="x">        &lt;div class=&quot;cart-total-price&quot;&gt;</span>
<span class="x">            &lt;p&gt;قیمت کل محصولات: &lt;span id=&quot;total-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_total_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه پستی: &lt;span class=&quot;post-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_post_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;هزینه نهایی: &lt;span class=&quot;final-price&quot;&gt;</span><span class="cp">{{</span> <span class="nv">cart.get_final_price</span> <span class="cp">}}</span><span class="x">&lt;/span&gt; تومان&lt;/p&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div class=&quot;checkout-button&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;continue-btn&quot;&gt;&lt;a href=&quot;#&quot;&gt;ادامه خرید&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;back-btn&quot;&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;shop:products-list&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;برگشت به لیست محصولات&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">    &lt;script&gt;</span>
<span class="x">        $(document).ready(function (){</span>
<span class="x">            $(&#39;.quantity-add&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;add&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            $(&#39;.quantity-decrease&#39;).click(function (){</span>
<span class="x">                updateQuantity(&#39;decrease&#39;, $(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            $(&#39;.delete&#39;).click(function (){</span>
<span class="x">                deleteProduct($(this).closest(&#39;.product-item&#39;).data(&#39;item-id&#39;));</span>
<span class="x">            });</span>

<span class="x">            </span><span class="c">{# ——————————————————————————— update-quantity function ——————————————————————————— #}</span>
<span class="x">            function updateQuantity(action, productId) {</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:update_quantity&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {</span>
<span class="x">                        &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;,</span>
<span class="x">                        &#39;action&#39;: action,</span>
<span class="x">                        &#39;product_id&#39;: productId,</span>
<span class="x">                    },</span>

<span class="x">                    success: function (response){</span>
<span class="x">                        if(response.success){</span>
<span class="x">                            </span><span class="c">{# بخش بالایی(header) #}</span>
<span class="x">                            $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                            $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                            </span><span class="c">{# تعداد و مجموع قیمت کالا #}</span>
<span class="x">                            $(&#39;#quantity-&#39; + productId).text(response.quantity);</span>
<span class="x">                            $(&#39;#product-price-&#39; + productId).text(response.product_cost);</span>
<span class="x">                            </span><span class="c">{# قیمت کل محصولات، هزینه پستی و هزینه نهایی محصولات #}</span>
<span class="x">                            $(&#39;#total-price&#39;).text(response.total_price);</span>
<span class="x">                            $(&#39;.post-price&#39;).text(response.post_price);</span>
<span class="x">                            $(&#39;.final-price&#39;).text(response.final_price);</span>

<span class="x">                        }else{</span>
<span class="x">                            alert(&quot;Error update quantity!!!&quot;);</span>
<span class="x">                        }</span>
<span class="x">                    }</span>
<span class="x">                });</span>
<span class="x">            }</span>
<span class="x">            </span><span class="c">{# ——————————————————————————— delete-product function ——————————————————————————— #}</span>
<span class="x">            function deleteProduct(productId) {</span>
<span class="x">                $.ajax({</span>
<span class="x">                    type: &#39;POST&#39;,</span>
<span class="x">                    url: &#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;cart:delete_product&#39;</span> <span class="cp">%}</span><span class="x">&#39;,</span>
<span class="x">                    data: {</span>
<span class="x">                        &#39;csrfmiddlewaretoken&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span> <span class="cp">}}</span><span class="x">&#39;,</span>
<span class="x">                        &#39;product_id&#39;: productId,</span>
<span class="x">                    },</span>

<span class="x">                    success: function (response){</span>
<span class="x">                        if(response.success){</span>
<span class="x">                            </span><span class="c">{# بخش بالایی(header) #}</span>
<span class="x">                            $(&#39;.item-count&#39;).text(response.item_count);</span>
<span class="x">                            $(&#39;.total-price&#39;).text(response.total_price);</span>
<span class="x">                            </span><span class="c">{# قیمت کل محصولات، هزینه پستی و هزینه نهایی محصولات #}</span>
<span class="x">                            $(&#39;#total-price&#39;).text(response.total_price);</span>
<span class="x">                            $(&#39;.post-price&#39;).text(response.post_price);</span>
<span class="x">                            $(&#39;.final-price&#39;).text(response.final_price);</span>
<span class="x">                            </span><span class="c">{# حذف کالا از سبد خرید #}</span>
<span class="x">                            $(`.product-item[data-item-id=${ productId }]`).remove();</span>
<span class="x">                        }else{</span>
<span class="x">                            alert(&quot;Error update quantity!!!&quot;);</span>
<span class="x">                        }</span>
<span class="x">                    }</span>
<span class="x">                });</span>
<span class="x">            }</span>

<span class="x">        });</span>
<span class="x">    &lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<h3 id="dfh-khrdn-p-w-mdl-hy-sfrsh-order">اضافه کردن اپ و مدل های سفارش (Order)</h3>
<p>ایجاد اپ و مدل های سفارش برای عملیات ثبت سفارش کاربر در فروشگاه اینترنتی.</p>
<p><strong>نکته:</strong> سفارش؛ url و مدل های متفاوتی نیاز دارد و ممکن است در آینده بخواهیم آنرا توسعه دهیم، بنابراین برای مدیریت بهتر اینها یک اپ(app) برای سفارش ایجاد میکنیم. / پس از ایجاد اپ آنرا به پروژه معرفی میکنیم.</p>
<p><code>terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>python manage.py startapp orders
</pre></div>

<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s2">&quot;orders.apps.OrdersConfig&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

<blockquote>
<p>AppNameConfig(OrdersConfig)؛ اسم کلاسی است که در فایل apps.py واقع در دایرکتوری اپ(app) وجود دارد. به صورت پیشفرض ایجاد میشود.</p>
</blockquote>
<p><strong>ایجاد مدل order(سفارش):</strong></p>
<p>برای ثبت یک سفارش؛ اطلاعات مربوط به خریدار مثل: نام خریدار(گیرنده سفارش)،  آدرس، شماره تلفن خریدار، کد پستی، شهر و استان، وضعیت پرداخت و تاریخ ثبت سفارش باید مشخص باشد؛ بنابراین آنها را در مدل Order مشخص میکنیم.</p>
<p><code>app directory(orders)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Product</span>


<span class="c1"># Create your models here.</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">buyer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ShopUser</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;orders_buyer&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># ------------------------------------------</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">phone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="n">postal_code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">province</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">paid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_total_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get_cost</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_post_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get_weight</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">20000</span>
        <span class="k">elif</span> <span class="mi">1000</span> <span class="o">&lt;</span> <span class="n">total_weight</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">30000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50000</span>

    <span class="k">def</span> <span class="nf">get_final_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">final_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_cost</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_post_cost</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">final_price</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<blockquote>
<p>در فیلد buyer که خریدار میباشد، برای آرگومان <strong>on_delete</strong> مقدار SET_NULL را مشخص میکنیم تا چنانچه کاربر پاک شد اطلاعات خرید آن پاک نشود.</p>
</blockquote>
<p>برای این مدل چند متد تعریف میکنیم؛ یکی برای نمایش مجموع قیمت محصولات، یکی برای هزینه پستی و دیگری برای مشخص کردن مبلغ قابل پرداخت سبد خرید.</p>
<blockquote>
<p>هر سفارش شامل یک یا چند محصول (آیتم های سفارش داده شده) میباشد.</p>
<p>بنابراین یک مدل دیگر برای آیتم های سفارشی ایجاد میکنیم؛ که هر آیتم شامل قیمت، وزن و تعداد آن محصول میباشد، همچنین متدهایی که (وزن نهایی و مجموع قیمت کالا) را برحسب تعداد آن محاسبه میکند.</p>
</blockquote>
<p>حالا برای محاسبه مجموع قیمت سفارش؛ روی آیتم های آن حلقه میزنیم و برای هر آیتم مجموع قیمت آنرا بدست آورده(با متد <span class="en-text">get_cost()</span> که مربوط به مدل آیتم های سفارش میباشد.) و آنها را در تابع <span class="en-text">sum()</span> جمع میکنیم.</p>
<p><strong>ایجاد مدل آیتم های سفارش:</strong></p>
<p><code>app directory(orders)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">OrderItem</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;items&#39;</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;order_items&#39;</span><span class="p">)</span>
    <span class="c1"># ———————————————— product info ————————————————</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">quantity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>

    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- باید مشخص شود که این آیتم ها مربوط به کدام سفارش هستند؛ بنابراین یک فیلد بنام order ایجاد کرده و آنرا به مدل Order متصل میکنیم.</p>
<p>2- با فیلد product به مدل Product وصل میکنیم، تا به اطلاعات آن محصول دسترسی داشته باشیم.</p>
<p>3- فیلدهایی برای وزن، قیمت و تعداد آن محصول ایجاد میکنیم.</p>
<p>4- متد <span class="en-text">get_cost()</span> مجموع قیمت آن کالا را با توجه به تعدادش محاسبه میکند.</p>
<p>5- متد <span class="en-text">get_weight()</span> وزن کل آن کالا را با توجه به تعدادش محاسبه میکند.</p>
<blockquote>
<p>پس از تغییرات در مدل باید دستورات makemigrations و migrate را اجرا کنیم.</p>
</blockquote>
<h3 id="nmysh-mdl-sfrsh-dr-pnl-dmyn">نمایش مدل سفارش در پنل ادمین</h3>
<p>در فایل admin.py مدل ها و همچنین admin را باید ایمپورت کنیم.</p>
<p>آیتم های سفارش (order_item)، را به صورت inline در مدل ادمین Order نمایش میدهیم.</p>
<p><code>app directory(orders)/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">OrdersItemInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">OrderItem</span>
    <span class="n">raw_id_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">]</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1"># Register your models here.</span>
<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Order</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OrderAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;buyer&#39;</span><span class="p">,</span> <span class="s1">&#39;firstname&#39;</span><span class="p">,</span> <span class="s1">&#39;lastname&#39;</span><span class="p">,</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;province&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;paid&#39;</span><span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;paid&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>

    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrdersItemInline</span><span class="p">]</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای نمایش آیتم های سفارش در مدل ادمین Order؛ لازم است یک کلاس ایجاد کنیم که از StackedInline و یا TabularInline ارث بری میکند. خب حالا مشخص میکنیم که از چه مدلی آنرا ایجاد کند.</p>
<blockquote>
<p>با raw_id_fields مشخص میکنیم که برای انتخاب محصول بجای باز شدن یک منو، محصولات را در یک صفحه دیگر نمایش بدهد تا انتخاب کردن راحت تر باشد.</p>
</blockquote>
<p>2- مدل ادمین Order را ایجاد میکنیم. / برای آن list_display و list_filter مشخص میکنیم و با استفاده از inlines آیتم های سفارش را مشخص میکنیم.</p>
<blockquote>
<p>در اینجا آیدی بسیار مهم است چن یجورایی شماره سفارش حساب میشود.</p>
</blockquote>
<h3 id="yjd-khrbr-sfrshy-abstractbaseuser">ایجاد کاربر سفارشی (AbstractBaseUser)</h3>
<p>یک اپ برای account ایجاد میکنیم؛ چون در فروشگاه خریدار و فروشنده داریم و حتی برخی مواقع چندین فروشنده داریم برای مدیریت بهتر این حساب ها یک اپ مجزا ایجاد میکنیم.</p>
<p>پس از ایجاد اپ آنرا به پروژه معرفی میکنیم.</p>
<p><strong><em>ایجاد مدل User شخصی سازی شده:</em></strong></p>
<p><strong>نکته:</strong> تفاوت این user با سایر user ها در این است که اینجا دیگر username نداریم و از شماره تلفن بجای آن استفاده میکنیم.(چون در فروشگاه ها معولا با شماره تلفن و یا ایمیل وارد میشوند)</p>
<p>&gt;&gt;&gt; برای ایجاد کاربر سفارشی مواردی را باید ایمپورت کنیم.</p>
<p><code>app directory(account)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">BaseUserManager</span><span class="p">,</span> <span class="n">PermissionsMixin</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- <strong>AbstractBaseUser:</strong> کلاس پایه ای هست که برای ساختن یک user شخصی سازی شده استفاده میشود. / در این حالت فقط چند فیلد اصلی مثل password ، date_joined و چند فیلد دیگر وجود دارد</p>
<p>2- <strong>BaseUserManager:</strong> یک کلاس مدیریت کاربر، در جنگو میباشد(کلاس پایه برای ایجاد و مدیریت کاربر هست؛ یکسری متد برای ایجاد کاربر دارد.)</p>
<p>3- <strong>PermissionsMixin:</strong> یک کلاس Mixin میباشد؛ یکسری متد و ویژگی هایی مربوط به دسترسی و مجوز ها را ارائه میدهد.</p>
<p><strong>ایجاد Manager برای کاربر سفارشی:</strong></p>
<p>باید دو متد برایش مشخص کنیم، 1- create_user: برای ساخت کاربر عادی استفاده میشود و 2- create_superuser: که برای ایجاد کاربر مدیر استفاده میشود.</p>
<p><code>app directory(account)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">BaseUserManager</span><span class="p">,</span> <span class="n">PermissionsMixin</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>


<span class="c1"># Create your models here.</span>
<span class="k">class</span> <span class="nc">ShopUserManager</span><span class="p">(</span><span class="n">BaseUserManager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Users must have phone number&#39;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">):</span>
        <span class="n">extra_fields</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">extra_fields</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extra_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_staff&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Superuser must have is_staff=True.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_superuser&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Superuser must have is_superuser=True.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<h4>متد <span class="en-text">create_user()</span>:</h4>
<p>1- phone را به صورت اجباری دریافت میکنیم، چون بجای username استفاده میشود؛ password و extra_fields را هم دریافت میکنیم.</p>
<blockquote>
<p>**extra_fields یک دیکشنری میباشد و فیلدهای اضافه را در صورت وجود دریافت میکند. / باعث میشود اگر مقادیر اضافی وجود داشت مشکلی نداشته باشد خطا ندهد.</p>
</blockquote>
<p>2- phone حتما، باید وجود داشته باشد بنابراین یک شرط مینویسیم که اگر شماره تلفن وجود نداشت یک خطایی را نمایش دهد.</p>
<p>3- برای ایجاد user از دستور <span class="en-text">self.model(phone=phone, **extra_fields)</span> استفاده میکنیم.</p>
<blockquote>
<p>self: یک آبجکت از این کلاس میباشد.</p>
<p>model: مدلی هست که این manager برای آن استفاده میشود. / کاربر سفارشی از این manager استفاده میکند.</p>
<p>phone و  **extra_fields هم برای اطلاعات فیلدهای کاربر استفاده میشوند.</p>
</blockquote>
<p>4- با متد <span class="en-text">set_password()</span>؛ password را برای کاربر  به صورت hash شده، ست میکنیم.</p>
<p>5- با متد <span class="en-text">save()</span> تغییرات را ذخیره میکنیم.</p>
<blockquote>
<p>اینجا یک نکته ای هست، باید برای save مشخص کنیم که اینها در کدام دیتابیس ذخیره شوند(چون ممکن است از چند دیتابیس در پروژه استفاده کنیم.)</p>
<p><strong>using=self._db:</strong> این نشان دهنده این است که از همان دیتابیس فعال پروژه که در setting تعریف کردیم استفاده کن.</p>
</blockquote>
<p>6- در پایان user باید return شود.</p>
<h4>متد <span class="en-text">create_superuser()</span>:</h4>
<p>1- پارامترهای آن مشابه با پارامترهای متد create_user میباشد.</p>
<p><strong>نکته:</strong> متد setdefault، برای دیکشنری استفاده میشود؛ این متد به عنوان آرگومان اول اسم یک کلید را دریافت میکند =&gt; حالا اگر آن کلید وجود داشته باشد مقدار آنرا برمیگرداند و چنانچه آن کلید وجود نداشته باشد، مقداری که به عنوان آرگومان دوم مشخص میکنیم را برای آن کلید ست میکند.</p>
<blockquote>
<p>برای متد create_superuser باید از یکسری موارد اطمینان پیدا کنیم که وجود دارند.</p>
<p>برای superuser(کاربر ویژه)، "is_staff" و "is_superuser" الزامی میباشد؛ باید در دیکشنری extra_fields وجود داشته باشد، اگر وجود ندارد باید خودمون برایش ست کنیم.(با متد setdefault برایش ست میکنیم.)</p>
</blockquote>
<p>2- برای extra_fields از متد setdefault استفاده میکنیم تا مطمئن شویم که برای is_superuser و is_staff مقدار True ست شده باشد.</p>
<blockquote>
<p><strong>is_staff:</strong> اجازه میدهد که کاربر به admin site دسترسی داشته باشد.</p>
<p><strong>is_superuser:</strong> تمام دسترسی و مجوزها را به آن کاربر میدهد.</p>
</blockquote>
<p>3- اگر is_superuser و is_staff مشخص نشده باشند با متد setdefault آنها را ست میکنیم ولی اگر تعریف شده باشند باید چک کنیم، چه چیزی برای آن ها ست شده است. / بنابراین شرط میگذاریم که اگر مقادیر آنها True نمیباشد، خطا نشان بده.</p>
<p>4- حالا اگر این مراحل را پشت سر گذاشت؛ میتوانیم superuser را ایجا کنیم؛ برای ایجاد "کاربر ویژه" از متد create_user اسفاده میکنیم و آنرا return میکنیم.</p>
<p><strong><em>ایجاد custom user(کاربر سفارشی):</em></strong></p>
<p>برای کاربر سفارشی یک کلاس ایجاد میکنیم که از دو کلاس پایه AbstractBaseUser و PermissionsMixin ارث بری میکند.</p>
<p><code>app directory(account)/models.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">ShopUser</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">PermissionsMixin</span><span class="p">):</span>
    <span class="n">phone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_staff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">date_joined</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">ShopUserManager</span><span class="p">()</span>

    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s1">&#39;phone&#39;</span>
    <span class="n">REQUIRED_FIELDS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای آن فیلد phone را مشخص میکنیم که بجای username استفاده میشود.</p>
<blockquote>
<p>چون از phone بجای username استفاده میکنیم، آن باید منحصر به فرد باشد(تکراری نباشد)؛ پس برای آن از آرگومان unique=True استفاده میکنیم.</p>
</blockquote>
<p>2- فیلدهای دیگری مثل first_name، last_name و address را نیز برای ان تعریف میکنیم.</p>
<p>3- فیلد is_active را با مقدار پیشفرض True(چون کاربر جدید فعال هست) و فیلد is_staff را با مقدار پیشفرض False(چون همه کاربرها نباید به admin site دسترسی داشته باشند.) ایجاد میکنیم.</p>
<p>4- یک فیلد برای تاریخ پیوستن کاربر(ثبت نام کاربر در سایت) ایجاد میکنیم.(date_joined)</p>
<p>5- کلاس manager که ایجاد کردیم را برایش مشخص میکنیم.</p>
<p>6- دو مقدار دیگر را نیز باید تعریف کنیم،</p>
<p>1) <strong>USERNAME_FIELD:</strong> برایش مشخص میکنیم که کدام فیلد قرار است به عنوان username استفاده شود.</p>
<p>2) <strong>REQUIRED_FIELDS:</strong> یک لیست میباشد، که مشخص میکنیم موقع ایجاد superuser کدام فیلدها اجباری باشند  توسط کاربر باید مشخص شوند.</p>
<div class="codehilite"><pre><span></span><code>&gt; فیلدهای username(phone) و password به صورت پیشفرض، الزامی هستند حالا اگر موارد دیگری را بخواهیم که الزامی باشند آنها را در این لیست اضافه میکنیم.
</code></pre></div>

<p><strong>خب حالا باید این کاربر سفارشی در تنظیمات به پروژه معرفی شود:</strong></p>
<ul>
<li>یک متغیر بنام AUTH_USER_MODEL ایجاد کرده و مدل کاربر سفارشی را به صورت <span class="en-text">'app_name.Model_name'</span> برایش مشخص میکنیم.</li>
</ul>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">AUTH_USER_MODEL</span> <span class="o">=</span> <span class="s1">&#39;account.ShopUser&#39;</span>
</pre></div>

<p><strong>نکته:</strong> دستورات makemigrations و migrate را اجرا میکنیم.</p>
<p>اگر از همان ابتدای پروژه، مشخص نکنیم که از چه نوع user استفاده میکنیم، (یعنی قبل از ایجاد کاربر سفارشی  AbstractBaseUser از user دیگری استفاده کرده باشیم)؛ زمان اجرای دستور migrate به خطا میخوریم.</p>
<p><strong>برای رفع خطا</strong>، در فایل urls.py پروژه و بخش INSTALLED_APPS در تنظیمات پروژه، "اطلاعات admin را کامنت میکنیم"؛ حالا دستور migrate را اجرا میکنیم، سپس آنها را از کامنت خارج کرده و یکبار دیگه دستورات makemigrations و migrate را اجرا میکنیم.</p>
<p><strong>ایجاد SuperUser:</strong></p>
<p><code>terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>python manage.py createsuperuser
</pre></div>

<h3 id="shkhsy-szy-frm-dmyn-bry-khrbr-sfrshy">شخصی سازی فرم ادمین برای کاربر سفارشی</h3>
<p>چون مدل User را از AbstractBaseUser ایجاد کرده ایم، باید فرم های ایجاد و ویرایش کاربر را هم شخصی سازی کنیم؛ پس در دایرکتوری اپ account فایل forms.py را برای مدیریت فرم ها ایجاد میکنیم.</p>
<ul>
<li>برای شخصی سازی فرم ها UserCreationForm و UserChangeForm را ایمپورت میکنیم. / مدل کاربر سفارشی (ShopUser) را هم ایمپورت میکنیم.</li>
</ul>
<p><code>app directory(account)/forms.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">UserCreationForm</span><span class="p">,</span> <span class="n">UserChangeForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">ShopUser</span>


<span class="k">class</span> <span class="nc">ShopUserCreationForm</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ShopUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShopUserChangeForm</span><span class="p">(</span><span class="n">UserChangeForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">UserChangeForm</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ShopUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- دو کلاس ایجاد میکنیم که از UserCreationForm و UserChangeForm ارث بری میکنند.</p>
<blockquote>
<p>یکی از فرم ها مربوط به ایجاد کاربر میباشد(UserCreationForm) و دیگری برای ویرایش اطلاعات یک کاربر میباشد.(UserChangeForm)</p>
</blockquote>
<p>2- ساختار هر دو فرم یکسان میباشد؛ در بدنه آنها(فرم ها) یک کلاس Meta ایجاد میکنیم که از Meta کلاسی که ارث بری کرده ایم، ارث بری میکند.</p>
<p>3- داخل بدنه کلاس Meta، مدل کاربر سفارشی و فیلدهایی که میخواهیم در فرم باشند را مشخص میکنیم.</p>
<p><strong>نمایش مدل ShopUser در پنل ادمین:</strong></p>
<ul>
<li>مدل کاربر سفارشی(ShopUser)، UserAdmin و فرم های ایجاد شده را ایمپورت میکنیم.</li>
</ul>
<p><code>app directory(account)/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.admin</span> <span class="kn">import</span> <span class="n">UserAdmin</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">ShopUserCreationForm</span><span class="p">,</span> <span class="n">ShopUserChangeForm</span>


<span class="c1"># Register your models here.</span>
<span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ShopUser</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ShopUserAdmin</span><span class="p">(</span><span class="n">UserAdmin</span><span class="p">):</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>

    <span class="n">add_form</span> <span class="o">=</span> <span class="n">ShopUserCreationForm</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ShopUserChangeForm</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ShopUser</span>

    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">]</span>

    <span class="n">fieldsets</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Personal Info&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Permissions&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="s1">&#39;user_permissions&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Important Dates&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;last_login&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">)}),</span>
    <span class="p">)</span>

    <span class="n">add_fieldsets</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;password1&#39;</span><span class="p">,</span> <span class="s1">&#39;password2&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Personal Info&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Permissions&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="s1">&#39;user_permissions&#39;</span><span class="p">)}),</span>
        <span class="p">(</span><span class="s1">&#39;Important Dates&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;last_login&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">)}),</span>
    <span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- <strong>اتریبیوت کلاس add_form:</strong> برای فرم ایجاد کاربر استفاده میشود.</p>
<ul>
<li>
<p><strong>اتریبیوت کلاس form:</strong> برای فرم ویرایش کاربر استفاده میشود.</p>
</li>
<li>
<p>برای اتریبیوت کلاس model هم مدل کاربر سفارشی را مشخص میکنیم.</p>
</li>
</ul>
<blockquote>
<p>به این ترتیب فرم های ایجاد شده را به مدل ادمین معرفی میکنیم.</p>
</blockquote>
<p>2- با list_display مشخص میکنیم که چه فیلدهایی نمایش داده شود.</p>
<p>3- حالا فیلدست ها را با دسته بندی های مجزا ایجاد میکنیم.</p>
<blockquote>
<p><strong>fieldsets:</strong> برای بخش ویرایش اطلاعات در مدل ادمین هست.</p>
<p><strong>add_fieldsets:</strong> برای بخش ایجاد یک کاربر جدید(اضافه کردن کاربر جدید) در مدل ادمین میباشد.</p>
<p>برای add_fieldsets دو تا پسورد (password1 و password2) باید نوشته شود؛ چون رمز باید تایید شود.</p>
</blockquote>
<p><strong><em>نکته:</em></strong> برای نمایش فیلدهای فرم "اطلاعات کاربر"، در پنل ادمین از add_fieldsets و fieldsets استفاده میکنیم.</p>
<h3 id="tbr-snjy-khrbr-sfrshy">اعتبار سنجی کاربر سفارشی</h3>
<p>در فایل forms.py برای هر دو فرم ("ایجاد" و "ویرایش" کاربر) یعنی (ShopUserCreationForm و ShopUserChangeForm) اعتبارسنجی های لازم را انجام میدهیم.</p>
<p><strong>نکته:</strong> هردو فرم از ساختار یکسانی برخوردارند؛ بنابراین اعتبارسنجی ها برای هردو انجام میدهیم.</p>
<p><code>app directory(account)/forms.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">UserCreationForm</span><span class="p">,</span> <span class="n">UserChangeForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">ShopUser</span>


<span class="k">class</span> <span class="nc">ShopUserCreationForm</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ShopUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">)</span>

        <span class="c1"># ——————————————————— conditions ———————————————————</span>
        <span class="k">if</span> <span class="n">ShopUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;This phone number is already taken&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number is invalid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;09&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must start with &#39;09&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must have 11 digits&quot;</span><span class="p">)</span>
        <span class="c1"># ——————————————————————————————————————————————————</span>
        <span class="k">return</span> <span class="n">phone</span>


<span class="k">class</span> <span class="nc">ShopUserChangeForm</span><span class="p">(</span><span class="n">UserChangeForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">UserChangeForm</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ShopUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span> <span class="s1">&#39;date_joined&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">)</span>

        <span class="c1"># ——————————————————— conditions ———————————————————</span>
        <span class="k">if</span> <span class="n">ShopUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;This phone number is already taken&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must be digit&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;09&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must start with &#39;09&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must have 11 digits&quot;</span><span class="p">)</span>
        <span class="c1"># ——————————————————————————————————————————————————</span>
        <span class="k">return</span> <span class="n">phone</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>برای این دو فرم فیلد شماره تلفن را اعتبارسنجی کرده ایم؛ در این اعتبارسنجی:</p>
<p>1- بررسی میشود که شماره تلفن از قبل وجود دارد یا نه؟!</p>
<p>2- بررسی میشود که شماره تلفن فقط عددی باشد.</p>
<p>3- شماره تلفن باید با 09 شروع شود.</p>
<p>4- تعداد ارقام شماره تلفن باید 11 تایی باشد.</p>
<p><strong>نکته:</strong> در فرم ویرایش کاربر(ShopUserChangeForm) شماره تلفن کاربر در دیتابیس وجود دارد، بنابراین وقتی کاربر بدون تغییر شماره تلفن save را بزند به کاربر خطا میدهد که شماره تلفن از قبل وجود دارد(شماره تلفن خود کاربر)؛ برای جلوگیری از این خطا، از متد <span class="en-text">exclude()</span> استفاده کرده و کاربر فعلی را از لیست کاربرانی که بررسی میشوند حذف میکنیم.</p>
<h3 id="tmrynt-fsl-dhm-mhm">تمرینات فصل دهم (مهم)</h3>
            <a href="https://github.com/mahd25/Django-E-booklet/edit/seasons-source/Django-E-booklet-seasons-source/season-10.md" target="_blank" class="edit-icon">
                <i class="fa-solid fa-pen-to-square"></i>
            </a>
        </div>
    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://mahd25.github.io/assets/JS/Django-seasons.js"></script>
<script src="https://mahd25.github.io/assets/JS/copy-icon.js"></script>
<script src="https://mahd25.github.io/assets/JS/Footer-Copyright.js"></script>
</body>
</html>
